    <pre>
<span class="comment-delimiter">(***************************************************************)</span>
<span class="comment-delimiter">(*                        </span><span class="comment">Reactive Asco                        </span><span class="comment-delimiter">*)</span>
<span class="comment-delimiter">(*                                                             *)</span>
<span class="comment-delimiter">(*                                                             *)</span>
<span class="comment-delimiter">(* </span><span class="comment">This is the interpreter core.                               </span><span class="comment-delimiter">*)</span>
<span class="comment-delimiter">(* </span><span class="comment">It contains the execution process, handle synchronization   </span><span class="comment-delimiter">*)</span>
<span class="comment-delimiter">(* </span><span class="comment">and performance errors                                      </span><span class="comment-delimiter">*)</span>
<span class="comment-delimiter">(***************************************************************)</span>


<span class="variable-name">open</span> <span class="function-name">Types</span>
<span class="variable-name">open</span> <span class="function-name">Reactive_map</span>
<span class="variable-name">open</span> <span class="function-name">Utils</span>

<span class="comment-delimiter">(* </span><span class="comment">Create a process player that takes as argument an electronic score
   'score' and executes it. The player depends on the instrumental
   score 'instr_score', it follows the position in the instrumental
   score using the process wait_event, and the tempo with the process
   'wait'.
</span><span class="comment-delimiter">*)</span>
<span class="type">let</span> make_player instr_score wait wait_event perf =

  <span class="type">let</span> <span class="type">rec</span> <span class="type">process</span> exec_seq generic delta seq =
    <span class="constant">match</span> seq <span class="constant">with</span>
    <span class="constant">|</span> [] <span class="constant">-&gt;</span> <span class="comment-delimiter">(* </span><span class="comment">rule (Empty Sequence) </span><span class="comment-delimiter">*)</span> ()
    <span class="constant">|</span> (dae, ae)::s <span class="constant">-&gt;</span>
        <span class="comment-delimiter">(* </span><span class="comment">rule (Exec Sequence) </span><span class="comment-delimiter">*)</span>
        <span class="builtin">run</span> (generic (delta +. dae) ae) <span class="constant">||</span>
        <span class="builtin">run</span> (exec_seq generic (delta +. dae) s) <span class="type">in</span>

  <span class="type">let</span> <span class="type">rec</span> <span class="type">process</span> exec score =
    <span class="constant">match</span> score <span class="constant">with</span>
    <span class="constant">|</span> [] <span class="constant">-&gt;</span> <span class="comment-delimiter">(* </span><span class="comment">rule (Empty Score) </span><span class="comment-delimiter">*)</span> ()
    <span class="constant">|</span> se::sc <span class="constant">-&gt;</span>
        <span class="comment-delimiter">(* </span><span class="comment">rule (Exec Score) </span><span class="comment-delimiter">*)</span>
        <span class="builtin">run</span> (exec_score_event se) <span class="constant">||</span>
        <span class="builtin">run</span> (exec sc)

  <span class="type">and</span> <span class="type">process</span> exec_score_event se =
    <span class="type">let</span> status = <span class="builtin">run</span> (wait_event se.event) <span class="type">in</span>
    <span class="constant">match</span> status <span class="constant">with</span>
    <span class="constant">|</span> <span class="function-name">Detected</span> <span class="constant">-&gt;</span>
        <span class="comment-delimiter">(* </span><span class="comment">rule (Detect) </span><span class="comment-delimiter">*)</span>
        <span class="builtin">run</span> (exec_seq (detected se.event) 0.0 se.seq)
    <span class="constant">|</span> <span class="function-name">Missed</span>(j) <span class="constant">-&gt;</span>
        <span class="comment-delimiter">(* </span><span class="comment">rule (Missed) </span><span class="comment-delimiter">*)</span>
        <span class="builtin">run</span> (exec_seq (missed se.event j) 0.0 se.seq)

  <span class="type">and</span> <span class="type">process</span> detected i delta ae =
    <span class="constant">match</span> ae <span class="constant">with</span>
    <span class="constant">|</span> <span class="function-name">Action</span>(a) <span class="constant">-&gt;</span>
        <span class="comment-delimiter">(* </span><span class="comment">rule (Detected Action) </span><span class="comment-delimiter">*)</span>
        <span class="builtin">run</span> (wait delta);
        <span class="builtin">emit</span> perf (i,delta,a);
    <span class="constant">|</span> <span class="function-name">Group</span>(g) <span class="constant">-&gt;</span>
        <span class="keyword">begin</span> <span class="constant">match</span> g.group_synchro <span class="constant">with</span>
        <span class="constant">|</span> <span class="function-name">Loose</span> <span class="constant">-&gt;</span>
            <span class="comment-delimiter">(* </span><span class="comment">rule (Detected Loose Group) </span><span class="comment-delimiter">*)</span>
            <span class="builtin">run</span> (exec_seq (detected i) delta g.group_seq)
        <span class="constant">|</span> <span class="function-name">Tight</span> <span class="constant">-&gt;</span>
            <span class="comment-delimiter">(* </span><span class="comment">rule (Detected Tight Group) </span><span class="comment-delimiter">*)</span>
            <span class="type">let</span> gs = <span class="function-name">Groups</span>.slice instr_score i delta g  <span class="type">in</span>
            <span class="builtin">run</span> (exec gs)
        <span class="keyword">end</span>
    <span class="constant">|</span> <span class="function-name">Until</span>(u) <span class="constant">-&gt;</span>
        <span class="comment-delimiter">(* </span><span class="comment">Preemption Construct </span><span class="comment-delimiter">*)</span>
        <span class="type">signal</span> kill <span class="type">in</span>
        <span class="constant">do</span>
          <span class="builtin">run</span> (exec_seq (detected i) delta u.until_seq); <span class="builtin">emit</span> kill
          <span class="constant">||</span>
          <span class="type">let</span> _ = <span class="builtin">run</span> (wait_event u.until_event) <span class="type">in</span> <span class="builtin">emit</span> kill
        <span class="constant">until</span> kill <span class="constant">done</span>


  <span class="type">and</span> <span class="type">process</span> missed i j delta ae =
    <span class="type">let</span> dj = instr_score.find j <span class="type">in</span>
    <span class="type">let</span> di = instr_score.find i <span class="type">in</span>
    <span class="constant">match</span> ae <span class="constant">with</span>
    <span class="constant">|</span> <span class="function-name">Action</span>(a) <span class="constant">-&gt;</span>
        <span class="comment-delimiter">(* </span><span class="comment">rule (Missed Action) </span><span class="comment-delimiter">*)</span>
        <span class="type">let</span> d = (max 0.0 (delta +. di -. dj)) <span class="type">in</span>
        <span class="builtin">run</span> (wait d);
        <span class="builtin">emit</span> perf (j,d,a);
    <span class="constant">|</span> <span class="function-name">Group</span>(g) <span class="constant">-&gt;</span>
        <span class="keyword">begin</span> <span class="constant">match</span> g.group_error <span class="constant">with</span>
        <span class="constant">|</span> <span class="function-name">Local</span> <span class="constant">-&gt;</span> <span class="comment-delimiter">(* </span><span class="comment">rule (Missed Local Group) </span><span class="comment-delimiter">*)</span> ()
        <span class="constant">|</span> <span class="function-name">Global</span> <span class="constant">-&gt;</span>
            <span class="comment-delimiter">(* </span><span class="comment">rule (Missed Global Group) </span><span class="comment-delimiter">*)</span>
            <span class="builtin">run</span> (detected j 0.0 ae)
        <span class="constant">|</span> <span class="function-name">Partial</span> <span class="constant">-&gt;</span>
            <span class="comment-delimiter">(* </span><span class="comment">rule (Missed Partial Group) </span><span class="comment-delimiter">*)</span>
            <span class="type">let</span> past, future = <span class="function-name">Groups</span>.split instr_score i j delta g <span class="type">in</span>
            <span class="type">let</span> gpast = <span class="function-name">Groups</span>.extract_group past <span class="type">in</span>
            <span class="type">let</span> gfuture =
              <span class="function-name">Group</span>({group_synchro = g.group_synchro;
                     group_error = g.group_error;
                     group_seq = future;})
            <span class="type">in</span>
            (<span class="builtin">run</span> (exec_seq (missed i j) delta gpast) <span class="constant">||</span>
            <span class="builtin">run</span> (detected j 0.0 gfuture))
        <span class="constant">|</span> <span class="function-name">Causal</span> <span class="constant">-&gt;</span>
            <span class="comment-delimiter">(* </span><span class="comment">rule (Missed Causal Group) </span><span class="comment-delimiter">*)</span>
            <span class="type">let</span> past, future = <span class="function-name">Groups</span>.split instr_score i j delta g <span class="type">in</span>
            <span class="type">let</span> gfuture =
              <span class="function-name">Group</span>({group_synchro = g.group_synchro;
                     group_error = g.group_error;
                     group_seq = future;})
            <span class="type">in</span>
            (<span class="builtin">run</span> (exec_seq (missed i j) delta past) <span class="constant">||</span>
            <span class="builtin">run</span> (detected j 0.0 gfuture))
        <span class="keyword">end</span>
    <span class="constant">|</span> <span class="function-name">Until</span>(u) <span class="constant">-&gt;</span>
        <span class="type">signal</span> kill <span class="type">in</span>
        <span class="constant">do</span>
          <span class="builtin">run</span> (exec_seq (missed i j) delta u.until_seq); <span class="builtin">emit</span> kill
          <span class="constant">||</span>
          <span class="type">let</span> _ = <span class="builtin">run</span> (wait_event u.until_event) <span class="type">in</span> <span class="builtin">emit</span> kill
        <span class="constant">until</span> kill <span class="constant">done</span>
  <span class="type">in</span>

  <span class="comment-delimiter">(* </span><span class="comment">Launch the already past part of a dynamically loaded score </span><span class="comment-delimiter">*)</span>
  <span class="type">let</span> <span class="type">rec</span> <span class="type">process</span> exec_past score j =
    <span class="constant">match</span> score <span class="constant">with</span>
    <span class="constant">|</span> [] <span class="constant">-&gt;</span> ()
    <span class="constant">|</span> se::sc <span class="constant">-&gt;</span>
        <span class="builtin">run</span> (exec_seq (missed se.event j) 0.0 se.seq) <span class="constant">||</span>
        <span class="builtin">run</span> (exec_past sc j)
  <span class="type">in</span>

  <span class="comment-delimiter">(* </span><span class="comment">Launch a score that could start after the beginning of the performance </span><span class="comment-delimiter">*)</span>
  <span class="type">let</span> <span class="type">process</span> play_score score i =
    <span class="type">let</span> past, future = <span class="function-name">List</span>.partition (<span class="type">fun</span> se <span class="constant">-&gt;</span> se.event &lt; i) score <span class="type">in</span>
    <span class="builtin">run</span> (exec future) <span class="constant">||</span>
    <span class="builtin">run</span> (exec_past past i)
  <span class="type">in</span>

  <span class="comment-delimiter">(* </span><span class="comment">Return the process wich play an electronic score </span><span class="comment-delimiter">*)</span>
  play_score
</pre>
