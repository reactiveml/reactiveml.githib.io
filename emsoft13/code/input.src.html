  <pre>
<span class="comment-delimiter">(***************************************************************)</span>
<span class="comment-delimiter">(*                        </span><span class="comment">Reactive Asco                        </span><span class="comment-delimiter">*)</span>
<span class="comment-delimiter">(*                                                             *)</span>
<span class="comment-delimiter">(*                                                             *)</span>
<span class="comment-delimiter">(* </span><span class="comment">Handle inputs                                               </span><span class="comment-delimiter">*)</span>
<span class="comment-delimiter">(* </span><span class="comment">Receive from Max/MSP via UDP or simulate the output of the  </span><span class="comment-delimiter">*)</span>
<span class="comment-delimiter">(* </span><span class="comment">listening machine                                           </span><span class="comment-delimiter">*)</span>
<span class="comment-delimiter">(***************************************************************)</span>


<span class="variable-name">open</span> <span class="function-name">Types</span>
<span class="variable-name">open</span> <span class="function-name">Utils</span>


<span class="comment-delimiter">(* </span><span class="comment">Receive a event on channel 'listen' and emit the corresponding
   signals in the table events.
</span><span class="comment-delimiter">*)</span>
<span class="type">let</span> <span class="type">process</span> server listen events =
  <span class="type">let</span> n = <span class="function-name">Array</span>.length events <span class="type">in</span>
  <span class="type">let</span> <span class="type">rec</span> <span class="type">process</span> track pev_index =
    <span class="type">await</span> <span class="type">immediate</span> <span class="type">one</span> listen (ev) <span class="type">in</span>
    <span class="constant">if</span> not (0 &lt;= ev.index <span class="constant">&amp;&amp;</span> ev.index &lt; n) <span class="constant">then</span> <span class="keyword">begin</span>
      prerr_endline <span class="string">"Error: the musician do not play the right score!"</span>;
      exit 1
    <span class="keyword">end</span>;
    <span class="constant">for</span> i = pev_index + 1 <span class="constant">to</span> ev.index - 1 <span class="constant">do</span>
      <span class="builtin">emit</span> events.(i) (<span class="function-name">Missed</span> ev.index)
    <span class="constant">done</span>;
    <span class="builtin">emit</span> events.(ev.index) <span class="function-name">Detected</span>;
    <span class="builtin">pause</span>;
    <span class="builtin">run</span> (track ev.index)
  <span class="type">in</span>
  <span class="builtin">run</span> (track 0)

<span class="comment-delimiter">(* </span><span class="comment">Receive message from Max via UDP and send them to the motor. </span><span class="comment-delimiter">*)</span>
<span class="type">let</span> <span class="type">process</span> udp server_port listen events =
  <span class="type">let</span> maxlen = 1024 <span class="type">in</span>
  <span class="type">let</span> sock_event = <span class="function-name">Network</span>.init_server server_port <span class="type">in</span>
  print_endline (<span class="string">"waiting on port : "</span>^(string_of_int server_port));
  <span class="type">let</span> <span class="type">rec</span> <span class="type">process</span> max_server =
    <span class="type">let</span> newmsg = <span class="function-name">String</span>.create maxlen <span class="type">in</span>
    <span class="keyword">begin</span> <span class="constant">try</span>
      <span class="type">let</span> len,_ = <span class="function-name">Unix</span>.recvfrom sock_event newmsg 0 maxlen [] <span class="type">in</span>
      <span class="type">let</span> msg = <span class="function-name">String</span>.sub newmsg 0 len <span class="type">in</span>
      <span class="type">let</span> s = <span class="function-name">Str</span>.split (<span class="function-name">Str</span>.regexp <span class="string">"[ \t]+"</span>) msg <span class="type">in</span>
      <span class="type">let</span> c = int_of_string (<span class="function-name">List</span>.nth s 0) <span class="type">in</span>
      <span class="type">let</span> b = float_of_string (<span class="function-name">List</span>.nth s 1) /. 60. <span class="type">in</span>
      <span class="type">let</span> nev = {index = c; bps=b;} <span class="type">in</span>
      <span class="builtin">emit</span> listen nev
    <span class="constant">with</span> _ <span class="constant">-&gt;</span> () <span class="keyword">end</span>;
    <span class="builtin">pause</span>;
    <span class="builtin">run</span> max_server
  <span class="type">in</span>
  <span class="builtin">run</span> max_server <span class="constant">||</span>
  <span class="builtin">run</span> (server listen events)

<span class="comment-delimiter">(* </span><span class="comment">Send messages on signal events corresponding to the simulation with
   'errors' the probability of error
</span><span class="comment-delimiter">*)</span>
<span class="type">let</span> <span class="type">process</span> simulator simu errors freq listen events =
  <span class="type">signal</span> clock <span class="type">in</span>
  <span class="type">signal</span> t <span class="type">in</span>
  <span class="type">let</span> period = 1. /. freq <span class="type">in</span>

  <span class="comment-delimiter">(* </span><span class="comment">Time in seconds (same as elapsed but without the moving tempo) </span><span class="comment-delimiter">*)</span>
  <span class="type">let</span> <span class="type">process</span> time =
    <span class="type">let</span> x = ref 0.0 <span class="type">in</span>
    <span class="keyword">loop</span>
      x := !x +. period;
      <span class="builtin">emit</span> t !x;
      <span class="builtin">pause</span>
    <span class="keyword">end</span>
  <span class="type">in</span>

  <span class="comment-delimiter">(* </span><span class="comment">Play the simulation with a probability of error 'error'
     for each event
  </span><span class="comment-delimiter">*)</span>
  <span class="type">let</span> <span class="type">rec</span> <span class="type">process</span> play s =
    <span class="constant">match</span> s <span class="constant">with</span>
    <span class="constant">|</span> [] <span class="constant">-&gt;</span> ()
    <span class="constant">|</span> (i, d, b)::s' <span class="constant">-&gt;</span>
          <span class="type">await</span> <span class="type">immediate</span> <span class="type">one</span> t (e) <span class="type">in</span>
          <span class="constant">if</span> d &lt; e <span class="constant">then</span>
            <span class="type">let</span> p = <span class="function-name">Random</span>.float 100.0 <span class="type">in</span>
            <span class="keyword">begin</span> <span class="constant">if</span> p &gt; errors <span class="constant">then</span>
              <span class="type">let</span> nev = {index = i; bps = b /. 60.;} <span class="type">in</span>
              <span class="builtin">emit</span> listen nev
            <span class="keyword">end</span>;
            <span class="builtin">run</span> (play s')
          <span class="constant">else</span>
            (<span class="builtin">pause</span>; <span class="builtin">run</span> (play s))
  <span class="type">in</span>

  <span class="constant">do</span> <span class="builtin">run</span> time <span class="constant">when</span> clock <span class="constant">done</span> <span class="constant">||</span>
  <span class="builtin">run</span> (<span class="function-name">Time</span>.emit_clock clock freq) <span class="constant">||</span>
  <span class="builtin">run</span> (play simu) <span class="constant">||</span>
  <span class="builtin">run</span> (server listen events)
</pre>
