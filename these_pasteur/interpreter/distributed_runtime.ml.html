<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<!-- Created by htmlize-1.47 in css mode. -->
<html>
  <head>
    <title>distributed_runtime.ml</title>
    <style type="text/css">
    <!--
      body {
        color: #000000;
        background-color: #ffffff;
      }
      .comment {
        /* font-lock-comment-face */
        color: #b22222;
      }
      .constant {
        /* font-lock-constant-face */
        color: #008b8b;
      }
      .doc {
        /* font-lock-doc-face */
        color: #8b2252;
      }
      .function-name {
        /* font-lock-function-name-face */
        color: #0000ff;
      }
      .keyword {
        /* font-lock-keyword-face */
        color: #a020f0;
      }
      .string {
        /* font-lock-string-face */
        color: #8b2252;
      }
      .tuareg-font-lock-governing {
        /* tuareg-font-lock-governing-face */
        color: #0000ff;
        font-weight: bold;
      }
      .tuareg-font-lock-operator {
        /* tuareg-font-lock-operator-face */
        color: #a52a2a;
      }
      .type {
        /* font-lock-type-face */
        color: #228b22;
      }
      .variable-name {
        /* font-lock-variable-name-face */
        color: #a0522d;
      }

      a {
        color: inherit;
        background-color: inherit;
        font: inherit;
        text-decoration: inherit;
      }
      a:hover {
        text-decoration: underline;
      }
    -->
    </style>
  </head>
  <body>
    <pre>
<span class="tuareg-font-lock-governing">open</span> <span class="type">Runtime</span>
<span class="tuareg-font-lock-governing">open</span> <span class="type">Runtime_options</span>
<span class="tuareg-font-lock-governing">open</span> <span class="type">Rml_types</span>

<span class="tuareg-font-lock-governing">let</span> <span class="function-name">assert_some</span><span class="variable-name"> v </span><span class="tuareg-font-lock-operator">=</span> <span class="keyword">match</span> v <span class="keyword">with</span>
  <span class="tuareg-font-lock-operator">|</span> None <span class="tuareg-font-lock-operator">-&gt;</span> <span class="keyword">assert</span> <span class="constant">false</span>
  <span class="tuareg-font-lock-operator">|</span> Some v <span class="tuareg-font-lock-operator">-&gt;</span> v

<span class="tuareg-font-lock-governing">module</span> <span class="type">E </span><span class="tuareg-font-lock-operator">=</span> <span class="type">Sig_env</span>.Record
<span class="tuareg-font-lock-governing">module</span> <span class="type">D </span><span class="tuareg-font-lock-operator">=</span> <span class="type">Seq_runtime</span>.ListListDataStruct

<span class="tuareg-font-lock-governing">module</span> <span class="type">Make</span>
  <span class="tuareg-font-lock-operator">(</span><span class="variable-name">CF</span> <span class="tuareg-font-lock-operator">:</span> <span class="tuareg-font-lock-governing">functor</span><span class="type"> </span><span class="tuareg-font-lock-operator">(</span><span class="variable-name">T</span> <span class="tuareg-font-lock-operator">:</span> <span class="type">Communication.TAG_TYPE</span><span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">-&gt;</span> <span class="type">Communication</span>.S
   <span class="tuareg-font-lock-governing">with type</span> <span class="tuareg-font-lock-operator">'</span><span class="type">gid tag </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">'</span>gid <span class="type">T</span>.t<span class="tuareg-font-lock-operator">)</span>
  <span class="tuareg-font-lock-operator">(</span><span class="variable-name">CALL</span> <span class="tuareg-font-lock-operator">:</span> <span class="tuareg-font-lock-governing">functor</span><span class="type"> </span><span class="tuareg-font-lock-operator">(</span><span class="variable-name">C</span><span class="tuareg-font-lock-operator">:</span> <span class="type">Communication.S</span><span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">-&gt;</span> <span class="type">Callbacks</span>.S
   <span class="tuareg-font-lock-governing">with type</span> <span class="type">msg </span><span class="tuareg-font-lock-operator">=</span> <span class="type">C</span>.msg <span class="tuareg-font-lock-governing">and</span> <span class="tuareg-font-lock-governing">type</span><span class="variable-name"> tag </span><span class="tuareg-font-lock-operator">=</span> <span class="type">C</span>.gid <span class="type">C</span>.tag<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">=</span>
<span class="tuareg-font-lock-governing">struct</span>
    <span class="tuareg-font-lock-governing">module</span> <span class="type">SiteMsgs </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-governing">struct</span>
      <span class="tuareg-font-lock-governing">type</span> <span class="tuareg-font-lock-operator">'</span><span class="type">gid t </span><span class="tuareg-font-lock-operator">=</span>
          <span class="tuareg-font-lock-operator">|</span> Mfinalize
          <span class="tuareg-font-lock-operator">|</span> Mfinalize_ack
          <span class="tuareg-font-lock-operator">|</span> Mresult
          <span class="comment">(* scheduling *)</span>
          <span class="tuareg-font-lock-operator">|</span> Mnew_cd
          <span class="tuareg-font-lock-operator">|</span> Mstep <span class="comment">(* do one global step of the clock domain *)</span>
          <span class="tuareg-font-lock-operator">|</span> Mstep_done <span class="tuareg-font-lock-operator">of</span> <span class="tuareg-font-lock-operator">'</span>gid <span class="comment">(* a clock domain has finished its step *)</span>
          <span class="tuareg-font-lock-operator">|</span> Mdone <span class="tuareg-font-lock-operator">of</span> <span class="tuareg-font-lock-operator">'</span>gid <span class="comment">(* global step done *)</span>
          <span class="tuareg-font-lock-operator">|</span> Meoi <span class="comment">(* End of instant of clock domain *)</span>
          <span class="tuareg-font-lock-operator">|</span> Mhas_next <span class="tuareg-font-lock-operator">of</span> <span class="tuareg-font-lock-operator">'</span>gid
              <span class="comment">(* Whether there is processes to execute in the next local step *)</span>
          <span class="tuareg-font-lock-operator">|</span> Mnew_remote <span class="tuareg-font-lock-operator">of</span> <span class="tuareg-font-lock-operator">'</span>gid
              <span class="comment">(* signals *)</span>
          <span class="tuareg-font-lock-operator">|</span> Memit <span class="tuareg-font-lock-operator">of</span> <span class="tuareg-font-lock-operator">'</span>gid <span class="comment">(* Emit a value *)</span>
          <span class="tuareg-font-lock-operator">|</span> Mvalue <span class="tuareg-font-lock-operator">of</span> <span class="tuareg-font-lock-operator">'</span>gid <span class="comment">(* Send the value of the signal to child cd *)</span>
          <span class="tuareg-font-lock-operator">|</span> Msignal <span class="tuareg-font-lock-operator">of</span> <span class="tuareg-font-lock-operator">'</span>gid <span class="comment">(* Send the whole signal *)</span>
          <span class="tuareg-font-lock-operator">|</span> Mreq_signal <span class="tuareg-font-lock-operator">of</span> <span class="tuareg-font-lock-operator">'</span>gid <span class="comment">(* Request the value of the signal *)</span>
          <span class="tuareg-font-lock-operator">|</span> Mcreate_signal
          <span class="tuareg-font-lock-operator">|</span> Msignal_created <span class="tuareg-font-lock-operator">of</span> <span class="tuareg-font-lock-operator">'</span>gid

      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">dummy </span><span class="tuareg-font-lock-operator">=</span> Mfinalize_ack

      <span class="tuareg-font-lock-governing">let</span> <span class="function-name">flush_after</span><span class="variable-name"> tag </span><span class="tuareg-font-lock-operator">=</span> <span class="keyword">match</span> tag <span class="keyword">with</span>
         <span class="tuareg-font-lock-operator">|</span> Mfinalize <span class="tuareg-font-lock-operator">|</span> Mfinalize_ack <span class="tuareg-font-lock-operator">|</span> Mhas_next _ <span class="tuareg-font-lock-operator">|</span> Mvalue _ <span class="tuareg-font-lock-operator">|</span> Mnew_cd
         <span class="tuareg-font-lock-operator">|</span> Mreq_signal _ <span class="tuareg-font-lock-operator">|</span> Msignal_created _ <span class="tuareg-font-lock-operator">|</span> Mcreate_signal <span class="tuareg-font-lock-operator">-&gt;</span> <span class="constant">true</span>
         <span class="tuareg-font-lock-operator">|</span> _ <span class="tuareg-font-lock-operator">-&gt;</span> <span class="constant">false</span>

      <span class="tuareg-font-lock-governing">open</span> <span class="type">Format</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="function-name">print</span><span class="variable-name"> print_gid ff m </span><span class="tuareg-font-lock-operator">=</span> <span class="keyword">match</span> m <span class="keyword">with</span>
        <span class="tuareg-font-lock-operator">|</span> Mfinalize_ack <span class="tuareg-font-lock-operator">-&gt;</span> fprintf ff <span class="string">"Mfinalize_ack"</span>
        <span class="tuareg-font-lock-operator">|</span> Mfinalize <span class="tuareg-font-lock-operator">-&gt;</span> fprintf ff <span class="string">"Mfinalize"</span>
        <span class="tuareg-font-lock-operator">|</span> Mresult <span class="tuareg-font-lock-operator">-&gt;</span> fprintf ff <span class="string">"Mresult"</span>
        <span class="tuareg-font-lock-operator">|</span> Mnew_cd <span class="tuareg-font-lock-operator">-&gt;</span> fprintf ff <span class="string">"Mnew_cd"</span>
        <span class="tuareg-font-lock-operator">|</span> Mstep <span class="tuareg-font-lock-operator">-&gt;</span> fprintf ff <span class="string">"Mstep"</span>
        <span class="tuareg-font-lock-operator">|</span> Mstep_done gid <span class="tuareg-font-lock-operator">-&gt;</span> fprintf ff <span class="string">"Mstep_done %a"</span> print_gid gid
        <span class="tuareg-font-lock-operator">|</span> Mdone gid <span class="tuareg-font-lock-operator">-&gt;</span> fprintf ff <span class="string">"Mdone %a"</span> print_gid gid
        <span class="tuareg-font-lock-operator">|</span> Meoi <span class="tuareg-font-lock-operator">-&gt;</span> fprintf ff <span class="string">"Meoi"</span>
        <span class="tuareg-font-lock-operator">|</span> Mhas_next gid <span class="tuareg-font-lock-operator">-&gt;</span> fprintf ff <span class="string">"Mhas_next %a"</span> print_gid gid
        <span class="tuareg-font-lock-operator">|</span> Mnew_remote gid <span class="tuareg-font-lock-operator">-&gt;</span> fprintf ff <span class="string">"Mnew_remote %a"</span> print_gid gid
            <span class="comment">(* Whether there is processes to execute in the next local step *)</span>
        <span class="comment">(* signals *)</span>
        <span class="tuareg-font-lock-operator">|</span> Memit gid <span class="tuareg-font-lock-operator">-&gt;</span> fprintf ff <span class="string">"Memit %a"</span> print_gid gid
        <span class="tuareg-font-lock-operator">|</span> Mvalue gid <span class="tuareg-font-lock-operator">-&gt;</span> fprintf ff <span class="string">"Mvalue %a"</span> print_gid gid
        <span class="tuareg-font-lock-operator">|</span> Msignal gid <span class="tuareg-font-lock-operator">-&gt;</span> fprintf ff <span class="string">"Msignal %a"</span> print_gid gid
        <span class="tuareg-font-lock-operator">|</span> Mreq_signal gid <span class="tuareg-font-lock-operator">-&gt;</span> fprintf ff <span class="string">"Mreq_signal %a"</span> print_gid gid
        <span class="tuareg-font-lock-operator">|</span> Mcreate_signal <span class="tuareg-font-lock-operator">-&gt;</span> fprintf ff <span class="string">"Mcreate_signal"</span>
        <span class="tuareg-font-lock-operator">|</span> Msignal_created gid <span class="tuareg-font-lock-operator">-&gt;</span> fprintf ff <span class="string">"Msignal_created %a"</span> print_gid gid
    <span class="tuareg-font-lock-governing">end</span>
    <span class="tuareg-font-lock-governing">open</span> <span class="type">SiteMsgs</span>

    <span class="tuareg-font-lock-governing">module</span> <span class="type">C </span><span class="tuareg-font-lock-operator">=</span> CF<span class="tuareg-font-lock-operator">(</span>SiteMsgs<span class="tuareg-font-lock-operator">)</span>

    <span class="tuareg-font-lock-governing">module</span> <span class="type">Callbacks </span><span class="tuareg-font-lock-operator">=</span> CALL<span class="tuareg-font-lock-operator">(</span>C<span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-governing">module</span> <span class="type">L </span><span class="tuareg-font-lock-operator">=</span> <span class="type">Load_balancer</span>.Make <span class="tuareg-font-lock-operator">(</span>C<span class="tuareg-font-lock-operator">)</span>

    <span class="tuareg-font-lock-governing">module</span> <span class="type">GidHandle </span><span class="tuareg-font-lock-operator">=</span> <span class="type">Dhandle_typed</span>.Make <span class="tuareg-font-lock-operator">(</span><span class="tuareg-font-lock-governing">struct</span>
      <span class="tuareg-font-lock-governing">type</span> <span class="type">t </span><span class="tuareg-font-lock-operator">=</span> <span class="type">C</span>.gid
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">compare </span><span class="tuareg-font-lock-operator">=</span> compare
    <span class="tuareg-font-lock-governing">end</span><span class="tuareg-font-lock-operator">)</span>

    <span class="tuareg-font-lock-governing">type</span> <span class="type">clock </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">{</span>
      <span class="variable-name">ck_gid</span> <span class="tuareg-font-lock-operator">:</span> <span class="type">C.gid</span><span class="tuareg-font-lock-operator">;</span>
      <span class="variable-name">ck_parent</span> <span class="tuareg-font-lock-operator">:</span> <span class="type">clock option</span><span class="tuareg-font-lock-operator">;</span>
      <span class="variable-name">ck_clock</span> <span class="tuareg-font-lock-operator">:</span> <span class="type">E.clock GidHandle.handle</span><span class="tuareg-font-lock-operator">;</span>
    <span class="tuareg-font-lock-operator">}</span>
    <span class="tuareg-font-lock-governing">type</span> <span class="type">region </span><span class="tuareg-font-lock-operator">=</span> clock
    <span class="doc">(** Saving and searching clock state *)</span>
    <span class="tuareg-font-lock-governing">type</span> <span class="type">clock_state </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">(</span>clock <span class="tuareg-font-lock-operator">*</span> <span class="type">E</span>.clock_index<span class="tuareg-font-lock-operator">)</span> list

    <span class="tuareg-font-lock-governing">type</span> <span class="tuareg-font-lock-operator">'</span><span class="type">a step </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">'</span>a <span class="tuareg-font-lock-operator">-&gt;</span> unit
    <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">unit_value </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">()</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">dummy_step</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">()</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">()</span>

    <span class="tuareg-font-lock-governing">type</span> <span class="type">control_type </span><span class="tuareg-font-lock-operator">=</span>
        <span class="tuareg-font-lock-operator">|</span> Clock_domain <span class="tuareg-font-lock-operator">of</span> clock option
        <span class="tuareg-font-lock-operator">|</span> Kill <span class="tuareg-font-lock-operator">of</span> unit step
        <span class="tuareg-font-lock-operator">|</span> Kill_handler <span class="tuareg-font-lock-operator">of</span> <span class="tuareg-font-lock-operator">(</span>unit <span class="tuareg-font-lock-operator">-&gt;</span> unit step<span class="tuareg-font-lock-operator">)</span>
        <span class="tuareg-font-lock-operator">|</span> Susp
        <span class="tuareg-font-lock-operator">|</span> When

    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">control_of_runtime_control</span><span class="variable-name"> k </span><span class="tuareg-font-lock-operator">=</span> <span class="keyword">match</span> k <span class="keyword">with</span>
      <span class="tuareg-font-lock-operator">|</span> <span class="type">Runtime</span>.Kill <span class="tuareg-font-lock-operator">(</span>_<span class="tuareg-font-lock-operator">,</span> h<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">-&gt;</span> Kill h
      <span class="tuareg-font-lock-operator">|</span> <span class="type">Runtime</span>.Kill_handler <span class="tuareg-font-lock-operator">(</span>_<span class="tuareg-font-lock-operator">,</span> h<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">-&gt;</span> Kill_handler h
      <span class="tuareg-font-lock-operator">|</span> <span class="type">Runtime</span>.Susp <span class="tuareg-font-lock-operator">-&gt;</span> Susp
      <span class="tuareg-font-lock-operator">|</span> <span class="type">Runtime</span>.When <span class="tuareg-font-lock-operator">-&gt;</span> When
      <span class="tuareg-font-lock-operator">|</span> _ <span class="tuareg-font-lock-operator">-&gt;</span> <span class="keyword">assert</span> <span class="constant">false</span>

    <span class="tuareg-font-lock-governing">type</span> <span class="type">control_tree </span><span class="tuareg-font-lock-operator">=</span>
        <span class="tuareg-font-lock-operator">{</span> <span class="variable-name">kind</span><span class="tuareg-font-lock-operator">:</span> <span class="type">control_type</span><span class="tuareg-font-lock-operator">;</span>
          <span class="keyword">mutable</span> <span class="variable-name">alive</span><span class="tuareg-font-lock-operator">:</span> <span class="type">bool</span><span class="tuareg-font-lock-operator">;</span>
          <span class="keyword">mutable</span> <span class="variable-name">susp</span><span class="tuareg-font-lock-operator">:</span> <span class="type">bool</span><span class="tuareg-font-lock-operator">;</span>
          <span class="keyword">mutable</span> <span class="variable-name">cond_v</span> <span class="tuareg-font-lock-operator">:</span> <span class="type">bool</span><span class="tuareg-font-lock-operator">;</span>
          <span class="keyword">mutable</span> <span class="variable-name">children</span><span class="tuareg-font-lock-operator">:</span> <span class="type">control_tree list</span><span class="tuareg-font-lock-operator">;</span>
          <span class="variable-name">next</span><span class="tuareg-font-lock-operator">:</span> <span class="type">D.next</span><span class="tuareg-font-lock-operator">;</span>
          <span class="variable-name">next_control</span> <span class="tuareg-font-lock-operator">:</span> <span class="type">D.next</span><span class="tuareg-font-lock-operator">;</span> <span class="comment">(* contains control processes that should not be
                                  taken into account to see if macro step is done *)</span>
          <span class="keyword">mutable</span> <span class="variable-name">last_activation</span> <span class="tuareg-font-lock-operator">:</span> <span class="type">clock_state</span><span class="tuareg-font-lock-operator">;</span>
          <span class="keyword">mutable</span> <span class="variable-name">instance</span> <span class="tuareg-font-lock-operator">:</span> <span class="type">int</span><span class="tuareg-font-lock-operator">;</span>
        <span class="tuareg-font-lock-operator">}</span>

    <span class="tuareg-font-lock-governing">type</span> <span class="type">waiting_kind </span><span class="tuareg-font-lock-operator">=</span>
        <span class="tuareg-font-lock-operator">|</span> Wbefore_eoi <span class="tuareg-font-lock-operator">of</span> <span class="type">C</span>.gid <span class="comment">(* before the eoi *)</span>
        <span class="tuareg-font-lock-operator">|</span> Weoi <span class="tuareg-font-lock-operator">of</span> <span class="type">C</span>.gid <span class="comment">(* eoi of the current clock domain *)</span>
        <span class="tuareg-font-lock-operator">|</span> Wafter_eoi <span class="tuareg-font-lock-operator">of</span> <span class="type">C</span>.gid <span class="comment">(* after the eoi *)</span>
        <span class="tuareg-font-lock-operator">|</span> Wnext_instant <span class="tuareg-font-lock-operator">of</span> <span class="type">C</span>.gid <span class="comment">(* next instant of the current clock domain, after eoi*)</span>
        <span class="tuareg-font-lock-operator">|</span> Wsignal_wa <span class="tuareg-font-lock-operator">of</span> <span class="type">C</span>.gid <span class="comment">(* On emission of signal *)</span>
        <span class="tuareg-font-lock-operator">|</span> Wsignal_wp <span class="tuareg-font-lock-operator">of</span> <span class="type">C</span>.gid <span class="comment">(* On emission of signal or end of instant of parent clock domain *)</span>

    <span class="tuareg-font-lock-governing">module</span> <span class="type">WaitingMap </span><span class="tuareg-font-lock-operator">=</span> <span class="type">Map</span>.Make <span class="tuareg-font-lock-operator">(</span><span class="tuareg-font-lock-governing">struct</span>
      <span class="tuareg-font-lock-governing">type</span> <span class="type">t </span><span class="tuareg-font-lock-operator">=</span> waiting_kind
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">compare </span><span class="tuareg-font-lock-operator">=</span> compare
    <span class="tuareg-font-lock-governing">end</span><span class="tuareg-font-lock-operator">)</span>

    <span class="tuareg-font-lock-governing">module</span> <span class="type">SignalHandle </span><span class="tuareg-font-lock-operator">=</span> <span class="type">Dhandle</span>.Make <span class="tuareg-font-lock-operator">(</span><span class="tuareg-font-lock-governing">struct</span>
      <span class="tuareg-font-lock-governing">type</span> <span class="type">key </span><span class="tuareg-font-lock-operator">=</span> <span class="type">C</span>.gid
      <span class="tuareg-font-lock-governing">type</span> <span class="tuareg-font-lock-operator">('</span><span class="type">a</span><span class="tuareg-font-lock-operator">,</span><span class="type"> </span><span class="tuareg-font-lock-operator">'</span><span class="type">b</span><span class="tuareg-font-lock-operator">)</span><span class="type"> value </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">('</span>a<span class="tuareg-font-lock-operator">,</span> <span class="tuareg-font-lock-operator">'</span>b<span class="tuareg-font-lock-operator">)</span> <span class="type">E</span>.t <span class="tuareg-font-lock-operator">*</span> clock <span class="tuareg-font-lock-operator">*</span> region <span class="tuareg-font-lock-operator">*</span> clock option
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">compare </span><span class="tuareg-font-lock-operator">=</span> compare
    <span class="tuareg-font-lock-governing">end</span><span class="tuareg-font-lock-operator">)</span>

    <span class="tuareg-font-lock-governing">type</span> <span class="tuareg-font-lock-operator">('</span><span class="type">a</span><span class="tuareg-font-lock-operator">,</span><span class="type"> </span><span class="tuareg-font-lock-operator">'</span><span class="type">b</span><span class="tuareg-font-lock-operator">)</span><span class="type"> event </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">{</span>
      <span class="variable-name">ev_handle</span> <span class="tuareg-font-lock-operator">:</span> <span class="tuareg-font-lock-operator">('</span><span class="type">a</span><span class="tuareg-font-lock-operator">,'</span><span class="type">b</span><span class="tuareg-font-lock-operator">)</span><span class="type"> SignalHandle.handle</span><span class="tuareg-font-lock-operator">;</span>
      <span class="variable-name">ev_gid</span> <span class="tuareg-font-lock-operator">:</span> <span class="type">C.gid</span>
    <span class="tuareg-font-lock-operator">}</span>
    <span class="tuareg-font-lock-governing">type</span> <span class="type">event_cfg </span><span class="tuareg-font-lock-operator">=</span> unit
   <span class="comment">(*   | Cevent of (bool -&gt; bool) * clock * gid list
      (* status, cd, wa, wp*)
      | Cand of event_cfg * event_cfg
      | Cor of event_cfg * event_cfg *)</span>

    <span class="tuareg-font-lock-governing">type</span> <span class="type">clock_domain </span><span class="tuareg-font-lock-operator">=</span>
        <span class="tuareg-font-lock-operator">{</span> <span class="variable-name">cd_current</span> <span class="tuareg-font-lock-operator">:</span> <span class="type">D.current</span><span class="tuareg-font-lock-operator">;</span>
          <span class="keyword">mutable</span> <span class="variable-name">cd_eoi</span> <span class="tuareg-font-lock-operator">:</span> <span class="type">bool</span><span class="tuareg-font-lock-operator">;</span> <span class="comment">(* is it the eoi of this clock *)</span>
          <span class="keyword">mutable</span> <span class="variable-name">cd_wake_up</span> <span class="tuareg-font-lock-operator">:</span> <span class="type">waiting_kind list</span><span class="tuareg-font-lock-operator">;</span>
          <span class="comment">(* waiting lists to wake up at the end of the instant*)</span>
          <span class="variable-name">cd_clock</span> <span class="tuareg-font-lock-operator">:</span> <span class="type">clock</span><span class="tuareg-font-lock-operator">;</span>
          <span class="keyword">mutable</span> <span class="variable-name">cd_top</span> <span class="tuareg-font-lock-operator">:</span> <span class="type">control_tree</span><span class="tuareg-font-lock-operator">;</span>
          <span class="variable-name">cd_parent_ctrl</span> <span class="tuareg-font-lock-operator">:</span> <span class="type">control_tree option</span><span class="tuareg-font-lock-operator">;</span>
          <span class="variable-name">cd_parent_self_id</span> <span class="tuareg-font-lock-operator">:</span> <span class="type">C.gid option</span><span class="tuareg-font-lock-operator">;</span> <span class="comment">(* id to send Mstep_done msgs to *)</span>

          <span class="variable-name">cd_load_balancer</span> <span class="tuareg-font-lock-operator">:</span> <span class="type">L.load_balancer</span><span class="tuareg-font-lock-operator">;</span>
          <span class="variable-name">cd_location</span> <span class="tuareg-font-lock-operator">:</span> <span class="type">L.kind</span><span class="tuareg-font-lock-operator">;</span>
          <span class="keyword">mutable</span> <span class="variable-name">cd_children_have_next</span> <span class="tuareg-font-lock-operator">:</span> <span class="type">bool</span><span class="tuareg-font-lock-operator">;</span>
          <span class="variable-name">cd_active_children</span> <span class="tuareg-font-lock-operator">:</span> <span class="type">int </span><span class="tuareg-font-lock-operator">ref;</span>
          <span class="keyword">mutable</span> <span class="variable-name">cd_last_activation</span> <span class="tuareg-font-lock-operator">:</span> <span class="type">clock_state</span><span class="tuareg-font-lock-operator">;</span>
          <span class="variable-name">cd_remaining_async</span> <span class="tuareg-font-lock-operator">:</span> <span class="type">int </span><span class="tuareg-font-lock-operator">ref;</span>
          <span class="keyword">mutable</span> <span class="variable-name">cd_direct_remotes</span> <span class="tuareg-font-lock-operator">:</span> <span class="type">C.SiteSet.t</span><span class="tuareg-font-lock-operator">;</span> <span class="comment">(* remotes with direct child clock domains*)</span>
          <span class="keyword">mutable</span> <span class="variable-name">cd_other_remotes</span> <span class="tuareg-font-lock-operator">:</span> <span class="type">C.SiteSet.t</span><span class="tuareg-font-lock-operator">;</span> <span class="comment">(* remotes with grand-child clock domains*)</span>

          <span class="keyword">mutable</span> <span class="variable-name">cd_counter</span> <span class="tuareg-font-lock-operator">:</span> <span class="type">int</span><span class="tuareg-font-lock-operator">;</span>
          <span class="variable-name">cd_period</span> <span class="tuareg-font-lock-operator">:</span> <span class="type">int option</span><span class="tuareg-font-lock-operator">;</span>
          <span class="keyword">mutable</span> <span class="variable-name">cd_paused</span> <span class="tuareg-font-lock-operator">:</span> <span class="type">bool</span><span class="tuareg-font-lock-operator">;</span>
        <span class="tuareg-font-lock-operator">}</span>

    <span class="tuareg-font-lock-governing">type</span> <span class="type">site </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">{</span>
      <span class="keyword">mutable</span> <span class="variable-name">s_top_clock_domain</span> <span class="tuareg-font-lock-operator">:</span> <span class="type">clock_domain option</span><span class="tuareg-font-lock-operator">;</span>
      <span class="keyword">mutable</span> <span class="variable-name">s_clock_domains</span> <span class="tuareg-font-lock-operator">:</span> <span class="type">clock_domain C.GidMap.t</span><span class="tuareg-font-lock-operator">;</span>
      <span class="variable-name">s_msg_queue</span> <span class="tuareg-font-lock-operator">:</span> <span class="type">Callbacks.msg_queue</span><span class="tuareg-font-lock-operator">;</span>
      <span class="variable-name">s_callbacks</span> <span class="tuareg-font-lock-operator">:</span> <span class="type">Callbacks.dispatcher</span><span class="tuareg-font-lock-operator">;</span>
      <span class="variable-name">s_clock_cache</span> <span class="tuareg-font-lock-operator">:</span> <span class="type">E.clock GidHandle.cache</span><span class="tuareg-font-lock-operator">;</span>
      <span class="keyword">mutable</span> <span class="variable-name">s_signal_cache</span> <span class="tuareg-font-lock-operator">:</span> <span class="type">SignalHandle.cache</span><span class="tuareg-font-lock-operator">;</span>
      <span class="keyword">mutable</span> <span class="variable-name">s_waiting</span> <span class="tuareg-font-lock-operator">:</span> <span class="type">D.waiting_list WaitingMap.t</span><span class="tuareg-font-lock-operator">;</span> <span class="comment">(* waiting lists for parent cds and slow signals *)</span>
      <span class="variable-name">s_seed</span> <span class="tuareg-font-lock-operator">:</span> <span class="type">C.seed</span><span class="tuareg-font-lock-operator">;</span>
      <span class="variable-name">s_comm_site</span> <span class="tuareg-font-lock-operator">:</span> <span class="type">C.site</span><span class="tuareg-font-lock-operator">;</span>
      <span class="keyword">mutable</span> <span class="variable-name">s_signals_remotes</span> <span class="tuareg-font-lock-operator">:</span> <span class="type">C.SiteSet.t C.GidMap.t</span><span class="tuareg-font-lock-operator">;</span>
      <span class="keyword">mutable</span> <span class="variable-name">s_remotes</span> <span class="tuareg-font-lock-operator">:</span> <span class="type">C.SiteSet.t</span><span class="tuareg-font-lock-operator">;</span> <span class="comment">(* remotes with child clock domains*)</span>
    <span class="tuareg-font-lock-operator">}</span>

    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">print_clock</span><span class="variable-name"> ff ck </span><span class="tuareg-font-lock-operator">=</span>
      <span class="type">C</span>.print_gid ff ck.ck_gid
    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">print_cd</span><span class="variable-name"> ff cd </span><span class="tuareg-font-lock-operator">=</span>
      <span class="type">C</span>.print_gid ff cd.cd_clock.ck_gid
    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">print_signal</span><span class="variable-name"> ff ev </span><span class="tuareg-font-lock-operator">=</span>
      <span class="type">C</span>.print_gid ff ev.ev_gid

    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">get_site</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">()</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span>
      <span class="tuareg-font-lock-operator">(</span><span class="type">Local_ref</span>.get 0<span class="tuareg-font-lock-operator">:</span><span class="type">site</span><span class="tuareg-font-lock-operator">)</span>

    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">find_waiting</span><span class="variable-name"> site wk </span><span class="tuareg-font-lock-operator">=</span>
      <span class="keyword">try</span>
        <span class="type">WaitingMap</span>.find wk site.s_waiting
      <span class="keyword">with</span>
        <span class="tuareg-font-lock-operator">|</span> Not_found <span class="tuareg-font-lock-operator">-&gt;</span>
            <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">w </span><span class="tuareg-font-lock-operator">=</span> <span class="type">D</span>.mk_waiting_list <span class="tuareg-font-lock-operator">()</span> <span class="tuareg-font-lock-governing">in</span>
            site.s_waiting <span class="tuareg-font-lock-operator">&lt;-</span> <span class="type">WaitingMap</span>.add wk w site.s_waiting<span class="tuareg-font-lock-operator">;</span>
            w
    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">add_waiting</span><span class="variable-name"> site wk f </span><span class="tuareg-font-lock-operator">=</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">w </span><span class="tuareg-font-lock-operator">=</span> find_waiting site wk <span class="tuareg-font-lock-governing">in</span>
        <span class="type">D</span>.add_waiting f w
    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">wake_up_now</span><span class="variable-name"> site wk </span><span class="tuareg-font-lock-operator">=</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">w </span><span class="tuareg-font-lock-operator">=</span> find_waiting site wk <span class="tuareg-font-lock-governing">in</span>
      <span class="type">List</span>.iter <span class="tuareg-font-lock-operator">(</span><span class="keyword">fun</span> <span class="variable-name">f </span><span class="tuareg-font-lock-operator">-&gt;</span> f <span class="tuareg-font-lock-operator">())</span> <span class="tuareg-font-lock-operator">(</span><span class="type">D</span>.take_all w<span class="tuareg-font-lock-operator">)</span>

    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">add_callback</span><span class="variable-name"> site msg f </span><span class="tuareg-font-lock-operator">=</span>
      <span class="type">Callbacks</span>.add_callback msg f site.s_callbacks
    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">add_callback_once</span><span class="variable-name"> site msg f </span><span class="tuareg-font-lock-operator">=</span>
      <span class="type">Callbacks</span>.add_callback <span class="tuareg-font-lock-operator">~</span><span class="variable-name">kind</span><span class="tuareg-font-lock-operator">:</span><span class="type">Callbacks.Once msg f site.s_callbacks</span>

    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">get_clock</span><span class="variable-name"> site ck </span><span class="tuareg-font-lock-operator">=</span>
      <span class="type">GidHandle</span>.get site.s_clock_cache ck
    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">get_clock_domain</span><span class="variable-name"> site ck </span><span class="tuareg-font-lock-operator">=</span>
      <span class="keyword">try</span>
        <span class="type">C</span>.<span class="type">GidMap</span>.find ck.ck_gid site.s_clock_domains
      <span class="keyword">with</span>
        <span class="tuareg-font-lock-operator">|</span> Not_found <span class="tuareg-font-lock-operator">-&gt;</span>
            IFDEF RML_DEBUG THEN
              print_debug <span class="string">"Error: Cannot find clock domain %a@."</span> <span class="type">C</span>.print_gid ck.ck_gid
            ELSE <span class="tuareg-font-lock-operator">()</span> END<span class="tuareg-font-lock-operator">;</span>
            <span class="keyword">assert</span> <span class="constant">false</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">get_event</span><span class="variable-name"> site ev </span><span class="tuareg-font-lock-operator">=</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">n</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> _</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> _</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> _ </span><span class="tuareg-font-lock-operator">=</span>  <span class="type">SignalHandle</span>.get site.s_signal_cache ev.ev_handle <span class="tuareg-font-lock-governing">in</span>
      n
    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">get_event_clock</span><span class="variable-name"> site ev </span><span class="tuareg-font-lock-operator">=</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">_</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> ck</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> _</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> _ </span><span class="tuareg-font-lock-operator">=</span> <span class="type">SignalHandle</span>.get site.s_signal_cache ev.ev_handle <span class="tuareg-font-lock-governing">in</span>
      ck
    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">get_event_region</span><span class="variable-name"> site ev </span><span class="tuareg-font-lock-operator">=</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">_</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> _</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> r</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> _ </span><span class="tuareg-font-lock-operator">=</span> <span class="type">SignalHandle</span>.get site.s_signal_cache ev.ev_handle <span class="tuareg-font-lock-governing">in</span>
      r
    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">get_event_reset</span><span class="variable-name"> site ev </span><span class="tuareg-font-lock-operator">=</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">_</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> _</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> _</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> reset </span><span class="tuareg-font-lock-operator">=</span> <span class="type">SignalHandle</span>.get site.s_signal_cache ev.ev_handle <span class="tuareg-font-lock-governing">in</span>
      reset
    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">get_event_whole</span><span class="variable-name"> site ev </span><span class="tuareg-font-lock-operator">=</span>
      <span class="type">SignalHandle</span>.get site.s_signal_cache ev.ev_handle

    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">process_msgs</span><span class="variable-name"> site </span><span class="tuareg-font-lock-operator">()</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span>
      <span class="type">C</span>.flush <span class="tuareg-font-lock-operator">();</span>
      <span class="type">Callbacks</span>.await_new_msg site.s_msg_queue<span class="tuareg-font-lock-operator">;</span>
      <span class="type">Callbacks</span>.dispatch_all site.s_msg_queue site.s_callbacks Mresult

    <span class="tuareg-font-lock-governing">module</span> <span class="type">Msgs </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-governing">struct</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="function-name">mk_send_recv</span><span class="variable-name"> tag </span><span class="tuareg-font-lock-operator">=</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="function-name">send</span><span class="variable-name"> site </span><span class="tuareg-font-lock-operator">(</span><span class="variable-name">d</span><span class="tuareg-font-lock-operator">:'</span><span class="type">a</span><span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">=</span> <span class="type">C</span>.send site tag d <span class="tuareg-font-lock-governing">in</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">recv </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">(</span><span class="type">C</span>.<span class="variable-name">from_msg</span> <span class="tuareg-font-lock-operator">:</span> <span class="type">C.msg </span><span class="tuareg-font-lock-operator">-&gt;</span><span class="type"> </span><span class="tuareg-font-lock-operator">'</span><span class="type">a</span><span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-governing">in</span>
        send<span class="tuareg-font-lock-operator">,</span> recv

      <span class="tuareg-font-lock-governing">let</span> <span class="function-name">mk_broadcast_set_recv</span><span class="variable-name"> tag </span><span class="tuareg-font-lock-operator">=</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="function-name">broadcast</span><span class="variable-name"> s </span><span class="tuareg-font-lock-operator">(</span><span class="variable-name">d</span><span class="tuareg-font-lock-operator">:'</span><span class="type">a</span><span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">=</span> <span class="type">C</span>.broadcast_set s tag d <span class="tuareg-font-lock-governing">in</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">recv </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">(</span><span class="type">C</span>.<span class="variable-name">from_msg</span> <span class="tuareg-font-lock-operator">:</span> <span class="type">C.msg </span><span class="tuareg-font-lock-operator">-&gt;</span><span class="type"> </span><span class="tuareg-font-lock-operator">'</span><span class="type">a</span><span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-governing">in</span>
        broadcast<span class="tuareg-font-lock-operator">,</span> recv

      <span class="tuareg-font-lock-governing">let</span> <span class="function-name">mk_send_owner_recv</span><span class="variable-name"> tag </span><span class="tuareg-font-lock-operator">=</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="function-name">send</span><span class="variable-name"> gid </span><span class="tuareg-font-lock-operator">(</span><span class="variable-name">d</span><span class="tuareg-font-lock-operator">:'</span><span class="type">a</span><span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">=</span> <span class="type">C</span>.send_owner gid tag d <span class="tuareg-font-lock-governing">in</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">recv </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">(</span><span class="type">C</span>.<span class="variable-name">from_msg</span> <span class="tuareg-font-lock-operator">:</span> <span class="type">C.msg </span><span class="tuareg-font-lock-operator">-&gt;</span><span class="type"> </span><span class="tuareg-font-lock-operator">'</span><span class="type">a</span><span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-governing">in</span>
        send<span class="tuareg-font-lock-operator">,</span> recv

      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">broadcast_finalize</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> recv_finalize </span><span class="tuareg-font-lock-operator">=</span> mk_broadcast_set_recv Mfinalize
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">send_finalize_ack</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> recv_finalize_ack </span><span class="tuareg-font-lock-operator">=</span> mk_send_recv Mfinalize_ack
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">send_new_cd</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> recv_new_cd </span><span class="tuareg-font-lock-operator">=</span> mk_send_recv Mnew_cd
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">send_step</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> recv_step </span><span class="tuareg-font-lock-operator">=</span> mk_send_owner_recv Mstep
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">send_step_done</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> recv_step_done </span><span class="tuareg-font-lock-operator">=</span>
        <span class="tuareg-font-lock-operator">(</span><span class="keyword">fun</span> <span class="tuareg-font-lock-operator">()</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">-&gt;</span>
          <span class="tuareg-font-lock-governing">let</span> <span class="function-name">send</span><span class="variable-name"> dest_id id </span><span class="tuareg-font-lock-operator">(</span><span class="variable-name">d</span><span class="tuareg-font-lock-operator">:'</span><span class="type">a</span><span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">=</span> <span class="type">C</span>.send_owner dest_id <span class="tuareg-font-lock-operator">(</span>Mstep_done id<span class="tuareg-font-lock-operator">)</span> d <span class="tuareg-font-lock-governing">in</span>
          <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">recv </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">(</span><span class="type">C</span>.<span class="variable-name">from_msg</span> <span class="tuareg-font-lock-operator">:</span> <span class="type">C.msg </span><span class="tuareg-font-lock-operator">-&gt;</span><span class="type"> </span><span class="tuareg-font-lock-operator">'</span><span class="type">a</span><span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-governing">in</span>
          send<span class="tuareg-font-lock-operator">,</span> recv<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">()</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">broadcast_eoi</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> recv_eoi </span><span class="tuareg-font-lock-operator">=</span> mk_broadcast_set_recv Meoi
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">send_has_next</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> recv_has_next </span><span class="tuareg-font-lock-operator">=</span>
        <span class="tuareg-font-lock-operator">(</span><span class="keyword">fun</span> <span class="tuareg-font-lock-operator">()</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">-&gt;</span>
          <span class="tuareg-font-lock-governing">let</span> <span class="function-name">send</span><span class="variable-name"> id </span><span class="tuareg-font-lock-operator">(</span><span class="variable-name">d</span><span class="tuareg-font-lock-operator">:'</span><span class="type">a</span><span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">=</span> <span class="type">C</span>.send_owner id <span class="tuareg-font-lock-operator">(</span>Mhas_next id<span class="tuareg-font-lock-operator">)</span> d <span class="tuareg-font-lock-governing">in</span>
          <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">recv </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">(</span><span class="type">C</span>.<span class="variable-name">from_msg</span> <span class="tuareg-font-lock-operator">:</span> <span class="type">C.msg </span><span class="tuareg-font-lock-operator">-&gt;</span><span class="type"> </span><span class="tuareg-font-lock-operator">'</span><span class="type">a</span><span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-governing">in</span>
          send<span class="tuareg-font-lock-operator">,</span> recv<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">()</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">send_new_remote</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> recv_new_remote </span><span class="tuareg-font-lock-operator">=</span>
        <span class="tuareg-font-lock-operator">(</span><span class="keyword">fun</span> <span class="tuareg-font-lock-operator">()</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">-&gt;</span>
          <span class="tuareg-font-lock-governing">let</span> <span class="function-name">send</span><span class="variable-name"> id </span><span class="tuareg-font-lock-operator">(</span><span class="variable-name">d</span><span class="tuareg-font-lock-operator">:'</span><span class="type">a</span><span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">=</span> <span class="type">C</span>.send_owner id <span class="tuareg-font-lock-operator">(</span>Mnew_remote id<span class="tuareg-font-lock-operator">)</span> d <span class="tuareg-font-lock-governing">in</span>
          <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">recv </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">(</span><span class="type">C</span>.<span class="variable-name">from_msg</span> <span class="tuareg-font-lock-operator">:</span> <span class="type">C.msg </span><span class="tuareg-font-lock-operator">-&gt;</span><span class="type"> </span><span class="tuareg-font-lock-operator">'</span><span class="type">a</span><span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-governing">in</span>
          send<span class="tuareg-font-lock-operator">,</span> recv<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">()</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">send_req_signal</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> recv_req_signal </span><span class="tuareg-font-lock-operator">=</span>
        <span class="tuareg-font-lock-operator">(</span><span class="keyword">fun</span> <span class="tuareg-font-lock-operator">()</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">-&gt;</span>
          <span class="tuareg-font-lock-governing">let</span> <span class="function-name">send</span><span class="variable-name"> id </span><span class="tuareg-font-lock-operator">(</span><span class="variable-name">d</span><span class="tuareg-font-lock-operator">:'</span><span class="type">a</span><span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">=</span> <span class="type">C</span>.send_owner id <span class="tuareg-font-lock-operator">(</span>Mreq_signal id<span class="tuareg-font-lock-operator">)</span> d <span class="tuareg-font-lock-governing">in</span>
          <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">recv </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">(</span><span class="type">C</span>.<span class="variable-name">from_msg</span> <span class="tuareg-font-lock-operator">:</span> <span class="type">C.msg </span><span class="tuareg-font-lock-operator">-&gt;</span><span class="type"> </span><span class="tuareg-font-lock-operator">'</span><span class="type">a</span><span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-governing">in</span>
          send<span class="tuareg-font-lock-operator">,</span> recv<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">()</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">send_create_signal</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> recv_create_signal </span><span class="tuareg-font-lock-operator">=</span> mk_send_owner_recv Mcreate_signal
    <span class="tuareg-font-lock-governing">end</span>


    <span class="tuareg-font-lock-governing">module</span> <span class="type">Clock </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-governing">struct</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="function-name">equal_clock</span><span class="variable-name"> ck1 ck2 </span><span class="tuareg-font-lock-operator">=</span>
        ck1.ck_gid <span class="tuareg-font-lock-operator">=</span> ck2.ck_gid

      <span class="tuareg-font-lock-governing">let</span> <span class="function-name">mk_clock</span><span class="variable-name"> parent_ck </span><span class="tuareg-font-lock-operator">=</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">site </span><span class="tuareg-font-lock-operator">=</span> get_site <span class="tuareg-font-lock-operator">()</span> <span class="tuareg-font-lock-governing">in</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">gid </span><span class="tuareg-font-lock-operator">=</span> <span class="type">C</span>.fresh site.s_seed <span class="tuareg-font-lock-governing">in</span>
        <span class="tuareg-font-lock-operator">{</span> ck_gid <span class="tuareg-font-lock-operator">=</span> gid<span class="tuareg-font-lock-operator">;</span>
          ck_parent <span class="tuareg-font-lock-operator">=</span> parent_ck<span class="tuareg-font-lock-operator">;</span>
          ck_clock <span class="tuareg-font-lock-operator">=</span> <span class="type">GidHandle</span>.init site.s_clock_cache gid <span class="tuareg-font-lock-operator">(</span><span class="type">E</span>.init_clock <span class="tuareg-font-lock-operator">())</span> <span class="tuareg-font-lock-operator">}</span>

      <span class="tuareg-font-lock-governing">let</span> <span class="tuareg-font-lock-governing">rec</span> <span class="function-name">top_clock</span><span class="variable-name"> ck </span><span class="tuareg-font-lock-operator">=</span> <span class="keyword">match</span> ck.ck_parent <span class="keyword">with</span>
        <span class="tuareg-font-lock-operator">|</span> None <span class="tuareg-font-lock-operator">-&gt;</span> ck
        <span class="tuareg-font-lock-operator">|</span> Some ck <span class="tuareg-font-lock-operator">-&gt;</span> top_clock ck

      <span class="tuareg-font-lock-governing">let</span> <span class="function-name">get_clock_index</span><span class="variable-name"> site ck </span><span class="tuareg-font-lock-operator">=</span>
        <span class="type">E</span>.get <span class="tuareg-font-lock-operator">(</span><span class="type">GidHandle</span>.get site.s_clock_cache ck.ck_clock<span class="tuareg-font-lock-operator">)</span>

      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">empty_clock_state </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">[]</span>

      <span class="doc">(** Returns the current index of ck and all its ancestors *)</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="tuareg-font-lock-governing">rec</span> <span class="function-name">save_clock_state</span><span class="variable-name"> site ck </span><span class="tuareg-font-lock-operator">=</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">l </span><span class="tuareg-font-lock-operator">=</span> <span class="keyword">match</span> ck.ck_parent <span class="keyword">with</span>
          <span class="tuareg-font-lock-operator">|</span> None <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">[]</span>
          <span class="tuareg-font-lock-operator">|</span> Some ck <span class="tuareg-font-lock-operator">-&gt;</span> save_clock_state site ck
        <span class="tuareg-font-lock-governing">in</span>
          <span class="tuareg-font-lock-operator">(</span>ck<span class="tuareg-font-lock-operator">,</span> get_clock_index site ck<span class="tuareg-font-lock-operator">)::</span>l

      <span class="doc">(** [check_clock_state st clock] checks that the index of [clock] saved in
          [st] is the same as its current index. *)</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="function-name">check_clock_state</span><span class="variable-name"> site st clock </span><span class="tuareg-font-lock-operator">=</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="tuareg-font-lock-governing">rec</span> <span class="function-name">check_last_activation</span><span class="variable-name"> l </span><span class="tuareg-font-lock-operator">=</span> <span class="keyword">match</span> l <span class="keyword">with</span>
          <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">[]</span> <span class="tuareg-font-lock-operator">-&gt;</span> <span class="constant">false</span>
          <span class="tuareg-font-lock-operator">|</span> <span class="tuareg-font-lock-operator">(</span>ck<span class="tuareg-font-lock-operator">,</span> saved_idx<span class="tuareg-font-lock-operator">)::</span>l <span class="tuareg-font-lock-operator">-&gt;</span>
              <span class="keyword">if</span> equal_clock ck clock <span class="keyword">then</span>
                <span class="type">E</span>.equal saved_idx <span class="tuareg-font-lock-operator">(</span>get_clock_index site ck<span class="tuareg-font-lock-operator">)</span>
              <span class="keyword">else</span>
                check_last_activation l
        <span class="tuareg-font-lock-governing">in</span>
          check_last_activation st

      <span class="doc">(** [update_clock ck] makes sure that the local copy of ck and
          all its ancestors in the clock tree are equal to the value stored in [ck]
          (which should have been received in a message). *)</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="function-name">update_clock</span><span class="variable-name"> site ck </span><span class="tuareg-font-lock-operator">=</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="tuareg-font-lock-governing">rec</span> <span class="function-name">aux</span><span class="variable-name"> ck </span><span class="tuareg-font-lock-operator">=</span>
          <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">local_ck </span><span class="tuareg-font-lock-operator">=</span> <span class="type">GidHandle</span>.get_local site.s_clock_cache ck.ck_clock <span class="tuareg-font-lock-governing">in</span>
          <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">stored_value </span><span class="tuareg-font-lock-operator">=</span> <span class="type">E</span>.get <span class="tuareg-font-lock-operator">(</span><span class="type">GidHandle</span>.get_stored ck.ck_clock<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-governing">in</span>
          <span class="keyword">if</span> <span class="tuareg-font-lock-operator">not</span> <span class="tuareg-font-lock-operator">(</span><span class="type">E</span>.equal stored_value <span class="tuareg-font-lock-operator">(</span><span class="type">E</span>.get local_ck<span class="tuareg-font-lock-operator">))</span> <span class="keyword">then</span> <span class="tuareg-font-lock-operator">(</span>
            IFDEF RML_DEBUG THEN
              print_debug <span class="string">"Updating value of clock %a from %a to %a@."</span>
                print_clock ck  <span class="type">E</span>.print_clock_index <span class="tuareg-font-lock-operator">(</span><span class="type">E</span>.get local_ck<span class="tuareg-font-lock-operator">)</span>
                <span class="type">E</span>.print_clock_index stored_value
            ELSE <span class="tuareg-font-lock-operator">()</span> END<span class="tuareg-font-lock-operator">;</span>
            <span class="type">E</span>.set local_ck stored_value<span class="tuareg-font-lock-operator">;</span>
            <span class="keyword">match</span> ck.ck_parent <span class="keyword">with</span>
              <span class="tuareg-font-lock-operator">|</span> None <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">()</span>
              <span class="tuareg-font-lock-operator">|</span> Some pck <span class="tuareg-font-lock-operator">-&gt;</span> aux pck
          <span class="tuareg-font-lock-operator">)</span>
        <span class="tuareg-font-lock-governing">in</span>
        aux ck
    <span class="tuareg-font-lock-governing">end</span>


<span class="comment">(**************************************)</span>
<span class="comment">(* control tree                       *)</span>
<span class="comment">(**************************************)</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">new_ctrl</span><span class="variable-name"> kind </span><span class="tuareg-font-lock-operator">=</span>
      <span class="tuareg-font-lock-operator">{</span> kind <span class="tuareg-font-lock-operator">=</span> kind<span class="tuareg-font-lock-operator">;</span>
        alive <span class="tuareg-font-lock-operator">=</span> <span class="constant">true</span><span class="tuareg-font-lock-operator">;</span>
        susp <span class="tuareg-font-lock-operator">=</span> <span class="constant">false</span><span class="tuareg-font-lock-operator">;</span>
        children <span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">[];</span>
        cond_v <span class="tuareg-font-lock-operator">=</span> <span class="constant">false</span><span class="tuareg-font-lock-operator">;</span>
        last_activation <span class="tuareg-font-lock-operator">=</span> <span class="type">Clock</span>.empty_clock_state<span class="tuareg-font-lock-operator">;</span>
        instance <span class="tuareg-font-lock-operator">=</span> 0<span class="tuareg-font-lock-operator">;</span>
        next <span class="tuareg-font-lock-operator">=</span> <span class="type">D</span>.mk_next <span class="tuareg-font-lock-operator">();</span>
        next_control <span class="tuareg-font-lock-operator">=</span> <span class="type">D</span>.mk_next <span class="tuareg-font-lock-operator">()</span> <span class="tuareg-font-lock-operator">}</span>

    <span class="comment">(* tuer un arbre p *)</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="tuareg-font-lock-governing">rec</span> <span class="function-name">set_kill</span><span class="variable-name"> p </span><span class="tuareg-font-lock-operator">=</span>
      p.alive <span class="tuareg-font-lock-operator">&lt;-</span> <span class="constant">true</span><span class="tuareg-font-lock-operator">;</span> <span class="comment">(* set to true, to show that the node is no longer attached to its parent
                       and needs to be reattaced if the node is reused *)</span>
      p.susp <span class="tuareg-font-lock-operator">&lt;-</span> <span class="constant">false</span><span class="tuareg-font-lock-operator">;</span>
      <span class="type">D</span>.clear_next p.next<span class="tuareg-font-lock-operator">;</span>
      <span class="type">List</span>.iter set_kill p.children<span class="tuareg-font-lock-operator">;</span>
      p.children <span class="tuareg-font-lock-operator">&lt;-</span> <span class="tuareg-font-lock-operator">[];</span>
      p.instance <span class="tuareg-font-lock-operator">&lt;-</span> p.instance <span class="tuareg-font-lock-operator">+</span> 1

    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">start_ctrl</span><span class="variable-name"> cd ctrl new_ctrl </span><span class="tuareg-font-lock-operator">=</span>
      new_ctrl.last_activation <span class="tuareg-font-lock-operator">&lt;-</span> <span class="type">Clock</span>.save_clock_state <span class="tuareg-font-lock-operator">(</span>get_site <span class="tuareg-font-lock-operator">())</span> cd.cd_clock<span class="tuareg-font-lock-operator">;</span>
      <span class="keyword">if</span> new_ctrl.alive <span class="keyword">then</span> <span class="tuareg-font-lock-operator">(</span>
        ctrl.children <span class="tuareg-font-lock-operator">&lt;-</span> new_ctrl <span class="tuareg-font-lock-operator">::</span> ctrl.children<span class="tuareg-font-lock-operator">;</span>
        new_ctrl.cond_v <span class="tuareg-font-lock-operator">&lt;-</span> <span class="constant">false</span>
      <span class="tuareg-font-lock-operator">)</span> <span class="keyword">else</span> <span class="comment">(* reset new_ctrl *)</span>
        <span class="tuareg-font-lock-operator">(</span>new_ctrl.alive <span class="tuareg-font-lock-operator">&lt;-</span> <span class="constant">true</span><span class="tuareg-font-lock-operator">;</span>
         new_ctrl.susp <span class="tuareg-font-lock-operator">&lt;-</span> <span class="constant">false</span><span class="tuareg-font-lock-operator">;</span>
         <span class="type">D</span>.clear_next new_ctrl.next<span class="tuareg-font-lock-operator">)</span>

    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">end_ctrl</span><span class="variable-name"> new_ctrl f_k x </span><span class="tuareg-font-lock-operator">=</span>
      set_kill new_ctrl<span class="tuareg-font-lock-operator">;</span>
      new_ctrl.alive <span class="tuareg-font-lock-operator">&lt;-</span> <span class="constant">false</span><span class="tuareg-font-lock-operator">;</span>
      f_k x

<span class="comment">(* calculer le nouvel etat de l'arbre de control *)</span>
<span class="comment">(* et deplacer dans la liste current les processus qui sont dans  *)</span>
<span class="comment">(* les listes next *)</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">eval_control_and_next_to_current</span><span class="variable-name"> site cd </span><span class="tuareg-font-lock-operator">=</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="tuareg-font-lock-governing">rec</span> <span class="function-name">eval</span><span class="variable-name"> pere p active </span><span class="tuareg-font-lock-operator">=</span>
        <span class="keyword">if</span> p.alive <span class="keyword">then</span>
          <span class="keyword">match</span> p.kind <span class="keyword">with</span>
            <span class="tuareg-font-lock-operator">|</span> Clock_domain _ <span class="tuareg-font-lock-operator">-&gt;</span> <span class="constant">true</span>
            <span class="tuareg-font-lock-operator">|</span> Kill f_k <span class="tuareg-font-lock-operator">-&gt;</span>
              <span class="keyword">if</span> p.cond_v
              <span class="keyword">then</span>
                <span class="constant">false</span>
              <span class="keyword">else</span>
                <span class="tuareg-font-lock-operator">(</span>p.children <span class="tuareg-font-lock-operator">&lt;-</span> eval_children p p.children active<span class="tuareg-font-lock-operator">;</span>
                 <span class="keyword">if</span> active <span class="keyword">then</span> next_to_current cd p
                 <span class="keyword">else</span> next_to_father pere p<span class="tuareg-font-lock-operator">;</span>
                 <span class="constant">true</span><span class="tuareg-font-lock-operator">)</span>
          <span class="tuareg-font-lock-operator">|</span> Kill_handler handler <span class="tuareg-font-lock-operator">-&gt;</span>
              <span class="keyword">if</span> p.cond_v
              <span class="keyword">then</span>
                <span class="constant">false</span>
              <span class="keyword">else</span>
                <span class="tuareg-font-lock-operator">(</span>p.children <span class="tuareg-font-lock-operator">&lt;-</span> eval_children p p.children active<span class="tuareg-font-lock-operator">;</span>
                 <span class="keyword">if</span> active <span class="keyword">then</span> next_to_current cd p
                 <span class="keyword">else</span> next_to_father pere p<span class="tuareg-font-lock-operator">;</span>
                 <span class="constant">true</span><span class="tuareg-font-lock-operator">)</span>
          <span class="tuareg-font-lock-operator">|</span> Susp <span class="tuareg-font-lock-operator">-&gt;</span>
              <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">pre_susp </span><span class="tuareg-font-lock-operator">=</span> p.susp <span class="tuareg-font-lock-governing">in</span>
              <span class="keyword">if</span> p.cond_v <span class="keyword">then</span> p.susp <span class="tuareg-font-lock-operator">&lt;-</span> <span class="tuareg-font-lock-operator">not</span> pre_susp<span class="tuareg-font-lock-operator">;</span>
              <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">active </span><span class="tuareg-font-lock-operator">=</span> active <span class="tuareg-font-lock-operator">&amp;&amp;</span> <span class="tuareg-font-lock-operator">not</span> p.susp <span class="tuareg-font-lock-governing">in</span>
              <span class="keyword">if</span> pre_susp
              <span class="keyword">then</span>
                <span class="tuareg-font-lock-operator">(</span><span class="keyword">if</span> active <span class="keyword">then</span> next_to_current cd p<span class="tuareg-font-lock-operator">;</span>
                 <span class="constant">true</span><span class="tuareg-font-lock-operator">)</span>
              <span class="keyword">else</span>
                <span class="tuareg-font-lock-operator">(</span>p.children <span class="tuareg-font-lock-operator">&lt;-</span> eval_children p p.children active<span class="tuareg-font-lock-operator">;</span>
                 <span class="keyword">if</span> active <span class="keyword">then</span> next_to_current cd p
                 <span class="keyword">else</span> <span class="keyword">if</span> <span class="tuareg-font-lock-operator">not</span> p.susp <span class="keyword">then</span> next_to_father pere p<span class="tuareg-font-lock-operator">;</span>
                 <span class="constant">true</span><span class="tuareg-font-lock-operator">)</span>
          <span class="tuareg-font-lock-operator">|</span> When <span class="tuareg-font-lock-operator">-&gt;</span>
              <span class="keyword">if</span> p.susp
              <span class="keyword">then</span> <span class="constant">true</span>
              <span class="keyword">else</span>
                <span class="tuareg-font-lock-operator">(</span>p.susp <span class="tuareg-font-lock-operator">&lt;-</span> <span class="constant">true</span><span class="tuareg-font-lock-operator">;</span>
                 p.children <span class="tuareg-font-lock-operator">&lt;-</span> eval_children p p.children <span class="constant">false</span><span class="tuareg-font-lock-operator">;</span>
                 <span class="constant">true</span><span class="tuareg-font-lock-operator">)</span>
        <span class="keyword">else</span>
          <span class="tuareg-font-lock-operator">(</span>set_kill p<span class="tuareg-font-lock-operator">;</span>
           <span class="constant">false</span><span class="tuareg-font-lock-operator">)</span>

      <span class="tuareg-font-lock-governing">and</span> <span class="function-name">eval_children</span><span class="variable-name"> p nodes active </span><span class="tuareg-font-lock-operator">=</span>
        <span class="type">List</span>.filter <span class="tuareg-font-lock-operator">(</span><span class="keyword">fun</span> <span class="variable-name">node </span><span class="tuareg-font-lock-operator">-&gt;</span> eval p node active<span class="tuareg-font-lock-operator">)</span> nodes

      <span class="tuareg-font-lock-governing">and</span> <span class="function-name">next_to_current</span><span class="variable-name"> cd node </span><span class="tuareg-font-lock-operator">=</span>
        node.last_activation <span class="tuareg-font-lock-operator">&lt;-</span> <span class="type">Clock</span>.save_clock_state site cd.cd_clock<span class="tuareg-font-lock-operator">;</span>
        <span class="type">D</span>.add_current_next node.next cd.cd_current<span class="tuareg-font-lock-operator">;</span>
        <span class="type">D</span>.add_current_next node.next_control cd.cd_current<span class="tuareg-font-lock-operator">;</span>
      <span class="tuareg-font-lock-governing">and</span> <span class="function-name">next_to_father</span><span class="variable-name"> pere node </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">()</span>
       <span class="comment">(* D.add_next_next node.next pere.next;
        D.add_next_next node.next_control pere.next_control
        *)</span>
        <span class="comment">(* TODO: ne marche plus si on veut que last_activation soit correct *)</span>
      <span class="tuareg-font-lock-governing">in</span>
        cd.cd_top.children <span class="tuareg-font-lock-operator">&lt;-</span> eval_children cd.cd_top cd.cd_top.children <span class="constant">true</span><span class="tuareg-font-lock-operator">;</span>
        next_to_current cd cd.cd_top

<span class="comment">(* deplacer dans la liste current les processus qui sont dans  *)</span>
<span class="comment">(* les listes next *)</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="tuareg-font-lock-governing">rec</span> <span class="function-name">next_to_current</span><span class="variable-name"> cd p </span><span class="tuareg-font-lock-operator">=</span>
      <span class="keyword">if</span> p.alive <span class="tuareg-font-lock-operator">&amp;&amp;</span> <span class="tuareg-font-lock-operator">not</span> p.susp <span class="keyword">then</span>
        <span class="tuareg-font-lock-operator">(</span><span class="type">D</span>.add_current_next p.next cd.cd_current<span class="tuareg-font-lock-operator">;</span>
         <span class="type">D</span>.add_current_next p.next_control cd.cd_current<span class="tuareg-font-lock-operator">;</span>
         p.last_activation <span class="tuareg-font-lock-operator">&lt;-</span> <span class="type">Clock</span>.save_clock_state <span class="tuareg-font-lock-operator">(</span>get_site <span class="tuareg-font-lock-operator">())</span> cd.cd_clock<span class="tuareg-font-lock-operator">;</span>
         <span class="type">List</span>.iter <span class="tuareg-font-lock-operator">(</span>next_to_current cd<span class="tuareg-font-lock-operator">)</span> p.children<span class="tuareg-font-lock-operator">)</span>

    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">wake_up_ctrl</span><span class="variable-name"> new_ctrl cd </span><span class="tuareg-font-lock-operator">=</span>
      new_ctrl.susp <span class="tuareg-font-lock-operator">&lt;-</span> <span class="constant">false</span><span class="tuareg-font-lock-operator">;</span>
      next_to_current cd new_ctrl

    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">is_active</span><span class="variable-name"> ctrl </span><span class="tuareg-font-lock-operator">=</span>
      ctrl.alive <span class="tuareg-font-lock-operator">&amp;&amp;</span> <span class="tuareg-font-lock-operator">not</span> ctrl.susp

    <span class="doc">(** clock domains operations *)</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">mk_clock_domain</span><span class="variable-name"> site clock balancer period location parent_ctrl parent_self_id </span><span class="tuareg-font-lock-operator">=</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">cd </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">{</span>
        cd_current <span class="tuareg-font-lock-operator">=</span> <span class="type">D</span>.mk_current <span class="tuareg-font-lock-operator">();</span>
        cd_eoi <span class="tuareg-font-lock-operator">=</span> <span class="constant">false</span><span class="tuareg-font-lock-operator">;</span>
        cd_wake_up <span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">[];</span>
        cd_clock <span class="tuareg-font-lock-operator">=</span> clock<span class="tuareg-font-lock-operator">;</span>
        cd_top <span class="tuareg-font-lock-operator">=</span> new_ctrl <span class="tuareg-font-lock-operator">(</span>Clock_domain <span class="tuareg-font-lock-operator">(</span>Some clock<span class="tuareg-font-lock-operator">));</span>
        cd_parent_ctrl <span class="tuareg-font-lock-operator">=</span> parent_ctrl<span class="tuareg-font-lock-operator">;</span>
        cd_parent_self_id <span class="tuareg-font-lock-operator">=</span> parent_self_id<span class="tuareg-font-lock-operator">;</span>
        cd_children_have_next <span class="tuareg-font-lock-operator">=</span> <span class="constant">false</span><span class="tuareg-font-lock-operator">;</span>
        cd_active_children <span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">ref</span> 0<span class="tuareg-font-lock-operator">;</span>
        cd_last_activation <span class="tuareg-font-lock-operator">=</span> <span class="type">Clock</span>.empty_clock_state<span class="tuareg-font-lock-operator">;</span>
        cd_load_balancer <span class="tuareg-font-lock-operator">=</span> balancer<span class="tuareg-font-lock-operator">;</span>
        cd_location <span class="tuareg-font-lock-operator">=</span> location<span class="tuareg-font-lock-operator">;</span>
        cd_remaining_async <span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">ref</span> 0<span class="tuareg-font-lock-operator">;</span>
        cd_other_remotes <span class="tuareg-font-lock-operator">=</span> <span class="type">C</span>.<span class="type">SiteSet</span>.empty<span class="tuareg-font-lock-operator">;</span>
        cd_direct_remotes <span class="tuareg-font-lock-operator">=</span> <span class="type">C</span>.<span class="type">SiteSet</span>.empty<span class="tuareg-font-lock-operator">;</span>
        cd_counter <span class="tuareg-font-lock-operator">=</span> 0<span class="tuareg-font-lock-operator">;</span>
        cd_period <span class="tuareg-font-lock-operator">=</span> period<span class="tuareg-font-lock-operator">;</span>
        cd_paused <span class="tuareg-font-lock-operator">=</span> <span class="constant">false</span><span class="tuareg-font-lock-operator">;</span>
      <span class="tuareg-font-lock-operator">}</span> <span class="tuareg-font-lock-governing">in</span>
      site.s_clock_domains <span class="tuareg-font-lock-operator">&lt;-</span> <span class="type">C</span>.<span class="type">GidMap</span>.add clock.ck_gid cd site.s_clock_domains<span class="tuareg-font-lock-operator">;</span>
      cd.cd_top.last_activation <span class="tuareg-font-lock-operator">&lt;-</span> <span class="type">Clock</span>.save_clock_state site cd.cd_clock<span class="tuareg-font-lock-operator">;</span>
      cd

    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">is_eoi</span><span class="variable-name"> cd </span><span class="tuareg-font-lock-operator">=</span> cd.cd_eoi
    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">control_tree</span><span class="variable-name"> cd </span><span class="tuareg-font-lock-operator">=</span> cd.cd_top
    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">clock</span><span class="variable-name"> cd </span><span class="tuareg-font-lock-operator">=</span> cd.cd_clock
    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">add_weoi_waiting_list</span><span class="variable-name"> cd wk </span><span class="tuareg-font-lock-operator">=</span>
      cd.cd_wake_up <span class="tuareg-font-lock-operator">&lt;-</span> wk <span class="tuareg-font-lock-operator">::</span> cd.cd_wake_up

    <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">any_clock_ref </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">ref</span> None

   <span class="comment">(* let top_clock cd =
      Clock.top_clock cd.cd_clock *)</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">top_clock</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">()</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span> <span class="keyword">match</span> <span class="tuareg-font-lock-operator">!</span>any_clock_ref <span class="keyword">with</span>
      <span class="tuareg-font-lock-operator">|</span> None <span class="tuareg-font-lock-operator">-&gt;</span> IFDEF RML_DEBUG THEN print_debug <span class="string">"No top clock@."</span> ELSE <span class="tuareg-font-lock-operator">()</span> END<span class="tuareg-font-lock-operator">;</span> <span class="keyword">raise</span> <span class="type">Rml_types</span>.RML
      <span class="tuareg-font-lock-operator">|</span> Some ck <span class="tuareg-font-lock-operator">-&gt;</span> <span class="type">Clock</span>.top_clock ck
    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">mk_clock</span><span class="variable-name"> parent_ck </span><span class="tuareg-font-lock-operator">=</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">ck </span><span class="tuareg-font-lock-operator">=</span> <span class="type">Clock</span>.mk_clock parent_ck <span class="tuareg-font-lock-governing">in</span>
      <span class="keyword">if</span> <span class="tuareg-font-lock-operator">!</span>any_clock_ref <span class="tuareg-font-lock-operator">=</span> None <span class="keyword">then</span>
        any_clock_ref <span class="tuareg-font-lock-operator">:=</span> Some ck<span class="tuareg-font-lock-operator">;</span>
      ck

<span class="comment">(*
    let step_clock_domain ctrl new_ctrl cd new_cd =
      let next_instant_clock_domain _ = next_instant new_cd in
      let rec f_cd () =
        schedule new_cd;
        eoi new_cd;
        if macro_step_done new_cd then (
          add_waiting site (Wnext_instant ck) next_instant_clock_domain;
          D.add_next f_cd ctrl.next_control;
        ) else (
          next_instant new_cd;
          (* execute again in the same step but yield for now*)
          D.add_current f_cd cd.cd_current
        )
      in
      f_cd
        *)</span>

    <span class="comment">(* Computes has_next, waiting for child clock domains if necessary *)</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="tuareg-font-lock-governing">rec</span> <span class="function-name">has_next_cd</span><span class="variable-name"> site cd </span><span class="tuareg-font-lock-operator">=</span>
      IFDEF RML_DEBUG THEN
        print_debug <span class="string">"Before Waiting: %d@."</span> <span class="tuareg-font-lock-operator">!(</span>cd.cd_remaining_async<span class="tuareg-font-lock-operator">)</span>
      ELSE <span class="tuareg-font-lock-operator">()</span> END<span class="tuareg-font-lock-operator">;</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">has_next_ctrl </span><span class="tuareg-font-lock-operator">=</span> has_next_children site cd cd.cd_top <span class="tuareg-font-lock-governing">in</span>
      <span class="comment">(* Awaits Mhas_next from all remote clock domains *)</span>
      <span class="type">C</span>.flush <span class="tuareg-font-lock-operator">();</span>
      <span class="keyword">while</span> <span class="tuareg-font-lock-operator">!(</span>cd.cd_remaining_async<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">&gt;</span> 0 <span class="keyword">do</span>
        IFDEF RML_DEBUG THEN
          print_debug <span class="string">"Waiting for %d has_next msgs@."</span> <span class="tuareg-font-lock-operator">!(</span>cd.cd_remaining_async<span class="tuareg-font-lock-operator">)</span>
        ELSE <span class="tuareg-font-lock-operator">()</span> END<span class="tuareg-font-lock-operator">;</span>
        <span class="type">Callbacks</span>.dispatch_given_msg site.s_msg_queue site.s_callbacks <span class="tuareg-font-lock-operator">(</span>Mhas_next cd.cd_clock.ck_gid<span class="tuareg-font-lock-operator">)</span>
      <span class="keyword">done</span><span class="tuareg-font-lock-operator">;</span>
      IFDEF RML_DEBUG THEN
        print_debug <span class="string">"has_next of %a: has_next_children=%b, self=%b@."</span>
          print_cd cd cd.cd_children_have_next has_next_ctrl
      ELSE <span class="tuareg-font-lock-operator">()</span> END<span class="tuareg-font-lock-operator">;</span>
      has_next_ctrl <span class="tuareg-font-lock-operator">||</span> cd.cd_children_have_next
    <span class="tuareg-font-lock-governing">and</span> <span class="function-name">has_next</span><span class="variable-name"> site cd ctrl </span><span class="tuareg-font-lock-operator">=</span>
      <span class="keyword">if</span> <span class="tuareg-font-lock-operator">not</span> ctrl.alive <span class="keyword">then</span>
        <span class="constant">false</span>
      <span class="keyword">else</span>
        <span class="keyword">match</span> ctrl.kind <span class="keyword">with</span>
          <span class="tuareg-font-lock-operator">|</span> Clock_domain None <span class="tuareg-font-lock-operator">-&gt;</span> <span class="constant">false</span> <span class="comment">(* waiting for a Mhas_next message from this clock domain *)</span>
          <span class="tuareg-font-lock-operator">|</span> Clock_domain <span class="tuareg-font-lock-operator">(</span>Some ck<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">-&gt;</span>
              <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">cd </span><span class="tuareg-font-lock-operator">=</span> get_clock_domain site ck <span class="tuareg-font-lock-governing">in</span>
              has_next_cd site cd
          <span class="tuareg-font-lock-operator">|</span> Kill _ <span class="tuareg-font-lock-operator">|</span> Kill_handler _ <span class="tuareg-font-lock-operator">-&gt;</span>
            ctrl.cond_v <span class="tuareg-font-lock-operator">||</span> has_next_children site cd ctrl
          <span class="tuareg-font-lock-operator">|</span> Susp <span class="tuareg-font-lock-operator">-&gt;</span>
            <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">active </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">(</span>ctrl.susp <span class="tuareg-font-lock-operator">&amp;&amp;</span> ctrl.cond_v<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">||</span> <span class="tuareg-font-lock-operator">(not</span> ctrl.susp <span class="tuareg-font-lock-operator">&amp;&amp;</span> <span class="tuareg-font-lock-operator">not</span> <span class="tuareg-font-lock-operator">(</span>ctrl.cond_v<span class="tuareg-font-lock-operator">))</span> <span class="tuareg-font-lock-governing">in</span>
              active <span class="tuareg-font-lock-operator">&amp;&amp;</span> has_next_children site cd ctrl
          <span class="tuareg-font-lock-operator">|</span> When <span class="tuareg-font-lock-operator">-&gt;</span>
            <span class="tuareg-font-lock-operator">not</span> ctrl.susp <span class="tuareg-font-lock-operator">&amp;&amp;</span> has_next_children site cd ctrl
    <span class="tuareg-font-lock-governing">and</span> <span class="function-name">has_next_children</span><span class="variable-name"> site cd ctrl </span><span class="tuareg-font-lock-operator">=</span>
      <span class="tuareg-font-lock-operator">not</span> <span class="tuareg-font-lock-operator">(</span><span class="type">D</span>.is_empty_next ctrl.next<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">||</span> <span class="type">List</span>.exists <span class="tuareg-font-lock-operator">(</span>has_next site cd<span class="tuareg-font-lock-operator">)</span> ctrl.children

    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">prepare_has_next</span><span class="variable-name"> cd _ </span><span class="tuareg-font-lock-operator">=</span>
      <span class="comment">(* the top clock domain does not receive Mhas_next msgs*)</span>
      <span class="keyword">if</span> cd.cd_clock.ck_parent <span class="tuareg-font-lock-operator">&lt;&gt;</span> None <span class="keyword">then</span> <span class="tuareg-font-lock-operator">(</span>
        IFDEF RML_DEBUG THEN
          <span class="keyword">if</span> cd.cd_children_have_next <span class="tuareg-font-lock-operator">=</span> <span class="constant">true</span> <span class="keyword">then</span>
            print_debug <span class="string">"have_next_children of %a is already true@."</span> print_cd cd<span class="tuareg-font-lock-operator">;</span>
          print_debug <span class="string">"Waiting for %d Mhas_next msgs@."</span> <span class="tuareg-font-lock-operator">!(</span>cd.cd_active_children<span class="tuareg-font-lock-operator">)</span>
        ELSE <span class="tuareg-font-lock-operator">()</span> END<span class="tuareg-font-lock-operator">;</span>
        cd.cd_children_have_next <span class="tuareg-font-lock-operator">&lt;-</span> <span class="constant">false</span><span class="tuareg-font-lock-operator">;</span>
        cd.cd_remaining_async <span class="tuareg-font-lock-operator">:=</span> <span class="tuareg-font-lock-operator">!(</span>cd.cd_remaining_async<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">+</span> <span class="tuareg-font-lock-operator">!(</span>cd.cd_active_children<span class="tuareg-font-lock-operator">)</span>
      <span class="tuareg-font-lock-operator">)</span>

    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">send_has_next</span><span class="variable-name"> site cd _ </span><span class="tuareg-font-lock-operator">=</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">pck </span><span class="tuareg-font-lock-operator">=</span> assert_some cd.cd_clock.ck_parent <span class="tuareg-font-lock-governing">in</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">has_next </span><span class="tuareg-font-lock-operator">=</span> has_next_cd site cd <span class="tuareg-font-lock-governing">in</span>
      IFDEF RML_DEBUG THEN
        print_debug <span class="string">"send_has_next=%b from %a to %a@."</span> has_next  print_cd cd  print_clock pck
      ELSE <span class="tuareg-font-lock-operator">()</span> END<span class="tuareg-font-lock-operator">;</span>
      <span class="type">Msgs</span>.send_has_next pck.ck_gid has_next

    <span class="comment">(* Register a handler to send Has_next msg to paremt clock for each
       ancestor clock that is not local*)</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">register_send_has_next</span><span class="variable-name"> site cd pck </span><span class="tuareg-font-lock-operator">=</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="tuareg-font-lock-governing">rec</span> <span class="function-name">aux</span><span class="variable-name"> ck </span><span class="tuareg-font-lock-operator">=</span> <span class="keyword">match</span> ck.ck_parent <span class="keyword">with</span>
        <span class="tuareg-font-lock-operator">|</span> None <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">()</span> <span class="comment">(* top ck, do nothing*)</span>
        <span class="tuareg-font-lock-operator">|</span> Some pck <span class="tuareg-font-lock-operator">-&gt;</span>
            <span class="comment">(* make sure to register only once per instant of ck *)</span>
            <span class="keyword">if</span> <span class="tuareg-font-lock-operator">not</span> <span class="tuareg-font-lock-operator">(</span><span class="type">C</span>.is_local ck.ck_gid<span class="tuareg-font-lock-operator">)</span>
              <span class="tuareg-font-lock-operator">&amp;&amp;</span> <span class="tuareg-font-lock-operator">not</span> <span class="tuareg-font-lock-operator">(</span><span class="type">Clock</span>.check_clock_state site cd.cd_last_activation ck<span class="tuareg-font-lock-operator">)</span> <span class="keyword">then</span>
              add_waiting site <span class="tuareg-font-lock-operator">(</span>Wafter_eoi ck.ck_gid<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>send_has_next site cd<span class="tuareg-font-lock-operator">);</span>
            aux pck
      <span class="tuareg-font-lock-governing">in</span>
      aux pck

    <span class="comment">(* Register a handler that prepares for receiving has_next msgs from children
       for all ancestor clocks (except topck) *)</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">register_prepare_has_next</span><span class="variable-name"> site cd pck </span><span class="tuareg-font-lock-operator">=</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="tuareg-font-lock-governing">rec</span> <span class="function-name">aux</span><span class="variable-name"> ck </span><span class="tuareg-font-lock-operator">=</span> <span class="keyword">match</span> ck.ck_parent <span class="keyword">with</span>
        <span class="tuareg-font-lock-operator">|</span> None <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">()</span> <span class="comment">(* top ck, do nothing*)</span>
        <span class="tuareg-font-lock-operator">|</span> Some pck <span class="tuareg-font-lock-operator">-&gt;</span>
            <span class="comment">(* make sure to register only once per instant of ck *)</span>
            <span class="keyword">if</span> <span class="tuareg-font-lock-operator">not</span> <span class="tuareg-font-lock-operator">(</span><span class="type">Clock</span>.check_clock_state site cd.cd_last_activation ck<span class="tuareg-font-lock-operator">)</span> <span class="keyword">then</span>
              add_waiting site <span class="tuareg-font-lock-operator">(</span>Wbefore_eoi ck.ck_gid<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>prepare_has_next cd<span class="tuareg-font-lock-operator">);</span>
            aux pck
      <span class="tuareg-font-lock-governing">in</span>
      aux pck

    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">register_has_next_handlers</span><span class="variable-name"> site cd pck </span><span class="tuareg-font-lock-operator">=</span>
      <span class="comment">(* if parent is not local, we will send has_next msgs *)</span>
      <span class="keyword">if</span> <span class="tuareg-font-lock-operator">not</span> <span class="tuareg-font-lock-operator">(</span><span class="type">C</span>.is_local pck.ck_gid<span class="tuareg-font-lock-operator">)</span> <span class="keyword">then</span>
        register_send_has_next site cd pck<span class="tuareg-font-lock-operator">;</span>
      <span class="comment">(* if we have remote cds, we will receive has_next msgs *)</span>
      <span class="keyword">if</span> <span class="tuareg-font-lock-operator">!(</span>cd.cd_active_children<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">&gt;</span> 0 <span class="keyword">then</span>
        register_prepare_has_next site cd pck<span class="tuareg-font-lock-operator">;</span>
      <span class="comment">(* remember when we last registered has_next handlers *)</span>
      cd.cd_last_activation <span class="tuareg-font-lock-operator">&lt;-</span> <span class="type">Clock</span>.save_clock_state site cd.cd_clock

    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">macro_step_done</span><span class="variable-name"> site cd </span><span class="tuareg-font-lock-operator">=</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">has_next </span><span class="tuareg-font-lock-operator">=</span> has_next_cd site cd <span class="tuareg-font-lock-governing">in</span>
      IFDEF RML_DEBUG THEN
        print_debug <span class="string">"Macro step of clock domain %a: has_next = %b@."</span>
          print_cd cd  has_next
      ELSE <span class="tuareg-font-lock-operator">()</span> END<span class="tuareg-font-lock-operator">;</span>
      <span class="tuareg-font-lock-operator">not</span> has_next

    <span class="tuareg-font-lock-governing">let</span> <span class="tuareg-font-lock-governing">rec</span> <span class="function-name">schedule</span><span class="variable-name"> cd </span><span class="tuareg-font-lock-operator">=</span> <span class="type">D</span>.exec_all_current cd.cd_current

    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">eoi</span><span class="variable-name"> site cd </span><span class="tuareg-font-lock-operator">=</span>
      IFDEF RML_DEBUG THEN
        print_debug <span class="string">"Eoi of clock domain %a@."</span> print_cd cd
      ELSE <span class="tuareg-font-lock-operator">()</span> END<span class="tuareg-font-lock-operator">;</span>
      wake_up_now site <span class="tuareg-font-lock-operator">(</span>Wbefore_eoi cd.cd_clock.ck_gid<span class="tuareg-font-lock-operator">);</span>
      cd.cd_eoi <span class="tuareg-font-lock-operator">&lt;-</span> <span class="constant">true</span><span class="tuareg-font-lock-operator">;</span>
      wake_up_now site <span class="tuareg-font-lock-operator">(</span>Weoi cd.cd_clock.ck_gid<span class="tuareg-font-lock-operator">);</span>
      prepare_has_next cd <span class="tuareg-font-lock-operator">();</span>
      <span class="comment">(* send Meoi only to direct children *)</span>
      <span class="type">Msgs</span>.broadcast_eoi cd.cd_direct_remotes cd.cd_clock.ck_gid<span class="tuareg-font-lock-operator">;</span>
      <span class="type">List</span>.iter <span class="tuareg-font-lock-operator">(</span>wake_up_now site<span class="tuareg-font-lock-operator">)</span> cd.cd_wake_up<span class="tuareg-font-lock-operator">;</span>
      cd.cd_wake_up <span class="tuareg-font-lock-operator">&lt;-</span> <span class="tuareg-font-lock-operator">[]</span>

    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">next_instant</span><span class="variable-name"> site cd </span><span class="tuareg-font-lock-operator">=</span>
      IFDEF RML_DEBUG THEN
        print_debug <span class="string">"Next instant of clock domain %a@."</span> print_cd cd
      ELSE <span class="tuareg-font-lock-operator">()</span> END<span class="tuareg-font-lock-operator">;</span>
      <span class="type">E</span>.next <span class="tuareg-font-lock-operator">(</span>get_clock site cd.cd_clock.ck_clock<span class="tuareg-font-lock-operator">);</span>
      wake_up_now site <span class="tuareg-font-lock-operator">(</span>Wnext_instant cd.cd_clock.ck_gid<span class="tuareg-font-lock-operator">);</span>
      <span class="comment">(* next instant of this clock domain *)</span>
      eval_control_and_next_to_current site cd<span class="tuareg-font-lock-operator">;</span>
      <span class="comment">(* reset the clock domain *)</span>
      cd.cd_eoi <span class="tuareg-font-lock-operator">&lt;-</span> <span class="constant">false</span><span class="tuareg-font-lock-operator">;</span>
      cd.cd_children_have_next <span class="tuareg-font-lock-operator">&lt;-</span> <span class="constant">false</span><span class="tuareg-font-lock-operator">;</span>
      cd.cd_active_children <span class="tuareg-font-lock-operator">:=</span> 0

    <span class="tuareg-font-lock-governing">let</span> <span class="tuareg-font-lock-governing">rec</span> <span class="function-name">exec_cd</span><span class="variable-name"> site cd </span><span class="tuareg-font-lock-operator">()</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span>
      IFDEF RML_DEBUG THEN
        print_debug <span class="string">"Executing clock domain %a@."</span> print_cd cd
      ELSE <span class="tuareg-font-lock-operator">()</span> END<span class="tuareg-font-lock-operator">;</span>
      schedule cd<span class="tuareg-font-lock-operator">;</span>
      <span class="keyword">if</span> <span class="tuareg-font-lock-operator">not</span> cd.cd_paused <span class="keyword">then</span>
        <span class="tuareg-font-lock-governing">begin</span>
          cd.cd_counter <span class="tuareg-font-lock-operator">&lt;-</span> cd.cd_counter <span class="tuareg-font-lock-operator">+</span> 1<span class="tuareg-font-lock-operator">;</span>
          <span class="keyword">if</span> cd.cd_top.alive <span class="keyword">then</span> <span class="tuareg-font-lock-operator">(</span>
            <span class="keyword">if</span> <span class="tuareg-font-lock-operator">!(</span>cd.cd_remaining_async<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">=</span> 0 <span class="keyword">then</span> <span class="tuareg-font-lock-operator">(</span>
              eoi site cd<span class="tuareg-font-lock-operator">;</span>
              <span class="keyword">match</span> cd.cd_clock.ck_parent <span class="keyword">with</span>
                <span class="tuareg-font-lock-operator">|</span> None <span class="tuareg-font-lock-operator">-&gt;</span> <span class="comment">(* top clock domain *)</span>
                  next_instant site cd
            <span class="comment">(*Format.eprintf "Top clock domain next_instnt done : %d@." !(cd.cd_remaining_async)*)</span>
                <span class="tuareg-font-lock-operator">|</span> Some ck <span class="tuareg-font-lock-operator">-&gt;</span>
                  <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">is_done </span><span class="tuareg-font-lock-operator">=</span> macro_step_done site cd <span class="tuareg-font-lock-governing">in</span>
                  <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">period_finished </span><span class="tuareg-font-lock-operator">=</span> <span class="keyword">match</span> cd.cd_period <span class="keyword">with</span>
                    <span class="tuareg-font-lock-operator">|</span> None <span class="tuareg-font-lock-operator">-&gt;</span> <span class="constant">false</span>
                    <span class="tuareg-font-lock-operator">|</span> Some p <span class="tuareg-font-lock-operator">-&gt;</span> cd.cd_counter <span class="tuareg-font-lock-operator">&gt;=</span> p
                  <span class="tuareg-font-lock-governing">in</span>
                  <span class="keyword">if</span> is_done <span class="tuareg-font-lock-operator">||</span> period_finished <span class="keyword">then</span> <span class="tuareg-font-lock-operator">(</span>
                    cd.cd_counter <span class="tuareg-font-lock-operator">&lt;-</span> 0<span class="tuareg-font-lock-operator">;</span>
                    IFDEF RML_DEBUG THEN
                      print_debug <span class="string">"Macro step of clock domain %a is done@."</span> print_cd cd
                      ELSE <span class="tuareg-font-lock-operator">()</span> END<span class="tuareg-font-lock-operator">;</span>
                    add_waiting site <span class="tuareg-font-lock-operator">(</span>Wnext_instant ck.ck_gid<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span><span class="keyword">fun</span> <span class="tuareg-font-lock-operator">()</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">-&gt;</span> next_instant site cd<span class="tuareg-font-lock-operator">);</span>
                  <span class="comment">(* register handlers for sending and receiving Mhas_next msgs *)</span>
                    register_has_next_handlers site cd ck<span class="tuareg-font-lock-operator">;</span>
                  <span class="comment">(* if the parent clock is not here, send Done message*)</span>
                    <span class="keyword">if</span> <span class="tuareg-font-lock-operator">not</span> <span class="tuareg-font-lock-operator">(</span><span class="type">C</span>.is_local ck.ck_gid<span class="tuareg-font-lock-operator">)</span> <span class="keyword">then</span> <span class="tuareg-font-lock-operator">(</span>
                      <span class="type">Msgs</span>.send_step_done ck.ck_gid <span class="tuareg-font-lock-operator">(</span>assert_some cd.cd_parent_self_id<span class="tuareg-font-lock-operator">)</span> cd.cd_clock.ck_gid
                    <span class="tuareg-font-lock-operator">)</span> <span class="keyword">else</span> <span class="tuareg-font-lock-operator">(</span>
                      <span class="tuareg-font-lock-operator">(</span><span class="keyword">match</span> cd.cd_parent_ctrl <span class="keyword">with</span>
                        <span class="tuareg-font-lock-operator">|</span> None <span class="tuareg-font-lock-operator">-&gt;</span> <span class="keyword">assert</span> <span class="constant">false</span>
                        <span class="tuareg-font-lock-operator">|</span> Some ctrl <span class="tuareg-font-lock-operator">-&gt;</span> <span class="type">D</span>.add_next <span class="tuareg-font-lock-operator">(</span>exec_cd site cd<span class="tuareg-font-lock-operator">)</span> ctrl.next_control<span class="tuareg-font-lock-operator">)</span>
                    <span class="tuareg-font-lock-operator">)</span>
                  <span class="tuareg-font-lock-operator">)</span> <span class="keyword">else</span> <span class="tuareg-font-lock-operator">(</span>
                    next_instant site cd<span class="tuareg-font-lock-operator">;</span>
                  <span class="comment">(* do another step*)</span>
                    exec_cd site cd <span class="tuareg-font-lock-operator">()</span>
                  <span class="tuareg-font-lock-operator">)</span>
            <span class="tuareg-font-lock-operator">)</span> <span class="keyword">else</span>
              <span class="keyword">match</span> cd.cd_clock.ck_parent <span class="keyword">with</span>
                <span class="tuareg-font-lock-operator">|</span> None <span class="tuareg-font-lock-operator">-&gt;</span> <span class="comment">(* top clock, wait for msgs *)</span>
                  IFDEF RML_DEBUG THEN
                    print_debug <span class="string">"Top clock domain %a is waiting for %d children@."</span>
                    print_cd cd  <span class="tuareg-font-lock-operator">!(</span>cd.cd_remaining_async<span class="tuareg-font-lock-operator">)</span>
                    ELSE <span class="tuareg-font-lock-operator">()</span> END<span class="tuareg-font-lock-operator">;</span>
                  ignore <span class="tuareg-font-lock-operator">(</span>process_msgs site <span class="tuareg-font-lock-operator">());</span>
                  exec_cd site cd <span class="tuareg-font-lock-operator">()</span>
                <span class="tuareg-font-lock-operator">|</span> Some ck <span class="tuareg-font-lock-operator">-&gt;</span>
                <span class="comment">(* parent is local, increment its async counter before returning *)</span>
                  <span class="keyword">if</span> <span class="type">C</span>.is_local ck.ck_gid <span class="keyword">then</span> <span class="tuareg-font-lock-operator">(</span>
                    <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">parent_cd </span><span class="tuareg-font-lock-operator">=</span> get_clock_domain site ck <span class="tuareg-font-lock-governing">in</span>
                    incr parent_cd.cd_remaining_async
                  <span class="tuareg-font-lock-operator">);</span>
                  IFDEF RML_DEBUG THEN
                    print_debug <span class="string">"Execution of clock domain %a is suspended until a message is received@."</span>
                    print_cd cd
                    ELSE <span class="tuareg-font-lock-operator">()</span> END
          <span class="tuareg-font-lock-operator">)</span> <span class="keyword">else</span>
            IFDEF RML_DEBUG THEN
              print_debug <span class="string">"Clock domain %a is dead@."</span> print_cd cd
              ELSE <span class="tuareg-font-lock-operator">()</span> END
        <span class="tuareg-font-lock-governing">end</span>
<span class="comment">(*
    let rec react cd =
      exec_cd cd ();
      Format.eprintf "Exec of cd %a done with rem: %d @." C.print_gid cd.cd_clock.ck_gid !(cd.cd_remaining_async);
      if cd.cd_top.alive &amp;&amp; !(cd.cd_remaining_async) &lt;&gt; 0 then (
        Format.eprintf "Waitinf for children to finish@.";
        process_msgs ();
        react cd
      )
*)</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">set_paused</span><span class="variable-name"> cd v </span><span class="tuareg-font-lock-operator">=</span>
      cd.cd_paused <span class="tuareg-font-lock-operator">&lt;-</span> <span class="constant">true</span><span class="tuareg-font-lock-operator">;</span>
      <span class="type">C</span>.broadcast Mresult v

    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">react</span><span class="variable-name"> cd </span><span class="tuareg-font-lock-operator">=</span>
      cd.cd_paused <span class="tuareg-font-lock-operator">&lt;-</span> <span class="constant">false</span><span class="tuareg-font-lock-operator">;</span>
      exec_cd <span class="tuareg-font-lock-operator">(</span>get_site <span class="tuareg-font-lock-operator">())</span> cd <span class="tuareg-font-lock-operator">()</span>

    <span class="comment">(* After receiving Mhas_next *)</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">gather_has_next</span><span class="variable-name"> cd msg </span><span class="tuareg-font-lock-operator">=</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">has_next</span><span class="tuareg-font-lock-operator">:</span><span class="type">bool </span><span class="tuareg-font-lock-operator">=</span> <span class="type">Msgs</span>.recv_has_next msg <span class="tuareg-font-lock-governing">in</span>
      decr cd.cd_remaining_async<span class="tuareg-font-lock-operator">;</span>
      IFDEF RML_DEBUG THEN
        print_debug <span class="string">"--%a@."</span> print_cd cd<span class="tuareg-font-lock-operator">;</span>
        <span class="keyword">if</span> <span class="tuareg-font-lock-operator">!(</span>cd.cd_remaining_async<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">&lt;</span> 0 <span class="keyword">then</span>
          print_debug <span class="string">"Error: counter of %a is &lt; 0@."</span> print_cd cd<span class="tuareg-font-lock-operator">;</span>
        print_debug <span class="string">"Received has_next=%b for %a@."</span> has_next print_cd cd
      ELSE <span class="tuareg-font-lock-operator">()</span> END<span class="tuareg-font-lock-operator">;</span>
      cd.cd_children_have_next <span class="tuareg-font-lock-operator">&lt;-</span> has_next <span class="tuareg-font-lock-operator">or</span> cd.cd_children_have_next

    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">step_remote_clock_domain</span><span class="variable-name"> cd ck_id </span><span class="tuareg-font-lock-operator">()</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span>
      IFDEF RML_DEBUG THEN print_debug <span class="string">"++%a@."</span> print_cd cd ELSE <span class="tuareg-font-lock-operator">()</span> END<span class="tuareg-font-lock-operator">;</span>
      incr cd.cd_remaining_async<span class="tuareg-font-lock-operator">;</span>
      <span class="type">Msgs</span>.send_step ck_id <span class="tuareg-font-lock-operator">(</span>cd.cd_clock<span class="tuareg-font-lock-operator">,</span> ck_id<span class="tuareg-font-lock-operator">)</span>

    <span class="tuareg-font-lock-governing">let</span> <span class="tuareg-font-lock-governing">rec</span> <span class="function-name">wake_up_cd_if_done</span><span class="variable-name"> site cd </span><span class="tuareg-font-lock-operator">=</span>
      <span class="keyword">if</span> <span class="tuareg-font-lock-operator">!(</span>cd.cd_remaining_async<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">=</span> 0 <span class="keyword">then</span> <span class="tuareg-font-lock-operator">(</span>
        <span class="keyword">match</span> cd.cd_clock.ck_parent <span class="keyword">with</span>
          <span class="tuareg-font-lock-operator">|</span> None <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">()</span> <span class="comment">(* the cd is already executing, waiting for messages *)</span>
          <span class="tuareg-font-lock-operator">|</span> Some ck <span class="tuareg-font-lock-operator">-&gt;</span>
              IFDEF RML_DEBUG THEN
                print_debug <span class="string">"Waking up clock domain %a after receiving a message@."</span> print_cd cd
              ELSE <span class="tuareg-font-lock-operator">()</span> END<span class="tuareg-font-lock-operator">;</span>
              <span class="keyword">if</span> <span class="type">C</span>.is_local ck.ck_gid <span class="keyword">then</span> <span class="tuareg-font-lock-operator">(</span>
                <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">parent_cd </span><span class="tuareg-font-lock-operator">=</span> get_clock_domain site ck <span class="tuareg-font-lock-governing">in</span>
                exec_cd site cd <span class="tuareg-font-lock-operator">();</span>
                IFDEF RML_DEBUG THEN print_debug <span class="string">"--%a@."</span> print_cd parent_cd ELSE <span class="tuareg-font-lock-operator">()</span> END<span class="tuareg-font-lock-operator">;</span>
                decr parent_cd.cd_remaining_async<span class="tuareg-font-lock-operator">;</span>
                IFDEF RML_DEBUG THEN
                  <span class="keyword">if</span> <span class="tuareg-font-lock-operator">!(</span>parent_cd.cd_remaining_async<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">&lt;</span> 0 <span class="keyword">then</span>
                    print_debug <span class="string">"Error: counter of %a is &lt; 0@."</span> print_cd parent_cd
                ELSE <span class="tuareg-font-lock-operator">()</span> END<span class="tuareg-font-lock-operator">;</span>
                wake_up_cd_if_done site parent_cd
              <span class="tuareg-font-lock-operator">)</span> <span class="keyword">else</span>
                exec_cd site cd <span class="tuareg-font-lock-operator">()</span>
      <span class="tuareg-font-lock-operator">)</span>

    <span class="comment">(* After receving Mstep_done*)</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">receive_step_done</span><span class="variable-name"> site cd ctrl msg </span><span class="tuareg-font-lock-operator">=</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">remote_ck_id </span><span class="tuareg-font-lock-operator">=</span> <span class="type">Msgs</span>.recv_step_done msg <span class="tuareg-font-lock-governing">in</span>
      <span class="type">D</span>.add_next <span class="tuareg-font-lock-operator">(</span>step_remote_clock_domain cd remote_ck_id<span class="tuareg-font-lock-operator">)</span> ctrl.next_control<span class="tuareg-font-lock-operator">;</span>
      IFDEF RML_DEBUG THEN print_debug <span class="string">"--%a@."</span> print_cd cd ELSE <span class="tuareg-font-lock-operator">()</span> END<span class="tuareg-font-lock-operator">;</span>
      decr cd.cd_remaining_async<span class="tuareg-font-lock-operator">;</span>
      incr cd.cd_active_children<span class="tuareg-font-lock-operator">;</span>
      IFDEF RML_DEBUG THEN
        <span class="keyword">if</span> <span class="tuareg-font-lock-operator">!(</span>cd.cd_remaining_async<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">&lt;</span> 0 <span class="keyword">then</span>
          print_debug <span class="string">"Error: counter of %a is &lt; 0@."</span> print_cd cd
      ELSE <span class="tuareg-font-lock-operator">()</span> END<span class="tuareg-font-lock-operator">;</span>
      <span class="comment">(* wake up cd to emit the done message *)</span>
      wake_up_cd_if_done site cd

    <span class="comment">(* After receiving Mdone *)</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">receive_done_cd</span><span class="variable-name"> site cd new_ctrl </span><span class="tuareg-font-lock-operator">(</span><span class="variable-name">f_k</span> <span class="tuareg-font-lock-operator">:</span> <span class="tuareg-font-lock-operator">'</span><span class="type">a step</span><span class="tuareg-font-lock-operator">)</span> msg <span class="tuareg-font-lock-operator">=</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">x</span><span class="tuareg-font-lock-operator">:'</span><span class="type">a </span><span class="tuareg-font-lock-operator">=</span> <span class="type">C</span>.from_msg msg <span class="tuareg-font-lock-governing">in</span>
      set_kill new_ctrl<span class="tuareg-font-lock-operator">;</span>
      IFDEF RML_DEBUG THEN print_debug <span class="string">"--%a@."</span> print_cd cd ELSE <span class="tuareg-font-lock-operator">()</span> END<span class="tuareg-font-lock-operator">;</span>
      decr cd.cd_remaining_async<span class="tuareg-font-lock-operator">;</span>
      IFDEF RML_DEBUG THEN
        <span class="keyword">if</span> <span class="tuareg-font-lock-operator">!(</span>cd.cd_remaining_async<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">&lt;</span> 0 <span class="keyword">then</span>
          print_debug <span class="string">"Error: counter of %a is &lt; 0@."</span> print_cd cd
      ELSE <span class="tuareg-font-lock-operator">()</span> END<span class="tuareg-font-lock-operator">;</span>
      <span class="type">D</span>.add_current <span class="tuareg-font-lock-operator">(</span><span class="keyword">fun</span> <span class="tuareg-font-lock-operator">()</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">-&gt;</span> f_k x<span class="tuareg-font-lock-operator">)</span> cd.cd_current<span class="tuareg-font-lock-operator">;</span>
      <span class="comment">(* wake up cd to emit the done message *)</span>
      wake_up_cd_if_done site cd

    <span class="tuareg-font-lock-governing">let</span> <span class="tuareg-font-lock-governing">rec</span> <span class="function-name">update_remote_set</span><span class="variable-name"> here cd is_direct site </span><span class="tuareg-font-lock-operator">=</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">set </span><span class="tuareg-font-lock-operator">=</span>
        <span class="keyword">if</span> is_direct <span class="keyword">then</span>
          cd.cd_direct_remotes
        <span class="keyword">else</span>
          cd.cd_other_remotes
      <span class="tuareg-font-lock-governing">in</span>
      <span class="keyword">if</span> <span class="tuareg-font-lock-operator">not</span> <span class="tuareg-font-lock-operator">(</span><span class="type">C</span>.<span class="type">SiteSet</span>.mem site set<span class="tuareg-font-lock-operator">)</span> <span class="keyword">then</span> <span class="tuareg-font-lock-operator">(</span>
        <span class="keyword">if</span> <span class="type">C</span>.<span class="type">SiteSet</span>.is_empty cd.cd_direct_remotes <span class="keyword">then</span> <span class="tuareg-font-lock-operator">(</span>
          IFDEF RML_DEBUG THEN
            print_debug <span class="string">"Allocating callbacks for %a@."</span> print_cd cd
          ELSE <span class="tuareg-font-lock-operator">()</span> END<span class="tuareg-font-lock-operator">;</span>
          register_cd_callbacks here cd
        <span class="tuareg-font-lock-operator">);</span>
        IFDEF RML_DEBUG THEN
          print_debug <span class="string">"Adding site %a to remote sites of %a@."</span> <span class="type">C</span>.print_site site  print_cd cd
        ELSE <span class="tuareg-font-lock-operator">()</span> END<span class="tuareg-font-lock-operator">;</span>
        <span class="keyword">if</span> is_direct <span class="keyword">then</span>
          cd.cd_direct_remotes <span class="tuareg-font-lock-operator">&lt;-</span> <span class="type">C</span>.<span class="type">SiteSet</span>.add site cd.cd_direct_remotes
        <span class="keyword">else</span>
          cd.cd_other_remotes <span class="tuareg-font-lock-operator">&lt;-</span> <span class="type">C</span>.<span class="type">SiteSet</span>.add site cd.cd_other_remotes<span class="tuareg-font-lock-operator">;</span>
        <span class="comment">(* add to the site site too *)</span>
        <span class="keyword">if</span> is_direct <span class="keyword">then</span> <span class="tuareg-font-lock-operator">(</span>
          IFDEF RML_DEBUG THEN
            print_debug <span class="string">"Adding site %a to site remotes."</span> <span class="type">C</span>.print_site site
          ELSE <span class="tuareg-font-lock-operator">()</span> END<span class="tuareg-font-lock-operator">;</span>
          here.s_remotes <span class="tuareg-font-lock-operator">&lt;-</span> <span class="type">C</span>.<span class="type">SiteSet</span>.add site here.s_remotes
        <span class="tuareg-font-lock-operator">);</span>
        <span class="comment">(* propagate the information to the parent *)</span>
        <span class="keyword">match</span> cd.cd_clock.ck_parent <span class="keyword">with</span>
          <span class="tuareg-font-lock-operator">|</span> None <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">()</span>
          <span class="tuareg-font-lock-operator">|</span> Some pck <span class="keyword">when</span> <span class="type">C</span>.is_local pck.ck_gid <span class="tuareg-font-lock-operator">-&gt;</span>
              <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">pcd </span><span class="tuareg-font-lock-operator">=</span> get_clock_domain here pck <span class="tuareg-font-lock-governing">in</span>
              update_remote_set here pcd is_direct site
          <span class="tuareg-font-lock-operator">|</span> Some pck <span class="tuareg-font-lock-operator">-&gt;</span> <span class="type">Msgs</span>.send_new_remote pck.ck_gid site
      <span class="tuareg-font-lock-operator">)</span>

    <span class="comment">(* After receiving Mnew_remote *)</span>
    <span class="tuareg-font-lock-governing">and</span> <span class="function-name">receive_new_remote</span><span class="variable-name"> here cd msg </span><span class="tuareg-font-lock-operator">=</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">site </span><span class="tuareg-font-lock-operator">=</span> <span class="type">Msgs</span>.recv_new_remote msg <span class="tuareg-font-lock-governing">in</span>
      update_remote_set here cd <span class="constant">false</span> site

    <span class="comment">(* Registers callbacks for messages sent by child cds *)</span>
    <span class="tuareg-font-lock-governing">and</span> <span class="function-name">register_cd_callbacks</span><span class="variable-name"> site cd </span><span class="tuareg-font-lock-operator">=</span>
      add_callback site <span class="tuareg-font-lock-operator">(</span>Mhas_next cd.cd_clock.ck_gid<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>gather_has_next cd<span class="tuareg-font-lock-operator">);</span>
      add_callback site <span class="tuareg-font-lock-operator">(</span>Mnew_remote cd.cd_clock.ck_gid<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>receive_new_remote site cd<span class="tuareg-font-lock-operator">)</span>

    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">unregister_cd_callbacks</span><span class="variable-name"> site cd </span><span class="tuareg-font-lock-operator">=</span>
      <span class="type">Callbacks</span>.remove_callback <span class="tuareg-font-lock-operator">(</span>Mhas_next cd.cd_clock.ck_gid<span class="tuareg-font-lock-operator">)</span> site.s_callbacks<span class="tuareg-font-lock-operator">;</span>
      <span class="type">Callbacks</span>.remove_callback <span class="tuareg-font-lock-operator">(</span>Mnew_remote cd.cd_clock.ck_gid<span class="tuareg-font-lock-operator">)</span> site.s_callbacks

    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">end_clock_domain</span><span class="variable-name"> site new_cd new_ctrl f_k x </span><span class="tuareg-font-lock-operator">=</span>
      IFDEF RML_DEBUG THEN print_debug <span class="string">"End of clock domain %a@."</span> print_cd new_cd ELSE <span class="tuareg-font-lock-operator">()</span> END<span class="tuareg-font-lock-operator">;</span>
      site.s_clock_domains <span class="tuareg-font-lock-operator">&lt;-</span> <span class="type">C</span>.<span class="type">GidMap</span>.remove new_cd.cd_clock.ck_gid site.s_clock_domains<span class="tuareg-font-lock-operator">;</span>
      unregister_cd_callbacks site new_cd<span class="tuareg-font-lock-operator">;</span>
      end_ctrl new_ctrl f_k x

    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">new_local_clock_domain</span><span class="variable-name"> site cd new_balancer period location ctrl p f_k </span><span class="tuareg-font-lock-operator">=</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">new_ck </span><span class="tuareg-font-lock-operator">=</span> mk_clock <span class="tuareg-font-lock-operator">(</span>Some cd.cd_clock<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-governing">in</span>
      IFDEF RML_DEBUG THEN
        print_debug <span class="string">"Creating local clock domain %a@."</span> <span class="type">C</span>.print_gid new_ck.ck_gid
      ELSE <span class="tuareg-font-lock-operator">()</span> END<span class="tuareg-font-lock-operator">;</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">new_cd </span><span class="tuareg-font-lock-operator">=</span> mk_clock_domain site new_ck new_balancer period location <span class="tuareg-font-lock-operator">(</span>Some ctrl<span class="tuareg-font-lock-operator">)</span> None <span class="tuareg-font-lock-governing">in</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">new_ctrl </span><span class="tuareg-font-lock-operator">=</span> control_tree new_cd <span class="tuareg-font-lock-governing">in</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">f </span><span class="tuareg-font-lock-operator">=</span> p new_cd new_ctrl <span class="tuareg-font-lock-operator">(</span>end_clock_domain site new_cd new_ctrl f_k<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-governing">in</span>
      <span class="keyword">fun</span> <span class="variable-name">_ </span><span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="type">D</span>.add_current f new_cd.cd_current<span class="tuareg-font-lock-operator">;</span>
        start_ctrl new_cd ctrl new_ctrl<span class="tuareg-font-lock-operator">;</span>
        exec_cd site new_cd <span class="tuareg-font-lock-operator">()</span>

    <span class="comment">(* After receving Mnew_cd *)</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">create_cd</span><span class="variable-name"> site msg </span><span class="tuareg-font-lock-operator">=</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">tmp_id</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> parent_ck</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> new_balancer</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> period</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> location</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> p </span><span class="tuareg-font-lock-operator">=</span> <span class="type">Msgs</span>.recv_new_cd msg <span class="tuareg-font-lock-governing">in</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">new_ck </span><span class="tuareg-font-lock-operator">=</span> mk_clock <span class="tuareg-font-lock-operator">(</span>Some parent_ck<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-governing">in</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">new_cd </span><span class="tuareg-font-lock-operator">=</span> mk_clock_domain site new_ck new_balancer period location None <span class="tuareg-font-lock-operator">(</span>Some tmp_id<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-governing">in</span>
      IFDEF RML_DEBUG THEN
        print_debug <span class="string">"Created local clock domain %a after request by %a@."</span>
          print_cd new_cd   print_clock parent_ck
      ELSE <span class="tuareg-font-lock-operator">()</span> END<span class="tuareg-font-lock-operator">;</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">new_ctrl </span><span class="tuareg-font-lock-operator">=</span> control_tree new_cd <span class="tuareg-font-lock-governing">in</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">f </span><span class="tuareg-font-lock-operator">=</span> p new_cd new_ctrl <span class="tuareg-font-lock-operator">(</span>end_clock_domain site new_cd new_ctrl dummy_step<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-governing">in</span>
      <span class="type">D</span>.add_current f new_cd.cd_current<span class="tuareg-font-lock-operator">;</span>
      <span class="comment">(* execute the first step *)</span>
      IFDEF RML_DEBUG THEN
        print_debug <span class="string">"Starting local clock domain %a on request@."</span> <span class="type">C</span>.print_gid new_ck.ck_gid
      ELSE <span class="tuareg-font-lock-operator">()</span> END<span class="tuareg-font-lock-operator">;</span>
      <span class="type">Clock</span>.update_clock site parent_ck<span class="tuareg-font-lock-operator">;</span>
      exec_cd site new_cd <span class="tuareg-font-lock-operator">()</span>

    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">new_remote_clock_domain</span><span class="variable-name"> site remote_site new_balancer period location cd ctrl p f_k </span><span class="tuareg-font-lock-operator">=</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">tmp_id </span><span class="tuareg-font-lock-operator">=</span> <span class="type">C</span>.fresh site.s_seed <span class="tuareg-font-lock-governing">in</span>
      update_remote_set site cd <span class="constant">true</span> remote_site<span class="tuareg-font-lock-operator">;</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">new_ctrl </span><span class="tuareg-font-lock-operator">=</span> new_ctrl <span class="tuareg-font-lock-operator">(</span>Clock_domain None<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-governing">in</span>
      <span class="comment">(* add local callbacks *)</span>
      add_callback_once site <span class="tuareg-font-lock-operator">(</span>Mdone tmp_id<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>receive_done_cd site cd new_ctrl f_k<span class="tuareg-font-lock-operator">);</span>
      add_callback site <span class="tuareg-font-lock-operator">(</span>Mstep_done tmp_id<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>receive_step_done site cd ctrl<span class="tuareg-font-lock-operator">);</span>
      start_ctrl cd ctrl new_ctrl<span class="tuareg-font-lock-operator">;</span>
      <span class="comment">(* send a message to start the execution *)</span>
      IFDEF RML_DEBUG THEN print_debug <span class="string">"Starting remote clock domain@."</span> ELSE <span class="tuareg-font-lock-operator">()</span> END<span class="tuareg-font-lock-operator">;</span>
      IFDEF RML_DEBUG THEN print_debug <span class="string">"++%a@."</span> print_cd cd ELSE <span class="tuareg-font-lock-operator">()</span> END<span class="tuareg-font-lock-operator">;</span>
      incr cd.cd_remaining_async<span class="tuareg-font-lock-operator">;</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="function-name">new_p</span><span class="variable-name"> cd ctrl f_k </span><span class="tuareg-font-lock-operator">=</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="function-name">new_f_k</span><span class="variable-name"> x </span><span class="tuareg-font-lock-operator">=</span>
          <span class="type">C</span>.send_owner tmp_id <span class="tuareg-font-lock-operator">(</span>Mdone tmp_id<span class="tuareg-font-lock-operator">)</span> x<span class="tuareg-font-lock-operator">;</span>
          f_k <span class="tuareg-font-lock-operator">()</span>
        <span class="tuareg-font-lock-governing">in</span>
        p cd ctrl new_f_k
      <span class="tuareg-font-lock-governing">in</span>
      <span class="type">Msgs</span>.send_new_cd remote_site <span class="tuareg-font-lock-operator">(</span>tmp_id<span class="tuareg-font-lock-operator">,</span> cd.cd_clock<span class="tuareg-font-lock-operator">,</span> new_balancer<span class="tuareg-font-lock-operator">,</span> period<span class="tuareg-font-lock-operator">,</span> location<span class="tuareg-font-lock-operator">,</span> new_p<span class="tuareg-font-lock-operator">)</span>

    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">new_clock_domain</span><span class="variable-name"> cd ctrl p user_balancer period f_k _ </span><span class="tuareg-font-lock-operator">=</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">site </span><span class="tuareg-font-lock-operator">=</span> get_site <span class="tuareg-font-lock-operator">()</span> <span class="tuareg-font-lock-governing">in</span>
      <span class="keyword">if</span> cd.cd_location <span class="tuareg-font-lock-operator">=</span> <span class="type">L</span>.Lleaf <span class="keyword">then</span>
        new_local_clock_domain site cd cd.cd_load_balancer period <span class="type">L</span>.Lleaf ctrl p f_k <span class="tuareg-font-lock-operator">()</span>
      <span class="keyword">else</span> <span class="tuareg-font-lock-operator">(</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">remote_site</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> location</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> new_balancer </span><span class="tuareg-font-lock-operator">=</span> cd.cd_load_balancer<span class="tuareg-font-lock-operator">#</span>new_child user_balancer  <span class="tuareg-font-lock-governing">in</span>
        <span class="keyword">if</span> remote_site <span class="tuareg-font-lock-operator">&lt;&gt;</span> <span class="type">C</span>.local_site <span class="tuareg-font-lock-operator">()</span> <span class="keyword">then</span> <span class="tuareg-font-lock-operator">(</span>
          IFDEF RML_DEBUG THEN
            print_debug <span class="string">"Distributing new cd to site %a@."</span> <span class="type">C</span>.print_site remote_site
          ELSE <span class="tuareg-font-lock-operator">()</span> END<span class="tuareg-font-lock-operator">;</span>
          new_remote_clock_domain site remote_site new_balancer period location cd ctrl p f_k
        <span class="tuareg-font-lock-operator">)</span> <span class="keyword">else</span>
          new_local_clock_domain site cd new_balancer period location ctrl p f_k <span class="tuareg-font-lock-operator">()</span>
     <span class="tuareg-font-lock-operator">)</span>

   <span class="tuareg-font-lock-governing">module</span> <span class="type">Join </span><span class="tuareg-font-lock-operator">=</span> <span class="type">Seq_runtime</span>.JoinRef
   <span class="tuareg-font-lock-governing">type</span> <span class="type">join_point </span><span class="tuareg-font-lock-operator">=</span> <span class="type">Seq_runtime</span>.<span class="type">JoinRef</span>.join_point

   <span class="tuareg-font-lock-governing">module</span> <span class="type">Event </span><span class="tuareg-font-lock-operator">=</span>
      <span class="tuareg-font-lock-governing">struct</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="function-name">lift_handle</span><span class="variable-name"> f ev </span><span class="tuareg-font-lock-operator">=</span>
          f <span class="tuareg-font-lock-operator">(</span>get_event <span class="tuareg-font-lock-operator">(</span>get_site <span class="tuareg-font-lock-operator">())</span> ev<span class="tuareg-font-lock-operator">)</span>

        <span class="tuareg-font-lock-governing">let</span> <span class="function-name">value</span><span class="variable-name"> ev </span><span class="tuareg-font-lock-operator">=</span>
          <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">n </span><span class="tuareg-font-lock-operator">=</span> get_event <span class="tuareg-font-lock-operator">(</span>get_site <span class="tuareg-font-lock-operator">())</span> ev <span class="tuareg-font-lock-governing">in</span>
          <span class="keyword">if</span> <span class="type">E</span>.status n <span class="keyword">then</span>
            <span class="type">E</span>.value n
          <span class="keyword">else</span> <span class="tuareg-font-lock-operator">(</span>
            IFDEF RML_DEBUG THEN
              print_debug <span class="string">"Error: Reading the value of an absent signal %a@."</span> <span class="type">C</span>.print_gid ev.ev_gid
            ELSE <span class="tuareg-font-lock-operator">()</span> END<span class="tuareg-font-lock-operator">;</span>
            <span class="keyword">raise</span> <span class="type">Rml_types</span>.RML
          <span class="tuareg-font-lock-operator">)</span>

        <span class="tuareg-font-lock-governing">let</span> <span class="function-name">one</span><span class="variable-name"> ev </span><span class="tuareg-font-lock-operator">=</span> lift_handle <span class="type">E</span>.one ev
        <span class="tuareg-font-lock-governing">let</span> <span class="function-name">pre_status</span><span class="variable-name"> ev </span><span class="tuareg-font-lock-operator">=</span> lift_handle <span class="type">E</span>.pre_status ev
        <span class="tuareg-font-lock-governing">let</span> <span class="function-name">pre_value</span><span class="variable-name"> ev </span><span class="tuareg-font-lock-operator">=</span> lift_handle <span class="type">E</span>.pre_value ev
        <span class="tuareg-font-lock-governing">let</span> <span class="function-name">last</span><span class="variable-name"> ev </span><span class="tuareg-font-lock-operator">=</span> lift_handle <span class="type">E</span>.last ev
        <span class="tuareg-font-lock-governing">let</span> <span class="function-name">default</span><span class="variable-name"> ev </span><span class="tuareg-font-lock-operator">=</span> lift_handle <span class="type">E</span>.default ev
        <span class="tuareg-font-lock-governing">let</span> <span class="function-name">clock</span><span class="variable-name"> ev </span><span class="tuareg-font-lock-operator">=</span> get_event_clock <span class="tuareg-font-lock-operator">(</span>get_site <span class="tuareg-font-lock-operator">())</span> ev

        <span class="tuareg-font-lock-governing">let</span> <span class="function-name">region_of_clock</span><span class="variable-name"> ck </span><span class="tuareg-font-lock-operator">=</span> ck

        <span class="tuareg-font-lock-governing">let</span> <span class="function-name">get_signal_remotes</span><span class="variable-name"> site gid </span><span class="tuareg-font-lock-operator">=</span>
          <span class="keyword">try</span>
            <span class="type">C</span>.<span class="type">GidMap</span>.find gid site.s_signals_remotes
          <span class="keyword">with</span>
            <span class="tuareg-font-lock-operator">|</span> Not_found <span class="tuareg-font-lock-operator">-&gt;</span> <span class="type">C</span>.<span class="type">SiteSet</span>.empty

        <span class="tuareg-font-lock-governing">let</span> <span class="function-name">add_signal_remote</span><span class="variable-name"> site s gid </span><span class="tuareg-font-lock-operator">=</span>
          <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">set </span><span class="tuareg-font-lock-operator">=</span>
            <span class="keyword">if</span> <span class="type">C</span>.<span class="type">GidMap</span>.mem gid site.s_signals_remotes <span class="keyword">then</span>
              <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">set </span><span class="tuareg-font-lock-operator">=</span> <span class="type">C</span>.<span class="type">GidMap</span>.find gid site.s_signals_remotes <span class="tuareg-font-lock-governing">in</span>
              <span class="type">C</span>.<span class="type">SiteSet</span>.add s set
            <span class="keyword">else</span>
              <span class="type">C</span>.<span class="type">SiteSet</span>.singleton s
          <span class="tuareg-font-lock-governing">in</span>
          site.s_signals_remotes <span class="tuareg-font-lock-operator">&lt;-</span> <span class="type">C</span>.<span class="type">GidMap</span>.add gid set site.s_signals_remotes

        <span class="tuareg-font-lock-governing">let</span> <span class="function-name">send_value_to_remotes</span><span class="variable-name"> site cd ev n </span><span class="tuareg-font-lock-operator">()</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span>
          <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">remotes </span><span class="tuareg-font-lock-operator">=</span>
            <span class="keyword">if</span> <span class="tuareg-font-lock-operator">!</span><span class="type">Runtime_options</span>.use_signals_users_set <span class="keyword">then</span>
              get_signal_remotes site ev.ev_gid
            <span class="keyword">else</span>
              <span class="type">C</span>.<span class="type">SiteSet</span>.union cd.cd_direct_remotes cd.cd_other_remotes
          <span class="tuareg-font-lock-governing">in</span>
          <span class="type">C</span>.broadcast_set remotes <span class="tuareg-font-lock-operator">(</span>Mvalue ev.ev_gid<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span><span class="type">E</span>.value n<span class="tuareg-font-lock-operator">)</span>

        <span class="tuareg-font-lock-governing">let</span> <span class="function-name">do_emit</span><span class="variable-name"> site ev v </span><span class="tuareg-font-lock-operator">=</span>
          IFDEF RML_DEBUG THEN
            print_debug <span class="string">"Emitting a value for %a@."</span> print_signal ev
          ELSE <span class="tuareg-font-lock-operator">()</span> END<span class="tuareg-font-lock-operator">;</span>
          <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">n</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> ev_ck</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> ev_r</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> _ </span><span class="tuareg-font-lock-operator">=</span> get_event_whole site ev <span class="tuareg-font-lock-governing">in</span>
          <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">already_present </span><span class="tuareg-font-lock-operator">=</span> <span class="type">E</span>.status n <span class="tuareg-font-lock-governing">in</span>
          IFDEF RML_DEBUG THEN
            <span class="keyword">if</span> <span class="tuareg-font-lock-operator">not</span> <span class="tuareg-font-lock-operator">(</span><span class="type">C</span>.is_local ev_r.ck_gid<span class="tuareg-font-lock-operator">)</span> <span class="keyword">then</span>
              print_debug <span class="string">"Error: do_emit on remote signal %a at region %a of clock %a@."</span>
                <span class="type">C</span>.print_gid ev.ev_gid   print_clock ev_r  print_clock ev_ck
          ELSE <span class="tuareg-font-lock-operator">()</span> END<span class="tuareg-font-lock-operator">;</span>
          <span class="type">E</span>.emit n v<span class="tuareg-font-lock-operator">;</span>
          <span class="comment">(* wake up processes awaiting this signal *)</span>
          wake_up_now site <span class="tuareg-font-lock-operator">(</span>Wsignal_wa ev.ev_gid<span class="tuareg-font-lock-operator">);</span>
          wake_up_now site <span class="tuareg-font-lock-operator">(</span>Wsignal_wp ev.ev_gid<span class="tuareg-font-lock-operator">);</span>
          <span class="comment">(* if we have remote clock domains, we should send them the value later *)</span>
          <span class="keyword">if</span> <span class="tuareg-font-lock-operator">not</span> already_present <span class="keyword">then</span> <span class="tuareg-font-lock-operator">(</span>
            <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">cd </span><span class="tuareg-font-lock-operator">=</span> get_clock_domain site ev_r <span class="tuareg-font-lock-governing">in</span>
            <span class="keyword">if</span> cd.cd_location <span class="tuareg-font-lock-operator">=</span> <span class="type">L</span>.Lany <span class="keyword">then</span>
              add_waiting site <span class="tuareg-font-lock-operator">(</span>Wbefore_eoi ev_ck.ck_gid<span class="tuareg-font-lock-operator">)</span>
                <span class="tuareg-font-lock-operator">(</span>send_value_to_remotes site cd ev n<span class="tuareg-font-lock-operator">)</span>
          <span class="tuareg-font-lock-operator">)</span>

        <span class="tuareg-font-lock-governing">let</span> <span class="function-name">emit</span><span class="variable-name"> ev v </span><span class="tuareg-font-lock-operator">=</span>
          <span class="keyword">if</span> <span class="type">C</span>.is_local ev.ev_gid <span class="keyword">then</span> <span class="tuareg-font-lock-operator">(</span>
            do_emit <span class="tuareg-font-lock-operator">(</span>get_site <span class="tuareg-font-lock-operator">())</span> ev v
          <span class="tuareg-font-lock-operator">)</span> <span class="keyword">else</span>
            <span class="type">C</span>.send_owner ev.ev_gid <span class="tuareg-font-lock-operator">(</span>Memit ev.ev_gid<span class="tuareg-font-lock-operator">)</span> v

        <span class="comment">(* Called after receiving Mreq_signal id *)</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="function-name">receive_req</span><span class="variable-name"> site </span><span class="tuareg-font-lock-operator">(</span><span class="variable-name">n</span> <span class="tuareg-font-lock-operator">:</span> <span class="tuareg-font-lock-operator">('</span><span class="type">a</span><span class="tuareg-font-lock-operator">,</span><span class="type"> </span><span class="tuareg-font-lock-operator">'</span><span class="type">b</span><span class="tuareg-font-lock-operator">)</span><span class="type"> E.t</span><span class="tuareg-font-lock-operator">)</span> gid msg <span class="tuareg-font-lock-operator">=</span>
          <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">req_id </span><span class="tuareg-font-lock-operator">=</span> <span class="type">Msgs</span>.recv_req_signal msg <span class="tuareg-font-lock-governing">in</span>
          <span class="keyword">if</span> <span class="tuareg-font-lock-operator">!</span><span class="type">Runtime_options</span>.use_signals_users_set <span class="keyword">then</span>
            add_signal_remote site <span class="tuareg-font-lock-operator">(</span><span class="type">C</span>.site_of_gid req_id<span class="tuareg-font-lock-operator">)</span> gid<span class="tuareg-font-lock-operator">;</span>
          <span class="type">C</span>.send_owner req_id <span class="tuareg-font-lock-operator">(</span>Msignal gid<span class="tuareg-font-lock-operator">)</span> n

        <span class="comment">(* Called after receiving Memit id *)</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="function-name">receive_emit</span><span class="variable-name"> site </span><span class="tuareg-font-lock-operator">(</span><span class="variable-name">ev</span><span class="tuareg-font-lock-operator">:('</span><span class="type">a</span><span class="tuareg-font-lock-operator">,</span><span class="type"> </span><span class="tuareg-font-lock-operator">'</span><span class="type">b</span><span class="tuareg-font-lock-operator">)</span><span class="type"> event</span><span class="tuareg-font-lock-operator">)</span> msg <span class="tuareg-font-lock-operator">=</span>
          <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">v</span><span class="tuareg-font-lock-operator">:'</span><span class="type">a </span><span class="tuareg-font-lock-operator">=</span> <span class="type">C</span>.from_msg msg <span class="tuareg-font-lock-governing">in</span>
            do_emit site ev v

        <span class="comment">(* Called after receiving Mvalue id *)</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="function-name">update_local_value</span><span class="variable-name"> site gid </span><span class="tuareg-font-lock-operator">(</span><span class="variable-name">n</span> <span class="tuareg-font-lock-operator">:</span> <span class="tuareg-font-lock-operator">('</span><span class="type">a</span><span class="tuareg-font-lock-operator">,</span><span class="type"> </span><span class="tuareg-font-lock-operator">'</span><span class="type">b</span><span class="tuareg-font-lock-operator">)</span><span class="type"> E.t</span><span class="tuareg-font-lock-operator">)</span> msg <span class="tuareg-font-lock-operator">=</span>
          <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">v</span><span class="tuareg-font-lock-operator">:'</span><span class="type">b </span><span class="tuareg-font-lock-operator">=</span> <span class="type">C</span>.from_msg msg <span class="tuareg-font-lock-governing">in</span>
            <span class="type">E</span>.set_value n v<span class="tuareg-font-lock-operator">;</span>
            wake_up_now site <span class="tuareg-font-lock-operator">(</span>Wsignal_wa gid<span class="tuareg-font-lock-operator">)</span>

        <span class="comment">(* create callback for resetting the signal *)</span>
        <span class="comment">(* TODO: use weak pointer *)</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="function-name">add_reset</span><span class="variable-name"> site gid n ck reset </span><span class="tuareg-font-lock-operator">=</span>
          <span class="keyword">match</span> reset <span class="keyword">with</span>
            <span class="tuareg-font-lock-operator">|</span> None <span class="tuareg-font-lock-operator">-&gt;</span> <span class="tuareg-font-lock-operator">()</span>
            <span class="tuareg-font-lock-operator">|</span> Some rck <span class="tuareg-font-lock-operator">-&gt;</span>
              <span class="tuareg-font-lock-governing">let</span> <span class="tuareg-font-lock-governing">rec</span> <span class="function-name">reset_evt</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">()</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span>
                IFDEF RML_DEBUG THEN
                  print_debug <span class="string">"Resetting signal %a of clock %a on reset clock %a@."</span>
                  <span class="type">C</span>.print_gid gid  print_clock ck  print_clock rck
                ELSE <span class="tuareg-font-lock-operator">()</span> END<span class="tuareg-font-lock-operator">;</span>
                <span class="type">E</span>.reset n<span class="tuareg-font-lock-operator">;</span>
                add_waiting site <span class="tuareg-font-lock-operator">(</span>Weoi rck.ck_gid<span class="tuareg-font-lock-operator">)</span> reset_evt
              <span class="tuareg-font-lock-governing">in</span>
              add_waiting site <span class="tuareg-font-lock-operator">(</span>Weoi rck.ck_gid<span class="tuareg-font-lock-operator">)</span> reset_evt

        <span class="tuareg-font-lock-governing">let</span> <span class="function-name">setup_local_copy</span><span class="variable-name"> site gid n ck reset </span><span class="tuareg-font-lock-operator">=</span>
          add_callback site <span class="tuareg-font-lock-operator">(</span>Mvalue gid<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>update_local_value site gid n<span class="tuareg-font-lock-operator">);</span>
          <span class="type">E</span>.set_clock n <span class="tuareg-font-lock-operator">(</span>get_clock site ck.ck_clock<span class="tuareg-font-lock-operator">);</span>
          add_reset site gid n ck reset

        <span class="comment">(* Called when a local process tries to access a remote signal for the first time.
           Creates local callbacks for this signal. *)</span>
        <span class="doc">(** TODO: remove callbacks when signal is no longer needed *)</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="function-name">signal_local_value</span><span class="variable-name"> gid </span><span class="tuareg-font-lock-operator">(</span><span class="variable-name">n</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> ck</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> r</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> reset</span><span class="tuareg-font-lock-operator">)</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span>
          <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">site </span><span class="tuareg-font-lock-operator">=</span> get_site <span class="tuareg-font-lock-operator">()</span> <span class="tuareg-font-lock-governing">in</span>
          <span class="comment">(* request the current value of the signal *)</span>
          <span class="type">Msgs</span>.send_req_signal gid <span class="tuareg-font-lock-operator">(</span><span class="type">C</span>.fresh site.s_seed<span class="tuareg-font-lock-operator">);</span>
          setup_local_copy site gid n ck reset<span class="tuareg-font-lock-operator">;</span>
          <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">msg </span><span class="tuareg-font-lock-operator">=</span> <span class="type">Callbacks</span>.recv_given_msg site.s_msg_queue <span class="tuareg-font-lock-operator">(</span>Msignal gid<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-governing">in</span>
          <span class="comment">(* set the local value to the one received *)</span>
          <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">new_n </span><span class="tuareg-font-lock-operator">=</span> <span class="type">C</span>.from_msg msg <span class="tuareg-font-lock-governing">in</span>
          <span class="type">E</span>.copy n new_n<span class="tuareg-font-lock-operator">;</span>
          n<span class="tuareg-font-lock-operator">,</span> ck<span class="tuareg-font-lock-operator">,</span> r<span class="tuareg-font-lock-operator">,</span> reset

        <span class="tuareg-font-lock-governing">let</span> <span class="function-name">new_local_evt</span><span class="variable-name"> site ck r is_memory default combine reset </span><span class="tuareg-font-lock-operator">=</span>
          <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">n </span><span class="tuareg-font-lock-operator">=</span> <span class="type">E</span>.create <span class="tuareg-font-lock-operator">(</span>get_clock site ck.ck_clock<span class="tuareg-font-lock-operator">)</span> is_memory default combine <span class="tuareg-font-lock-governing">in</span>
          <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">gid </span><span class="tuareg-font-lock-operator">=</span> <span class="type">C</span>.fresh site.s_seed <span class="tuareg-font-lock-governing">in</span>
          <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">ev  </span><span class="tuareg-font-lock-operator">=</span>
            <span class="tuareg-font-lock-operator">{</span> ev_handle <span class="tuareg-font-lock-operator">=</span> <span class="type">SignalHandle</span>.init site.s_signal_cache gid <span class="tuareg-font-lock-operator">(</span>n<span class="tuareg-font-lock-operator">,</span> ck<span class="tuareg-font-lock-operator">,</span> r<span class="tuareg-font-lock-operator">,</span> reset<span class="tuareg-font-lock-operator">);</span>
              ev_gid <span class="tuareg-font-lock-operator">=</span> gid <span class="tuareg-font-lock-operator">}</span>
          <span class="tuareg-font-lock-governing">in</span>
          IFDEF RML_DEBUG THEN
            print_debug <span class="string">"Created signal %a at region %a of clock %a@."</span> print_signal ev
              print_clock r  print_clock ck
          ELSE <span class="tuareg-font-lock-operator">()</span> END<span class="tuareg-font-lock-operator">;</span>
          <span class="keyword">if</span> <span class="tuareg-font-lock-operator">(</span>get_clock_domain site r<span class="tuareg-font-lock-operator">)</span>.cd_location <span class="tuareg-font-lock-operator">=</span> <span class="type">L</span>.Lany <span class="keyword">then</span> <span class="tuareg-font-lock-operator">(</span>
            add_callback site <span class="tuareg-font-lock-operator">(</span>Memit gid<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>receive_emit site ev<span class="tuareg-font-lock-operator">);</span>
            add_callback site <span class="tuareg-font-lock-operator">(</span>Mreq_signal gid<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>receive_req site n gid<span class="tuareg-font-lock-operator">)</span>
          <span class="tuareg-font-lock-operator">);</span>
          add_reset site gid n ck reset<span class="tuareg-font-lock-operator">;</span>
          ev

        <span class="tuareg-font-lock-governing">let</span> <span class="function-name">new_remote_evt</span><span class="variable-name"> site local_cd ck r is_memory</span>
            default <span class="tuareg-font-lock-operator">(</span><span class="variable-name">combine</span> <span class="tuareg-font-lock-operator">:</span> <span class="tuareg-font-lock-operator">'</span><span class="type">a </span><span class="tuareg-font-lock-operator">-&gt;</span><span class="type"> </span><span class="tuareg-font-lock-operator">'</span><span class="type">b </span><span class="tuareg-font-lock-operator">-&gt;</span><span class="type"> </span><span class="tuareg-font-lock-operator">'</span><span class="type">b</span><span class="tuareg-font-lock-operator">)</span> reset k <span class="tuareg-font-lock-operator">=</span>
          <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">tmp_id </span><span class="tuareg-font-lock-operator">=</span> <span class="type">C</span>.fresh site.s_seed <span class="tuareg-font-lock-governing">in</span>
          <span class="tuareg-font-lock-governing">let</span> <span class="function-name">create_signal</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">()</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span>
            <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">site </span><span class="tuareg-font-lock-operator">=</span> get_site <span class="tuareg-font-lock-operator">()</span> <span class="tuareg-font-lock-governing">in</span>
            <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">ev </span><span class="tuareg-font-lock-operator">=</span> new_local_evt site ck r is_memory default combine reset <span class="tuareg-font-lock-governing">in</span>
            <span class="keyword">if</span> <span class="tuareg-font-lock-operator">!</span><span class="type">Runtime_options</span>.use_signals_users_set <span class="keyword">then</span>
              add_signal_remote site <span class="tuareg-font-lock-operator">(</span><span class="type">C</span>.site_of_gid tmp_id<span class="tuareg-font-lock-operator">)</span> ev.ev_gid<span class="tuareg-font-lock-operator">;</span>
            IFDEF RML_DEBUG THEN
              print_debug <span class="string">"Created signal %a at region %a of clock %a from request by %a@."</span> print_signal ev
                print_clock r   print_clock ck  <span class="type">C</span>.print_gid tmp_id
            ELSE <span class="tuareg-font-lock-operator">()</span> END<span class="tuareg-font-lock-operator">;</span>
            <span class="type">C</span>.send_owner tmp_id <span class="tuareg-font-lock-operator">(</span>Msignal_created tmp_id<span class="tuareg-font-lock-operator">)</span> ev
          <span class="tuareg-font-lock-governing">in</span>
          <span class="tuareg-font-lock-governing">let</span> <span class="function-name">recv_signal_created</span><span class="variable-name"> msg </span><span class="tuareg-font-lock-operator">=</span>
            <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">ev</span><span class="tuareg-font-lock-operator">:('</span><span class="type">a</span><span class="tuareg-font-lock-operator">,</span><span class="type"> </span><span class="tuareg-font-lock-operator">'</span><span class="type">b</span><span class="tuareg-font-lock-operator">)</span><span class="type"> event </span><span class="tuareg-font-lock-operator">=</span> <span class="type">C</span>.from_msg msg <span class="tuareg-font-lock-governing">in</span>
            decr local_cd.cd_remaining_async<span class="tuareg-font-lock-operator">;</span>
            IFDEF RML_DEBUG THEN
              print_debug <span class="string">"Received created signal %a at %a@."</span> print_signal ev print_cd local_cd<span class="tuareg-font-lock-operator">;</span>
              print_debug <span class="string">"--%a@."</span> print_cd local_cd<span class="tuareg-font-lock-operator">;</span>
              <span class="keyword">if</span> <span class="tuareg-font-lock-operator">!(</span>local_cd.cd_remaining_async<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">&lt;</span> 0 <span class="keyword">then</span>
                print_debug <span class="string">"Error: counter of %a is &lt; 0@."</span> print_cd local_cd<span class="tuareg-font-lock-operator">;</span>
            ELSE <span class="tuareg-font-lock-operator">()</span> END<span class="tuareg-font-lock-operator">;</span>
            <span class="type">SignalHandle</span>.set_valid ev.ev_handle<span class="tuareg-font-lock-operator">;</span>
            <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">n </span><span class="tuareg-font-lock-operator">=</span> get_event site ev <span class="tuareg-font-lock-governing">in</span>
            setup_local_copy site ev.ev_gid n ck reset<span class="tuareg-font-lock-operator">;</span>
            <span class="type">D</span>.add_current <span class="tuareg-font-lock-operator">(</span>k ev<span class="tuareg-font-lock-operator">)</span> local_cd.cd_current<span class="tuareg-font-lock-operator">;</span>
            wake_up_cd_if_done site local_cd
          <span class="tuareg-font-lock-governing">in</span>
          add_callback_once site <span class="tuareg-font-lock-operator">(</span>Msignal_created tmp_id<span class="tuareg-font-lock-operator">)</span> recv_signal_created<span class="tuareg-font-lock-operator">;</span>
          IFDEF RML_DEBUG THEN print_debug <span class="string">"++%a@."</span> print_cd local_cd ELSE <span class="tuareg-font-lock-operator">()</span> END<span class="tuareg-font-lock-operator">;</span>
          incr local_cd.cd_remaining_async<span class="tuareg-font-lock-operator">;</span>
          <span class="type">Msgs</span>.send_create_signal r.ck_gid <span class="tuareg-font-lock-operator">(</span>tmp_id<span class="tuareg-font-lock-operator">,</span> create_signal<span class="tuareg-font-lock-operator">)</span>

        <span class="tuareg-font-lock-governing">let</span> <span class="function-name">new_evt</span><span class="variable-name"> local_cd ck r is_memory default combine reset k _ </span><span class="tuareg-font-lock-operator">=</span>
          <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">site </span><span class="tuareg-font-lock-operator">=</span> get_site <span class="tuareg-font-lock-operator">()</span> <span class="tuareg-font-lock-governing">in</span>
          <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">r </span><span class="tuareg-font-lock-operator">=</span> <span class="keyword">if</span> <span class="tuareg-font-lock-operator">!</span><span class="type">Runtime_options</span>.use_local_slow_signals <span class="keyword">then</span> r <span class="keyword">else</span> ck <span class="tuareg-font-lock-governing">in</span>
          <span class="keyword">if</span> <span class="type">C</span>.is_local r.ck_gid <span class="keyword">then</span>
            <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">evt </span><span class="tuareg-font-lock-operator">=</span> new_local_evt site ck r is_memory default combine reset <span class="tuareg-font-lock-governing">in</span>
            k evt <span class="tuareg-font-lock-operator">()</span>
          <span class="keyword">else</span>
            new_remote_evt site local_cd ck r is_memory default combine reset k

        <span class="tuareg-font-lock-governing">let</span> <span class="function-name">new_evt_expr</span><span class="variable-name"> ck r is_memory default combine </span><span class="tuareg-font-lock-operator">=</span>
          <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">site </span><span class="tuareg-font-lock-operator">=</span> get_site <span class="tuareg-font-lock-operator">()</span> <span class="tuareg-font-lock-governing">in</span>
          <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">r </span><span class="tuareg-font-lock-operator">=</span> <span class="keyword">if</span> <span class="tuareg-font-lock-operator">!</span><span class="type">Runtime_options</span>.use_local_slow_signals <span class="keyword">then</span> r <span class="keyword">else</span> ck <span class="tuareg-font-lock-governing">in</span>
          <span class="keyword">if</span> <span class="type">C</span>.is_local r.ck_gid <span class="keyword">then</span> <span class="tuareg-font-lock-operator">(</span>
            new_local_evt site ck r is_memory default combine None
          <span class="tuareg-font-lock-operator">)</span> <span class="keyword">else</span> <span class="tuareg-font-lock-operator">(</span>
            IFDEF RML_DEBUG THEN
              print_debug <span class="string">"Trying to create a remote signal inside an expression@."</span><span class="tuareg-font-lock-operator">;</span>
            ELSE <span class="tuareg-font-lock-operator">()</span> END<span class="tuareg-font-lock-operator">;</span>
            <span class="keyword">raise</span> <span class="type">Rml_types</span>.RML
          <span class="tuareg-font-lock-operator">)</span>


        <span class="tuareg-font-lock-governing">let</span> <span class="function-name">new_evt_global</span><span class="variable-name"> is_memory default </span><span class="tuareg-font-lock-operator">(</span><span class="variable-name">combine</span> <span class="tuareg-font-lock-operator">:</span> <span class="tuareg-font-lock-operator">'</span><span class="type">a </span><span class="tuareg-font-lock-operator">-&gt;</span><span class="type"> </span><span class="tuareg-font-lock-operator">'</span><span class="type">b </span><span class="tuareg-font-lock-operator">-&gt;</span><span class="type"> </span><span class="tuareg-font-lock-operator">'</span><span class="type">b</span><span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">=</span>
          <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">site </span><span class="tuareg-font-lock-operator">=</span> get_site <span class="tuareg-font-lock-operator">()</span> <span class="tuareg-font-lock-governing">in</span>
          <span class="keyword">if</span> <span class="type">C</span>.is_master <span class="tuareg-font-lock-operator">()</span> <span class="keyword">then</span> <span class="tuareg-font-lock-operator">(</span>
            <span class="comment">(* create the signal *)</span>
            <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">ck </span><span class="tuareg-font-lock-operator">=</span> top_clock <span class="tuareg-font-lock-operator">()</span> <span class="tuareg-font-lock-governing">in</span>
            <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">ev </span><span class="tuareg-font-lock-operator">=</span> new_local_evt site ck ck is_memory default combine None <span class="tuareg-font-lock-governing">in</span>
            <span class="comment">(* send it to all other sites *)</span>
            print_debug <span class="string">"Sending global signal %a@."</span> print_signal ev<span class="tuareg-font-lock-operator">;</span>
            <span class="type">C</span>.broadcast <span class="tuareg-font-lock-operator">(</span>Msignal ev.ev_gid<span class="tuareg-font-lock-operator">)</span> ev<span class="tuareg-font-lock-operator">;</span>
            <span class="keyword">if</span> <span class="tuareg-font-lock-operator">!</span><span class="type">Runtime_options</span>.use_signals_users_set <span class="keyword">then</span>
              <span class="type">C</span>.<span class="type">SiteSet</span>.iter
                <span class="tuareg-font-lock-operator">(</span><span class="keyword">fun</span> <span class="variable-name">s </span><span class="tuareg-font-lock-operator">-&gt;</span> <span class="keyword">if</span> s <span class="tuareg-font-lock-operator">&lt;&gt;</span> <span class="type">C</span>.local_site <span class="tuareg-font-lock-operator">()</span> <span class="keyword">then</span> add_signal_remote site s ev.ev_gid<span class="tuareg-font-lock-operator">)</span>
                <span class="tuareg-font-lock-operator">(</span><span class="type">C</span>.all_sites <span class="tuareg-font-lock-operator">());</span>
            ev
          <span class="tuareg-font-lock-operator">)</span> <span class="keyword">else</span> <span class="tuareg-font-lock-operator">(</span>
            <span class="comment">(* get the value sent by the master site *)</span>
            <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">tmp_id </span><span class="tuareg-font-lock-operator">=</span> <span class="type">C</span>.fresh site.s_seed <span class="tuareg-font-lock-governing">in</span>
            <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">ev_id </span><span class="tuareg-font-lock-operator">=</span> <span class="type">C</span>.relocate_gid tmp_id <span class="tuareg-font-lock-operator">(</span><span class="type">C</span>.master_site <span class="tuareg-font-lock-operator">())</span> <span class="tuareg-font-lock-governing">in</span>
            print_debug <span class="string">"Waiting for global signal %a@."</span> <span class="type">C</span>.print_gid ev_id<span class="tuareg-font-lock-operator">;</span>
            <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">msg </span><span class="tuareg-font-lock-operator">=</span> <span class="type">Callbacks</span>.recv_given_msg site.s_msg_queue <span class="tuareg-font-lock-operator">(</span>Msignal ev_id<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-governing">in</span>
            <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">ev </span><span class="tuareg-font-lock-operator">:</span> <span class="tuareg-font-lock-operator">('</span><span class="type">a</span><span class="tuareg-font-lock-operator">,</span><span class="type"> </span><span class="tuareg-font-lock-operator">'</span><span class="type">b</span><span class="tuareg-font-lock-operator">)</span><span class="type"> event </span><span class="tuareg-font-lock-operator">=</span> <span class="type">C</span>.from_msg msg <span class="tuareg-font-lock-governing">in</span>
            print_debug <span class="string">"Received global signal %a@."</span> <span class="type">C</span>.print_gid ev_id<span class="tuareg-font-lock-operator">;</span>
            <span class="comment">(* setup the local copy *)</span>
            <span class="type">SignalHandle</span>.set_valid ev.ev_handle<span class="tuareg-font-lock-operator">;</span>
            <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">n</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> ck</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> _</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> _ </span><span class="tuareg-font-lock-operator">=</span> get_event_whole site ev <span class="tuareg-font-lock-governing">in</span>
            setup_local_copy site ev.ev_gid n ck None<span class="tuareg-font-lock-operator">;</span>
            ev
          <span class="tuareg-font-lock-operator">)</span>

        <span class="tuareg-font-lock-governing">let</span> <span class="function-name">status</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">?(</span><span class="variable-name">only_at_eoi</span><span class="tuareg-font-lock-operator">=</span><span class="constant">false</span><span class="tuareg-font-lock-operator">)</span><span class="variable-name"> ev </span><span class="tuareg-font-lock-operator">=</span>
          <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">n </span><span class="tuareg-font-lock-operator">=</span> get_event <span class="tuareg-font-lock-operator">(</span>get_site <span class="tuareg-font-lock-operator">())</span> ev <span class="tuareg-font-lock-governing">in</span>
          <span class="type">E</span>.status n <span class="comment">(* &amp;&amp; (not only_at_eoi || !(sig_cd.cd_eoi)) *)</span>
            <span class="doc">(** TODO: remettre only_at_eoi pour les configs *)</span>

        <span class="tuareg-font-lock-governing">let</span> <span class="function-name">cfg_present</span><span class="variable-name"> ev </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">()</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="function-name">cfg_or</span><span class="variable-name"> c1 c2 </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">()</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="function-name">cfg_and</span><span class="variable-name"> c1 c2 </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">()</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="function-name">cfg_status</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">?(</span><span class="variable-name">only_at_eoi</span><span class="tuareg-font-lock-operator">=</span><span class="constant">false</span><span class="tuareg-font-lock-operator">)</span><span class="variable-name"> evt_cfg </span><span class="tuareg-font-lock-operator">=</span>
          <span class="constant">false</span>

        <span class="comment">(* let cfg_present ((n,sig_cd,wa,wp) as evt) =
          Cevent ((fun eoi -&gt; status ~only_at_eoi:eoi evt), sig_cd, wa, wp)
        let cfg_or ev1 ev2 =
          Cor (ev1, ev2)
        let cfg_and ev1 ev2 =
          Cand (ev1, ev2)

        let cfg_status ?(only_at_eoi=false) evt_cfg =
          let rec status k = match k with
            | Cevent (c, _, _, _) -&gt; c only_at_eoi
            | Cand (cfg1, cfg2) -&gt; status cfg1 &amp;&amp; status cfg2
            | Cor (cfg1, cfg2) -&gt; status cfg1 || status cfg2
          in
          status evt_cfg

        let cfg_events evt_cfg long_wait =
          let rec events k = match k with
            | Cevent (_, cd, wa, wp) -&gt; [(if long_wait then wa else wp), cd]
            | Cand (cfg1, cfg2) | Cor (cfg1, cfg2) -&gt;
              List.rev_append (events cfg1) (events cfg2)
          in
          events evt_cfg
        *)</span>
      <span class="tuareg-font-lock-governing">end</span>


    <span class="doc">(** Sites operations *)</span>

  <span class="comment">(*  let rec exec_cds stop_at_end_step s =
      while true do
        List.iter (exec_cd s) s.s_current;
        s.s_current := [];
        process_msgs s
      done
  *)</span>

    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">is_master</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">()</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span>
      <span class="type">C</span>.is_master <span class="tuareg-font-lock-operator">()</span>

    <span class="comment">(* After receiving Mstep *)</span>
   <span class="tuareg-font-lock-governing">let</span> <span class="function-name">receive_step</span><span class="variable-name"> site msg </span><span class="tuareg-font-lock-operator">=</span>
     <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">pck</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> cd_id </span><span class="tuareg-font-lock-operator">=</span> <span class="type">Msgs</span>.recv_step msg <span class="tuareg-font-lock-governing">in</span>
     <span class="keyword">try</span>
       <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">cd </span><span class="tuareg-font-lock-operator">=</span> <span class="type">C</span>.<span class="type">GidMap</span>.find cd_id site.s_clock_domains <span class="tuareg-font-lock-governing">in</span>
       <span class="comment">(* first do the end of instant*)</span>
       <span class="type">Clock</span>.update_clock site pck<span class="tuareg-font-lock-operator">;</span>
       next_instant site cd<span class="tuareg-font-lock-operator">;</span>
       <span class="comment">(* then do the new step *)</span>
       IFDEF RML_DEBUG THEN
         print_debug <span class="string">"Starting local clock domain %a on request@."</span> <span class="type">C</span>.print_gid cd_id
       ELSE <span class="tuareg-font-lock-operator">()</span> END<span class="tuareg-font-lock-operator">;</span>
       exec_cd site cd <span class="tuareg-font-lock-operator">()</span>
     <span class="keyword">with</span>
       <span class="tuareg-font-lock-operator">|</span> Not_found <span class="tuareg-font-lock-operator">-&gt;</span> print_debug <span class="string">"Error: Received Start for unknown clock domain.@."</span>

   <span class="comment">(* After receiving Meoi *)</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">receive_eoi</span><span class="variable-name"> site msg </span><span class="tuareg-font-lock-operator">=</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">ck_id</span><span class="tuareg-font-lock-operator">:</span><span class="type">C.gid </span><span class="tuareg-font-lock-operator">=</span> <span class="type">C</span>.from_msg msg <span class="tuareg-font-lock-governing">in</span>
      <span class="comment">(* first, emit the value of local slow signals to remotes *)</span>
      wake_up_now site <span class="tuareg-font-lock-operator">(</span>Wbefore_eoi ck_id<span class="tuareg-font-lock-operator">);</span>
      <span class="comment">(* then forward eoi to remotes *)</span>
      <span class="type">Msgs</span>.broadcast_eoi site.s_remotes ck_id<span class="tuareg-font-lock-operator">;</span>
      <span class="comment">(* and do local eoi *)</span>
      wake_up_now site <span class="tuareg-font-lock-operator">(</span>Weoi ck_id<span class="tuareg-font-lock-operator">);</span>
      <span class="comment">(* wake up processes that send has_next msgs *)</span>
      wake_up_now site <span class="tuareg-font-lock-operator">(</span>Wafter_eoi ck_id<span class="tuareg-font-lock-operator">)</span>

    <span class="comment">(* After receiving Mcreate_signal *)</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">receive_create_signal</span><span class="variable-name"> msg </span><span class="tuareg-font-lock-operator">=</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">tmp_id</span><span class="tuareg-font-lock-operator">,</span><span class="variable-name"> f </span><span class="tuareg-font-lock-operator">=</span> <span class="type">Msgs</span>.recv_create_signal msg <span class="tuareg-font-lock-governing">in</span>
      <span class="comment">(* create the signal and send the created value *)</span>
      f <span class="tuareg-font-lock-operator">()</span>

    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">terminate_site</span><span class="variable-name"> site </span><span class="tuareg-font-lock-operator">=</span>
      <span class="type">Callbacks</span>.stop_receiving site.s_msg_queue<span class="tuareg-font-lock-operator">;</span>
      <span class="keyword">if</span> <span class="tuareg-font-lock-operator">not</span> <span class="tuareg-font-lock-operator">(</span><span class="type">C</span>.is_master <span class="tuareg-font-lock-operator">())</span> <span class="keyword">then</span> <span class="tuareg-font-lock-operator">(</span>
        IFDEF RML_DEBUG THEN print_debug <span class="string">"Exiting slave@."</span> ELSE <span class="tuareg-font-lock-operator">()</span> END<span class="tuareg-font-lock-operator">;</span>
        <span class="keyword">exit</span> 0
      <span class="tuareg-font-lock-operator">)</span>

    <span class="comment">(* After receiving Mfinalize *)</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">receive_finalize_site</span><span class="variable-name"> site msg </span><span class="tuareg-font-lock-operator">=</span>
      <span class="comment">(* stop sending messages, but keep receiving from others *)</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">main_site </span><span class="tuareg-font-lock-operator">=</span> <span class="type">Msgs</span>.recv_finalize msg <span class="tuareg-font-lock-governing">in</span>
      <span class="type">Msgs</span>.send_finalize_ack main_site <span class="tuareg-font-lock-operator">();</span>
      <span class="comment">(* wait for all the other sites to be done sending *)</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">_ </span><span class="tuareg-font-lock-operator">=</span> <span class="type">Callbacks</span>.recv_given_msg site.s_msg_queue Mfinalize <span class="tuareg-font-lock-governing">in</span>
      <span class="comment">(* really terminate*)</span>
      terminate_site site

    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">init_site</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">()</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span>
      IFDEF RML_DEBUG THEN print_debug <span class="string">"Init site@."</span> ELSE <span class="tuareg-font-lock-operator">()</span> END<span class="tuareg-font-lock-operator">;</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">s </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">{</span>
        s_top_clock_domain <span class="tuareg-font-lock-operator">=</span> None<span class="tuareg-font-lock-operator">;</span>
        s_clock_domains <span class="tuareg-font-lock-operator">=</span> <span class="type">C</span>.<span class="type">GidMap</span>.empty<span class="tuareg-font-lock-operator">;</span>
        <span class="comment">(*  s_top_clock_domains = clock_domain list; *)</span>
        s_msg_queue <span class="tuareg-font-lock-operator">=</span> <span class="type">Callbacks</span>.mk_queue <span class="tuareg-font-lock-operator">();</span>
        s_callbacks <span class="tuareg-font-lock-operator">=</span> <span class="type">Callbacks</span>.mk_dispatcher <span class="tuareg-font-lock-operator">();</span>
        s_waiting <span class="tuareg-font-lock-operator">=</span> <span class="type">WaitingMap</span>.empty<span class="tuareg-font-lock-operator">;</span>
        s_clock_cache <span class="tuareg-font-lock-operator">=</span> <span class="type">GidHandle</span>.mk_cache <span class="tuareg-font-lock-operator">(</span><span class="keyword">fun</span> <span class="variable-name">ck </span><span class="tuareg-font-lock-operator">-&gt;</span> ck<span class="tuareg-font-lock-operator">);</span>
        s_signal_cache <span class="tuareg-font-lock-operator">=</span> <span class="type">SignalHandle</span>.mk_cache <span class="tuareg-font-lock-operator">{</span> <span class="type">SignalHandle</span>.c_local_value <span class="tuareg-font-lock-operator">=</span> <span class="type">Event</span>.signal_local_value <span class="tuareg-font-lock-operator">};</span>
        s_seed <span class="tuareg-font-lock-operator">=</span> <span class="type">C</span>.mk_seed <span class="tuareg-font-lock-operator">();</span>
        s_comm_site <span class="tuareg-font-lock-operator">=</span> <span class="type">C</span>.local_site <span class="tuareg-font-lock-operator">();</span>
        s_signals_remotes <span class="tuareg-font-lock-operator">=</span> <span class="type">C</span>.<span class="type">GidMap</span>.empty<span class="tuareg-font-lock-operator">;</span>
        s_remotes <span class="tuareg-font-lock-operator">=</span> <span class="type">C</span>.<span class="type">SiteSet</span>.empty<span class="tuareg-font-lock-operator">;</span>
      <span class="tuareg-font-lock-operator">}</span> <span class="tuareg-font-lock-governing">in</span>
      <span class="type">Local_ref</span>.init 0 s<span class="tuareg-font-lock-operator">;</span>
      add_callback s Mnew_cd <span class="tuareg-font-lock-operator">(</span>create_cd s<span class="tuareg-font-lock-operator">);</span>
      add_callback s Mstep <span class="tuareg-font-lock-operator">(</span>receive_step s<span class="tuareg-font-lock-operator">);</span>
      add_callback s Meoi <span class="tuareg-font-lock-operator">(</span>receive_eoi s<span class="tuareg-font-lock-operator">);</span>
      add_callback s Mcreate_signal receive_create_signal<span class="tuareg-font-lock-operator">;</span>
      add_callback s Mfinalize <span class="tuareg-font-lock-operator">(</span>receive_finalize_site s<span class="tuareg-font-lock-operator">);</span>
      <span class="type">Callbacks</span>.start_receiving s.s_msg_queue

    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">start_slave</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">()</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">site </span><span class="tuareg-font-lock-operator">=</span> get_site <span class="tuareg-font-lock-operator">()</span> <span class="tuareg-font-lock-governing">in</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="tuareg-font-lock-governing">rec</span> <span class="function-name">aux</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">()</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">res </span><span class="tuareg-font-lock-operator">=</span> process_msgs site <span class="tuareg-font-lock-operator">()</span> <span class="tuareg-font-lock-governing">in</span>
        <span class="keyword">match</span> res <span class="keyword">with</span>
          <span class="tuareg-font-lock-operator">|</span> None <span class="tuareg-font-lock-operator">-&gt;</span> aux <span class="tuareg-font-lock-operator">()</span>
          <span class="tuareg-font-lock-operator">|</span> Some msg <span class="tuareg-font-lock-operator">-&gt;</span>
              IFDEF RML_DEBUG THEN print_debug <span class="string">"Received Mresult msg@."</span> ELSE <span class="tuareg-font-lock-operator">()</span> END<span class="tuareg-font-lock-operator">;</span>
              Some <span class="tuareg-font-lock-operator">(</span><span class="type">C</span>.from_msg msg<span class="tuareg-font-lock-operator">)</span>
      <span class="tuareg-font-lock-governing">in</span>
      aux <span class="tuareg-font-lock-operator">()</span>

    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">finalize_top_clock_domain</span><span class="variable-name"> cd </span><span class="tuareg-font-lock-operator">=</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">site </span><span class="tuareg-font-lock-operator">=</span> get_site <span class="tuareg-font-lock-operator">()</span> <span class="tuareg-font-lock-governing">in</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">sites </span><span class="tuareg-font-lock-operator">=</span> <span class="type">C</span>.all_sites <span class="tuareg-font-lock-operator">()</span> <span class="tuareg-font-lock-governing">in</span>
      <span class="comment">(* tell all sites to stop sending messages *)</span>
      <span class="keyword">if</span> <span class="tuareg-font-lock-operator">not</span> <span class="tuareg-font-lock-operator">(</span><span class="type">C</span>.<span class="type">SiteSet</span>.is_empty sites<span class="tuareg-font-lock-operator">)</span> <span class="keyword">then</span> <span class="tuareg-font-lock-operator">(</span>
        <span class="type">Msgs</span>.broadcast_finalize sites site.s_comm_site<span class="tuareg-font-lock-operator">;</span>
        <span class="comment">(* wait for all sites to be done *)</span>
        <span class="type">Callbacks</span>.recv_n_given_msg site.s_msg_queue Mfinalize_ack <span class="tuareg-font-lock-operator">(</span><span class="type">C</span>.<span class="type">SiteSet</span>.cardinal sites<span class="tuareg-font-lock-operator">);</span>
        <span class="comment">(* tell all sites to stop executing *)</span>
        <span class="type">Msgs</span>.broadcast_finalize sites site.s_comm_site
      <span class="tuareg-font-lock-operator">)</span> <span class="keyword">else</span>
        <span class="comment">(* Hack: Make sure that the receiving thread is started before terminating *)</span>
        <span class="type">Thread</span>.delay 0.050<span class="tuareg-font-lock-operator">;</span>
      terminate_site site

    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">init</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">()</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span>
      init_site <span class="tuareg-font-lock-operator">();</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">site </span><span class="tuareg-font-lock-operator">=</span> get_site <span class="tuareg-font-lock-operator">()</span> <span class="tuareg-font-lock-governing">in</span>
      <span class="keyword">if</span> <span class="type">C</span>.is_master <span class="tuareg-font-lock-operator">()</span> <span class="keyword">then</span> <span class="tuareg-font-lock-operator">(</span>
          <span class="comment">(* create top clock domain *)</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">ck </span><span class="tuareg-font-lock-operator">=</span> mk_clock None <span class="tuareg-font-lock-governing">in</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">balancer </span><span class="tuareg-font-lock-operator">=</span> <span class="type">L</span>.mk_top_balancer <span class="tuareg-font-lock-operator">()</span> <span class="tuareg-font-lock-governing">in</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">cd </span><span class="tuareg-font-lock-operator">=</span> mk_clock_domain <span class="tuareg-font-lock-operator">(</span>get_site <span class="tuareg-font-lock-operator">())</span> ck balancer None <span class="type">L</span>.Lany None None <span class="tuareg-font-lock-governing">in</span>
        site.s_top_clock_domain <span class="tuareg-font-lock-operator">&lt;-</span> Some cd
      <span class="tuareg-font-lock-operator">)</span> <span class="keyword">else</span> <span class="tuareg-font-lock-operator">(</span>
          <span class="comment">(* just create a fresh id to keep the counters of
             all sites synchronized with the master, so that
             they can receive global signals *)</span>
        <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">_ </span><span class="tuareg-font-lock-operator">=</span> <span class="type">C</span>.fresh site.s_seed <span class="tuareg-font-lock-governing">in</span> <span class="tuareg-font-lock-operator">()</span>
      <span class="tuareg-font-lock-operator">)</span>

    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">get_top_clock_domain</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">()</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">site </span><span class="tuareg-font-lock-operator">=</span> get_site <span class="tuareg-font-lock-operator">()</span> <span class="tuareg-font-lock-governing">in</span>
      <span class="keyword">match</span> site.s_top_clock_domain <span class="keyword">with</span>
        <span class="tuareg-font-lock-operator">|</span> None <span class="tuareg-font-lock-operator">-&gt;</span>
            IFDEF RML_DEBUG THEN print_debug <span class="string">"No top clock domain@."</span> ELSE <span class="tuareg-font-lock-operator">()</span> END<span class="tuareg-font-lock-operator">;</span>
            <span class="keyword">raise</span> <span class="type">Rml_types</span>.RML
        <span class="tuareg-font-lock-operator">|</span> Some cd <span class="tuareg-font-lock-operator">-&gt;</span> cd

<span class="comment">(* ------------------------------------------------------------------------ *)</span>

    <span class="keyword">exception</span> <span class="variable-name">Wait_again</span>

    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">on_current_instant</span><span class="variable-name"> cd f </span><span class="tuareg-font-lock-operator">=</span> <span class="type">D</span>.add_current f cd.cd_current
    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">on_current_instant_list</span><span class="variable-name"> cd fl </span><span class="tuareg-font-lock-operator">=</span> <span class="type">D</span>.add_current_list fl cd.cd_current
    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">on_next_instant</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">?(</span><span class="variable-name">kind</span><span class="tuareg-font-lock-operator">=</span><span class="variable-name">Strong</span><span class="tuareg-font-lock-operator">)</span><span class="variable-name"> ctrl f </span><span class="tuareg-font-lock-operator">=</span>
      <span class="keyword">match</span> kind <span class="keyword">with</span>
        <span class="tuareg-font-lock-operator">|</span> Strong <span class="tuareg-font-lock-operator">-&gt;</span> <span class="type">D</span>.add_next f ctrl.next
        <span class="tuareg-font-lock-operator">|</span> Weak <span class="tuareg-font-lock-operator">-&gt;</span> <span class="type">D</span>.add_next f ctrl.next_control

    <span class="doc">(** [on_eoi cd f] executes 'f ()' during the eoi of cd. *)</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">on_eoi</span><span class="variable-name"> ck f </span><span class="tuareg-font-lock-operator">=</span>
     <span class="comment">(* Format.eprintf "On eoi@."; *)</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">site </span><span class="tuareg-font-lock-operator">=</span> get_site <span class="tuareg-font-lock-operator">()</span> <span class="tuareg-font-lock-governing">in</span>
      <span class="keyword">if</span> <span class="type">C</span>.is_local ck.ck_gid <span class="tuareg-font-lock-operator">&amp;&amp;</span> is_eoi <span class="tuareg-font-lock-operator">(</span>get_clock_domain site ck<span class="tuareg-font-lock-operator">)</span> <span class="keyword">then</span>
        f unit_value
      <span class="keyword">else</span>
        add_waiting site <span class="tuareg-font-lock-operator">(</span>Weoi ck.ck_gid<span class="tuareg-font-lock-operator">)</span> f

  <span class="doc">(** [on_event_or_next evt f_w cd ctrl f_next] executes 'f_w ()' if
      evt is emitted before the end of instant of cd.
      Otherwise, executes 'f_next ()' during the next instant. *)</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">_on_event_or_next</span><span class="variable-name"> site  ev f_w cd ctrl f_next </span><span class="tuareg-font-lock-operator">=</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="function-name">act</span><span class="variable-name"> _ </span><span class="tuareg-font-lock-operator">=</span>
        <span class="keyword">if</span> is_eoi cd <span class="keyword">then</span>
          <span class="comment">(*eoi was reached, launch fallback*)</span>
          <span class="type">D</span>.add_next f_next ctrl.next
        <span class="keyword">else</span>
          <span class="comment">(* signal activated *)</span>
          f_w <span class="tuareg-font-lock-operator">()</span>
      <span class="tuareg-font-lock-governing">in</span>
      add_waiting site <span class="tuareg-font-lock-operator">(</span>Wsignal_wp ev.ev_gid<span class="tuareg-font-lock-operator">)</span> act<span class="tuareg-font-lock-operator">;</span>
      add_weoi_waiting_list cd <span class="tuareg-font-lock-operator">(</span>Wsignal_wp ev.ev_gid<span class="tuareg-font-lock-operator">)</span>

    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">on_event_or_next</span><span class="variable-name"> ev f_w cd ctrl f_next </span><span class="tuareg-font-lock-operator">=</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">site </span><span class="tuareg-font-lock-operator">=</span> get_site <span class="tuareg-font-lock-operator">()</span> <span class="tuareg-font-lock-governing">in</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">n </span><span class="tuareg-font-lock-operator">=</span> get_event site ev <span class="tuareg-font-lock-governing">in</span>
      <span class="keyword">if</span> <span class="type">E</span>.status n <span class="keyword">then</span>
        f_w <span class="tuareg-font-lock-operator">()</span>
      <span class="keyword">else</span>
        _on_event_or_next site ev f_w cd ctrl f_next

    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">on_event_cfg_or_next</span><span class="variable-name"> evt_cfg f_w cd ctrl f_next </span><span class="tuareg-font-lock-operator">=</span>
      <span class="tuareg-font-lock-operator">()</span>

<span class="comment">(*
  (** [on_event_cfg_or_next evt_cfg f_w v_w cd ctrl f_next] executes 'f_w v_w' if
      evt_cfg is true before the end of instant of cd.
      Otherwise, executes 'f_next ()' during the next instant. *)
    let on_event_cfg_or_next evt_cfg f_w v_w cd ctrl f_next =
      if Event.cfg_status evt_cfg then
        f_w v_w
      else
        let is_fired = ref false in
        let try_fire _ =
          if not !is_fired then
            if is_eoi cd then
              (is_fired := true;
               D.add_next f_next ctrl.next)
            else
              (if Event.cfg_status evt_cfg then
                  (is_fired := true;
                   f_w v_w))
        in
        let w_list = Event.cfg_events evt_cfg false in
        List.iter
          (fun (w,_) -&gt; D.add_waiting try_fire w; add_weoi_waiting_list cd w) w_list
*)</span>

    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">has_been_active</span><span class="variable-name"> site ctrl ev </span><span class="tuareg-font-lock-operator">=</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">ev_ck </span><span class="tuareg-font-lock-operator">=</span> get_event_clock site ev <span class="tuareg-font-lock-governing">in</span>
      <span class="type">Clock</span>.check_clock_state site ctrl.last_activation ev_ck

    <span class="doc">(** [on_event evt ctrl f] executes 'f ()' if evt is emitted and
        ctrl is active in the same step.
        It waits for the next activation of w otherwise,
        or if the call raises Wait_again *)</span>
    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">_on_local_event</span><span class="variable-name"> site ev ev_ck ctrl f </span><span class="tuareg-font-lock-operator">=</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">n </span><span class="tuareg-font-lock-operator">=</span> get_event site ev <span class="tuareg-font-lock-governing">in</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">instance </span><span class="tuareg-font-lock-operator">=</span> ctrl.instance <span class="tuareg-font-lock-governing">in</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="tuareg-font-lock-governing">rec</span> <span class="function-name">try_launch</span><span class="variable-name"> _ </span><span class="tuareg-font-lock-operator">=</span>
        <span class="keyword">try</span>
          f <span class="tuareg-font-lock-operator">()</span>
        <span class="keyword">with</span>
          <span class="tuareg-font-lock-operator">|</span> Wait_again <span class="tuareg-font-lock-operator">-&gt;</span>
            on_eoi ev_ck <span class="tuareg-font-lock-operator">(</span><span class="keyword">fun</span> <span class="tuareg-font-lock-operator">()</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">-&gt;</span> add_waiting site <span class="tuareg-font-lock-operator">(</span>Wsignal_wa ev.ev_gid<span class="tuareg-font-lock-operator">)</span> self<span class="tuareg-font-lock-operator">)</span>
      <span class="tuareg-font-lock-governing">and</span> <span class="function-name">self</span><span class="variable-name"> _ </span><span class="tuareg-font-lock-operator">=</span>
        <span class="keyword">if</span> ctrl.instance <span class="tuareg-font-lock-operator">=</span> instance <span class="keyword">then</span> <span class="tuareg-font-lock-operator">(</span>
          <span class="keyword">if</span> has_been_active site ctrl ev <span class="keyword">then</span>
            <span class="comment">(*ctrl is activated, run continuation*)</span>
            try_launch <span class="tuareg-font-lock-operator">()</span>
          <span class="keyword">else</span> <span class="tuareg-font-lock-operator">(</span><span class="comment">(*ctrl is not active, wait end of instant*)</span>
            <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">is_fired </span><span class="tuareg-font-lock-operator">=</span> <span class="tuareg-font-lock-operator">ref</span> <span class="constant">false</span> <span class="tuareg-font-lock-governing">in</span>
            <span class="type">D</span>.add_next <span class="tuareg-font-lock-operator">(</span>ctrl_await is_fired<span class="tuareg-font-lock-operator">)</span> ctrl.next_control<span class="tuareg-font-lock-operator">;</span>
            add_waiting site <span class="tuareg-font-lock-operator">(</span>Weoi ev_ck.ck_gid<span class="tuareg-font-lock-operator">)</span> <span class="tuareg-font-lock-operator">(</span>eoi_await is_fired<span class="tuareg-font-lock-operator">)</span>
          <span class="tuareg-font-lock-operator">)</span>
        <span class="tuareg-font-lock-operator">)</span>
      <span class="tuareg-font-lock-governing">and</span> <span class="function-name">eoi_await</span><span class="variable-name"> is_fired _ </span><span class="tuareg-font-lock-operator">=</span>
        <span class="keyword">if</span> <span class="tuareg-font-lock-operator">not</span> <span class="tuareg-font-lock-operator">!</span>is_fired <span class="keyword">then</span>
          <span class="comment">(*ctrl was not activated, await the signal again *)</span>
          <span class="tuareg-font-lock-operator">(</span>is_fired <span class="tuareg-font-lock-operator">:=</span> <span class="constant">true</span><span class="tuareg-font-lock-operator">;</span>
           add_waiting site <span class="tuareg-font-lock-operator">(</span>Wsignal_wa ev.ev_gid<span class="tuareg-font-lock-operator">)</span> self<span class="tuareg-font-lock-operator">)</span>
      <span class="tuareg-font-lock-governing">and</span> <span class="function-name">ctrl_await</span><span class="variable-name"> is_fired _ </span><span class="tuareg-font-lock-operator">=</span>
        <span class="keyword">if</span> <span class="tuareg-font-lock-operator">not</span> <span class="tuareg-font-lock-operator">!</span>is_fired <span class="keyword">then</span>
          <span class="comment">(* ctrl was activated, signal is present*)</span>
          <span class="tuareg-font-lock-operator">(</span>is_fired <span class="tuareg-font-lock-operator">:=</span> <span class="constant">true</span><span class="tuareg-font-lock-operator">;</span> try_launch <span class="tuareg-font-lock-operator">())</span>
      <span class="tuareg-font-lock-governing">in</span>
      <span class="keyword">if</span> <span class="type">E</span>.status n <span class="keyword">then</span>
        try_launch <span class="tuareg-font-lock-operator">()</span>
      <span class="keyword">else</span>
        add_waiting site <span class="tuareg-font-lock-operator">(</span>Wsignal_wa ev.ev_gid<span class="tuareg-font-lock-operator">)</span> self

    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">_on_remote_event</span><span class="variable-name"> site ev ev_ck ctrl f </span><span class="tuareg-font-lock-operator">=</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">instance </span><span class="tuareg-font-lock-operator">=</span> ctrl.instance <span class="tuareg-font-lock-governing">in</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="tuareg-font-lock-governing">rec</span> <span class="function-name">self</span><span class="variable-name"> _ </span><span class="tuareg-font-lock-operator">=</span>
        <span class="keyword">if</span> ctrl.instance <span class="tuareg-font-lock-operator">=</span> instance <span class="keyword">then</span> <span class="tuareg-font-lock-operator">(</span>
          <span class="keyword">if</span> has_been_active site ctrl ev <span class="keyword">then</span>
            <span class="comment">(*ctrl is activated, run continuation*)</span>
            <span class="tuareg-font-lock-operator">(</span><span class="keyword">try</span>
                f <span class="tuareg-font-lock-operator">()</span>
              <span class="keyword">with</span>
                <span class="tuareg-font-lock-operator">|</span> Wait_again <span class="tuareg-font-lock-operator">-&gt;</span> add_waiting site <span class="tuareg-font-lock-operator">(</span>Wsignal_wa ev.ev_gid<span class="tuareg-font-lock-operator">)</span> self<span class="tuareg-font-lock-operator">)</span>
          <span class="keyword">else</span> <span class="tuareg-font-lock-operator">(</span>
            IFDEF RML_DEBUG THEN
              print_debug <span class="string">"Signal %a was emitted, but ctrl is not active so keep waiting@."</span> print_signal ev
            ELSE <span class="tuareg-font-lock-operator">()</span> END<span class="tuareg-font-lock-operator">;</span>
            add_waiting site <span class="tuareg-font-lock-operator">(</span>Wsignal_wa ev.ev_gid<span class="tuareg-font-lock-operator">)</span> self
          <span class="tuareg-font-lock-operator">)</span>
        <span class="tuareg-font-lock-operator">)</span>
      <span class="tuareg-font-lock-governing">in</span>
        add_waiting site <span class="tuareg-font-lock-operator">(</span>Wsignal_wa ev.ev_gid<span class="tuareg-font-lock-operator">)</span> self

    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">on_event</span><span class="variable-name"> ev ctrl f </span><span class="tuareg-font-lock-operator">=</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">site </span><span class="tuareg-font-lock-operator">=</span> get_site <span class="tuareg-font-lock-operator">()</span> <span class="tuareg-font-lock-governing">in</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">ev_ck </span><span class="tuareg-font-lock-operator">=</span> get_event_clock site ev <span class="tuareg-font-lock-governing">in</span>
      <span class="keyword">if</span> <span class="type">C</span>.is_local ev.ev_gid <span class="keyword">then</span>
        _on_local_event site ev ev_ck ctrl f
      <span class="keyword">else</span>
        _on_remote_event site ev ev_ck ctrl f

    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">on_event_at_eoi</span><span class="variable-name"> evt ctrl f </span><span class="tuareg-font-lock-operator">=</span>
      on_event evt ctrl <span class="tuareg-font-lock-operator">(</span><span class="keyword">fun</span> <span class="tuareg-font-lock-operator">()</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">-&gt;</span> on_eoi <span class="tuareg-font-lock-operator">(</span><span class="type">Event</span>.clock evt<span class="tuareg-font-lock-operator">)</span> f<span class="tuareg-font-lock-operator">)</span>


    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">on_event_cfg</span><span class="variable-name"> evt_cfg ctrl f </span><span class="tuareg-font-lock-operator">=</span>
      <span class="tuareg-font-lock-operator">()</span>

<span class="comment">(*
    (** [on_event_cfg evt_cfg ctrl f v] executes 'f v' if evt_cfg is true and
        ctrl is active in the same step.
        It waits for the next activation of evt_cfg otherwise,
        or if the call raises Wait_again *)
    let on_event_cfg evt_cfg ctrl f v  =
      let wait_event_cfg () =
        let is_fired = ref false in
        let try_fire _ =
          if not !is_fired then
            (if Event.cfg_status evt_cfg then
                (is_fired := true;
                 f v)
             else
                raise Wait_again)
        in
        let w_list = Event.cfg_events evt_cfg true in
        List.iter (fun (w,cd) -&gt; _on_event w cd ctrl try_fire unit_value) w_list
      in
      if Event.cfg_status evt_cfg then
        (try
           f v
         with
           | Wait_again -&gt; wait_event_cfg ())
      else
        wait_event_cfg ()
*)</span>

    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">create_control</span><span class="variable-name"> kind body f_k ctrl cd </span><span class="tuareg-font-lock-operator">=</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">kind </span><span class="tuareg-font-lock-operator">=</span> control_of_runtime_control kind <span class="tuareg-font-lock-governing">in</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">new_ctrl </span><span class="tuareg-font-lock-operator">=</span> new_ctrl kind <span class="tuareg-font-lock-governing">in</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">f </span><span class="tuareg-font-lock-operator">=</span> body <span class="tuareg-font-lock-operator">(</span>end_ctrl new_ctrl f_k<span class="tuareg-font-lock-operator">)</span> new_ctrl <span class="tuareg-font-lock-governing">in</span>
      <span class="keyword">match</span> kind <span class="keyword">with</span>
        <span class="tuareg-font-lock-operator">|</span> When <span class="tuareg-font-lock-operator">-&gt;</span>
            <span class="tuareg-font-lock-operator">(</span><span class="keyword">fun</span> <span class="variable-name">evt other_cond </span><span class="tuareg-font-lock-operator">-&gt;</span>
              <span class="tuareg-font-lock-governing">let</span> <span class="tuareg-font-lock-governing">rec</span> <span class="function-name">when_act</span><span class="variable-name"> _ </span><span class="tuareg-font-lock-operator">=</span>
                wake_up_ctrl new_ctrl cd<span class="tuareg-font-lock-operator">;</span>
                on_next_instant ctrl f_when
              <span class="tuareg-font-lock-governing">and</span> <span class="function-name">f_when</span><span class="variable-name"> _ </span><span class="tuareg-font-lock-operator">=</span>
                on_event evt ctrl when_act
              <span class="tuareg-font-lock-governing">in</span>
              <span class="keyword">fun</span> <span class="tuareg-font-lock-operator">()</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">-&gt;</span>
                start_ctrl cd ctrl new_ctrl<span class="tuareg-font-lock-operator">;</span>
                new_ctrl.susp <span class="tuareg-font-lock-operator">&lt;-</span> <span class="constant">true</span><span class="tuareg-font-lock-operator">;</span>
                on_next_instant new_ctrl f<span class="tuareg-font-lock-operator">;</span>
                f_when <span class="tuareg-font-lock-operator">())</span>
        <span class="tuareg-font-lock-operator">|</span> Kill_handler f_handler <span class="tuareg-font-lock-operator">-&gt;</span>
            <span class="tuareg-font-lock-operator">(</span><span class="keyword">fun</span> <span class="variable-name">evt other_cond </span><span class="tuareg-font-lock-operator">-&gt;</span>
              <span class="tuareg-font-lock-governing">let</span> <span class="tuareg-font-lock-governing">rec</span> <span class="function-name">handler</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">()</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span>
                <span class="keyword">if</span> other_cond <span class="tuareg-font-lock-operator">(</span><span class="type">Event</span>.value evt<span class="tuareg-font-lock-operator">)</span> <span class="keyword">then</span> <span class="tuareg-font-lock-operator">(</span>
                  new_ctrl.cond_v <span class="tuareg-font-lock-operator">&lt;-</span> <span class="constant">true</span><span class="tuareg-font-lock-operator">;</span>
                  <span class="type">D</span>.add_next <span class="tuareg-font-lock-operator">(</span>f_handler <span class="tuareg-font-lock-operator">())</span> ctrl.next<span class="tuareg-font-lock-operator">;</span>
                  set_kill new_ctrl
                <span class="tuareg-font-lock-operator">)</span> <span class="keyword">else</span>
                  <span class="comment">(* wait again *)</span>
                  on_next_instant ctrl f_until
              <span class="tuareg-font-lock-governing">and</span> <span class="function-name">f_until</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">()</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span>
                on_event_at_eoi evt ctrl handler
              <span class="tuareg-font-lock-governing">in</span>
              <span class="keyword">fun</span> <span class="tuareg-font-lock-operator">()</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">-&gt;</span>
                on_event_at_eoi evt ctrl handler<span class="tuareg-font-lock-operator">;</span>
                start_ctrl cd ctrl new_ctrl<span class="tuareg-font-lock-operator">;</span>
                f <span class="tuareg-font-lock-operator">())</span>
        <span class="tuareg-font-lock-operator">|</span> Kill f_k <span class="tuareg-font-lock-operator">-&gt;</span>
            <span class="tuareg-font-lock-operator">(</span><span class="keyword">fun</span> <span class="variable-name">evt other_cond </span><span class="tuareg-font-lock-operator">-&gt;</span>
              <span class="tuareg-font-lock-governing">let</span> <span class="tuareg-font-lock-governing">rec</span> <span class="function-name">handler</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">()</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span>
                <span class="keyword">if</span> other_cond <span class="tuareg-font-lock-operator">(</span><span class="type">Event</span>.value evt<span class="tuareg-font-lock-operator">)</span> <span class="keyword">then</span> <span class="tuareg-font-lock-operator">(</span>
                  new_ctrl.cond_v <span class="tuareg-font-lock-operator">&lt;-</span> <span class="constant">true</span><span class="tuareg-font-lock-operator">;</span>
                  <span class="type">D</span>.add_next f_k ctrl.next<span class="tuareg-font-lock-operator">;</span>
                  set_kill new_ctrl
                <span class="tuareg-font-lock-operator">)</span> <span class="keyword">else</span>
                  on_next_instant ctrl f_until
              <span class="tuareg-font-lock-governing">and</span> <span class="function-name">f_until</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">()</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span>
                on_event_at_eoi evt ctrl handler
              <span class="tuareg-font-lock-governing">in</span>
              <span class="keyword">fun</span> <span class="tuareg-font-lock-operator">()</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">-&gt;</span>
                on_event_at_eoi evt ctrl handler<span class="tuareg-font-lock-operator">;</span>
                start_ctrl cd ctrl new_ctrl<span class="tuareg-font-lock-operator">;</span>
                f <span class="tuareg-font-lock-operator">())</span>
        <span class="tuareg-font-lock-operator">|</span> Susp <span class="tuareg-font-lock-operator">-&gt;</span>
            <span class="tuareg-font-lock-operator">(</span><span class="keyword">fun</span> <span class="variable-name">evt other_cond </span><span class="tuareg-font-lock-operator">-&gt;</span>
              <span class="tuareg-font-lock-governing">let</span> <span class="tuareg-font-lock-governing">rec</span> <span class="function-name">handler</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">()</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span>
                <span class="keyword">if</span> other_cond <span class="tuareg-font-lock-operator">(</span><span class="type">Event</span>.value evt<span class="tuareg-font-lock-operator">)</span> <span class="keyword">then</span>
                  new_ctrl.cond_v <span class="tuareg-font-lock-operator">&lt;-</span> <span class="constant">true</span><span class="tuareg-font-lock-operator">;</span>
                  on_next_instant ctrl f_susp
              <span class="tuareg-font-lock-governing">and</span> <span class="function-name">f_susp</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">()</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">=</span>
                on_event_at_eoi evt ctrl handler
              <span class="tuareg-font-lock-governing">in</span>
              <span class="keyword">fun</span> <span class="tuareg-font-lock-operator">()</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">-&gt;</span>
                on_event_at_eoi evt ctrl handler<span class="tuareg-font-lock-operator">;</span>
                start_ctrl cd ctrl new_ctrl<span class="tuareg-font-lock-operator">;</span>
                f <span class="tuareg-font-lock-operator">())</span>
        <span class="tuareg-font-lock-operator">|</span> Clock_domain _ <span class="tuareg-font-lock-operator">-&gt;</span> <span class="keyword">assert</span> <span class="constant">false</span>

    <span class="tuareg-font-lock-governing">let</span> <span class="function-name">create_control_evt_conf</span><span class="variable-name"> kind body f_k ctrl cd </span><span class="tuareg-font-lock-operator">=</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">kind </span><span class="tuareg-font-lock-operator">=</span> control_of_runtime_control kind <span class="tuareg-font-lock-governing">in</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">new_ctrl </span><span class="tuareg-font-lock-operator">=</span> new_ctrl kind <span class="tuareg-font-lock-governing">in</span>
      <span class="tuareg-font-lock-governing">let</span> <span class="variable-name">f </span><span class="tuareg-font-lock-operator">=</span> body <span class="tuareg-font-lock-operator">(</span>end_ctrl new_ctrl f_k<span class="tuareg-font-lock-operator">)</span> new_ctrl <span class="tuareg-font-lock-governing">in</span>
      <span class="keyword">fun</span> <span class="variable-name">evt_cfg </span><span class="tuareg-font-lock-operator">-&gt;</span>
        <span class="comment">(*new_ctrl.cond &lt;- (fun () -&gt; Event.cfg_status ~only_at_eoi:true evt_cfg);*)</span>
        <span class="keyword">fun</span> <span class="tuareg-font-lock-operator">()</span><span class="variable-name"> </span><span class="tuareg-font-lock-operator">-&gt;</span>
          start_ctrl cd ctrl new_ctrl<span class="tuareg-font-lock-operator">;</span>
          f <span class="tuareg-font-lock-operator">()</span>


<span class="tuareg-font-lock-governing">end</span>

<span class="tuareg-font-lock-governing">module</span> <span class="type">MpiRuntime </span><span class="tuareg-font-lock-operator">=</span>
  Make
    <span class="tuareg-font-lock-operator">(</span><span class="type">Mpi_communication</span>.Make<span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-operator">(</span><span class="type">Callbacks</span>.Make<span class="tuareg-font-lock-operator">)</span>

<span class="tuareg-font-lock-governing">module</span> <span class="type">MpiCRuntime </span><span class="tuareg-font-lock-operator">=</span>
  Make
    <span class="tuareg-font-lock-operator">(</span><span class="type">Mpi_communication</span>.Make<span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-operator">(</span><span class="type">Callbacks</span>.MakeC<span class="tuareg-font-lock-operator">)</span>

<span class="tuareg-font-lock-governing">module</span> <span class="type">MpiBufferedRuntime </span><span class="tuareg-font-lock-operator">=</span>
  Make
    <span class="tuareg-font-lock-operator">(</span><span class="type">Mpi_buffer_communication</span>.Make<span class="tuareg-font-lock-operator">)</span>
    <span class="tuareg-font-lock-operator">(</span><span class="type">Callbacks</span>.Make<span class="tuareg-font-lock-operator">)</span>

</pre>
  </body>
</html>
