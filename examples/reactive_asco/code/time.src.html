    <pre>
<span class="comment-delimiter">(***************************************************************)</span>
<span class="comment-delimiter">(*                        </span><span class="comment">Reactive Asco                        </span><span class="comment-delimiter">*)</span>
<span class="comment-delimiter">(*                                                             *)</span>
<span class="comment-delimiter">(*                                                             *)</span>
<span class="comment-delimiter">(* </span><span class="comment">Implement the wait process (relative to the tempo)          </span><span class="comment-delimiter">*)</span>
<span class="comment-delimiter">(* </span><span class="comment">This is an optimized version using a priority queue.        </span><span class="comment-delimiter">*)</span>
<span class="comment-delimiter">(***************************************************************)</span>

<span class="variable-name">open</span> <span class="function-name">Types</span>
<span class="variable-name">open</span> <span class="function-name">Utils</span>

<span class="comment-delimiter">(* </span><span class="comment">Generate a regular real-time signal clock of frequence freq. </span><span class="comment-delimiter">*)</span>
<span class="type">let</span> <span class="type">process</span> emit_clock clock freq  =
  <span class="type">let</span> period = 1. /. freq <span class="type">in</span>
  <span class="type">let</span> next = ref (<span class="function-name">Unix</span>.gettimeofday () +. period) <span class="type">in</span>
  <span class="keyword">loop</span>
    <span class="type">let</span> current = <span class="function-name">Unix</span>.gettimeofday () <span class="type">in</span>
    <span class="constant">if</span> (current &gt;= !next)
    <span class="constant">then</span>
      <span class="keyword">begin</span>
        <span class="builtin">emit</span> clock ();
        next := !next +. period
      <span class="keyword">end</span>;
    <span class="builtin">pause</span>
  <span class="keyword">end</span>


<span class="comment-delimiter">(* </span><span class="comment">Compute the delay, relative to the tempo, elapsed since the
   beginning of its execution.
</span><span class="comment-delimiter">*)</span>
<span class="type">let</span> <span class="type">process</span> elapsed listen clock freq date =
  <span class="type">let</span> period = 1. /. freq <span class="type">in</span>
  <span class="type">let</span> m = ref 0.0 <span class="type">in</span>
  <span class="type">let</span> c = ref 0.0 <span class="type">in</span>
  <span class="builtin">emit</span> date 0.0;
  <span class="constant">do</span>
    <span class="comment-delimiter">(* </span><span class="comment">use Kahan summation </span><span class="comment-delimiter">*)</span>
    <span class="keyword">loop</span>
      <span class="type">let</span> ev = last_one listen <span class="type">in</span>
      <span class="type">let</span> y = ev.bps -. !c <span class="type">in</span>
      <span class="type">let</span> t = !m +. y <span class="type">in</span>
      c := (t -. !m) -. y;
      m := t;
      <span class="builtin">emit</span> date (!m *. period);
      <span class="builtin">pause</span>
    <span class="keyword">end</span>
  <span class="constant">when</span> clock <span class="constant">done</span>


<span class="comment-delimiter">(* </span><span class="comment">Wait a delay 'dur' relatively to the tempo. The waiting process is
   realized by the scheduler. Thereofore to achieve the desired
   behavior we just need to register on the scheduler queue with the
   'queue' signal. 'date' is the current value of 'elapsed'.
</span><span class="comment-delimiter">*)</span>
<span class="type">let</span> <span class="type">process</span> wait date adding dur =
  <span class="type">signal</span> s <span class="type">in</span>
  <span class="type">await</span> <span class="type">immediate</span> <span class="type">one</span> date(e) <span class="type">in</span>
  <span class="builtin">emit</span> adding (dur +. e, s);
  <span class="type">await</span> <span class="type">immediate</span> s


<span class="comment-delimiter">(* </span><span class="comment">Run the processes tick and elapsed and return date </span><span class="comment-delimiter">*)</span>
<span class="type">let</span> <span class="type">process</span> metronome listen freq date =
  <span class="type">signal</span> clock <span class="type">in</span>
  <span class="builtin">run</span> (emit_clock clock freq) <span class="constant">||</span>
  <span class="builtin">run</span> (elapsed listen clock freq date)


<span class="comment-delimiter">(* </span><span class="comment">Create a pair of processes '(scheduler, wait)'. The 'wait' process
   suspends the execution for a duration 'dur' relative to the tempo
   given by the signal 'date'. The 'scheduler' process manages the
   waitings.
</span><span class="comment-delimiter">*)</span>
<span class="type">let</span> make_action_scheduler date =
  <span class="type">signal</span> adding <span class="type">in</span>
  <span class="type">let</span> sending d sl = <span class="function-name">List</span>.iter (<span class="type">fun</span> (_, s) <span class="constant">-&gt;</span> <span class="builtin">emit</span> s) sl <span class="type">in</span>
  <span class="type">let</span> wait = wait date adding <span class="type">in</span>
  <span class="type">signal</span> deadline <span class="type">in</span>
  <span class="type">let</span> <span class="type">rec</span> <span class="type">process</span> deadline_generator pre_d =
    <span class="type">await</span> <span class="type">immediate</span> <span class="type">one</span> date (d) <span class="type">in</span>
    <span class="builtin">emit</span> deadline (d +. (d -. pre_d) /. 2.);
    <span class="builtin">pause</span>;
    <span class="builtin">run</span> (deadline_generator d)
  <span class="type">in</span>
  <span class="type">let</span> <span class="type">process</span> action_scheduler =
    <span class="builtin">run</span> (<span class="function-name">Reactive_queue</span>.scheduler deadline sending adding)
    <span class="constant">||</span>
    <span class="builtin">run</span> (deadline_generator 0.0)
  <span class="type">in</span>
  action_scheduler, wait
</pre>
